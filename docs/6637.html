<html>
<head>
<title>Ciphershastra — Gambler Puzzle</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">赌徒谜题</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/ciphershastra-gambler-puzzle-fef84a519796?source=collection_archive---------32-----------------------#2022-11-22">https://medium.com/coinmonks/ciphershastra-gambler-puzzle-fef84a519796?source=collection_archive---------32-----------------------#2022-11-22</a></blockquote><div><div class="eg hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fn fp hv hw ff fg paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="ff fg hs"><img src="../Images/972f1067349a9a370df8758d216aed65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ssOIuu8MrnZa6Jy8ISq29g.png"/></div></div><figcaption class="id ie fh ff fg if ig bd b be z el">Ciphershastra</figcaption></figure><div class=""/><figure class="fj fl jh ji jj hw ff fg paragraph-image"><div class="ff fg jg"><img src="../Images/5e1ed1510feafb24494e348e10f61637.png" data-original-src="https://miro.medium.com/v2/resize:fit:512/format:webp/1*clgJ3G5GuUKiWAeA22fmzA.png"/></div></figure><p id="0282" class="pw-post-body-paragraph jk jl ij jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hn dt translated">你可以在这里找到挑战:<a class="ae ki" href="https://ciphershastra.com/Gambler.html" rel="noopener ugc nofollow" target="_blank">https://ciphershastra.com/Gambler.html</a></p><p id="3f3f" class="pw-post-body-paragraph jk jl ij jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hn dt translated">赌徒真的很难对付。从表面上看，这是一个简单的合同，允许你购买一些筹码，然后在赌博游戏中使用这些筹码。</p><h1 id="cfd3" class="kj kk ij bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">事实</h1><p id="b1a2" class="pw-post-body-paragraph jk jl ij jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh hn dt translated">关于该合同的一些有趣的事实是:</p><ul class=""><li id="ed7b" class="lm ln ij jm b jn jo jr js jv lo jz lp kd lq kh lr ls lt lu dt translated">Ciphershastra网站上仅显示主合同代码。其余的代码可以在Etherscan中找到，因为合同已经过验证。</li><li id="1b98" class="lm ln ij jm b jn lv jr lw jv lx jz ly kd lz kh lr ls lt lu dt translated">它使用0.7编译器版本。从0.7版到0.8版有许多变化，但最突出的变化之一是引入了内置的安全数学运算。然而，契约似乎在使用SafeMath库，所以它仍然可以防止可能的上溢/下溢。</li><li id="3b3e" class="lm ln ij jm b jn lv jr lw jv lx jz ly kd lz kh lr ls lt lu dt translated">在用这些筹码赌博之前，用户最多可以购买20个筹码</li><li id="a1a2" class="lm ln ij jm b jn lv jr lw jv lx jz ly kd lz kh lr ls lt lu dt translated">在赌博之前，用户必须通过支付所请求的筹码来获得验证。特别是，用户必须为每个芯片支付576460752303423488魏。这绝对是一个奇怪的数字。如果我们把它转换成十六进制，看看它是什么样子呢？我们得到0x0800000000000000。这是一个64位的数字，如果乘以32就会溢出</li><li id="9b19" class="lm ln ij jm b jn lv jr lw jv lx jz ly kd lz kh lr ls lt lu dt translated">只有当呼叫者是另一个合同时，<code class="ei ma mb mc md b">buyChips</code>中的<code class="ei ma mb mc md b">_safeMint</code>才会通过<code class="ei ma mb mc md b">onERC721Received</code>回叫呼叫者。这个回调来自于<code class="ei ma mb mc md b">ERC721Receiver</code>接口，它用于确保调用方契约能够接收和处理ERC721令牌</li><li id="9297" class="lm ln ij jm b jn lv jr lw jv lx jz ly kd lz kh lr ls lt lu dt translated"><code class="ei ma mb mc md b">doubleOrNothing</code>函数调用<code class="ei ma mb mc md b">libGambler</code>库来计算掷骰子的结果。如果我们在Etherscan中查找这个库的源代码，我们可以看到它使用一些数据源，如块时间戳、coinbase和难度，来计算掷骰子。通过使用另一个合同并在那里运行相同的计算来得出要使用的赌注，可以很容易地预测所有这些数据</li><li id="f775" class="lm ln ij jm b jn lv jr lw jv lx jz ly kd lz kh lr ls lt lu dt translated">如果骰子滚动预测正确，那么将以NFTs形式获得奖励的帐户将以非常特殊的方式进行计算，如果我们仔细观察，我们可以看到<code class="ei ma mb mc md b">acount</code>参数中的一个错别字，它可能会与<code class="ei ma mb mc md b">account</code>存储变量混淆。</li></ul><h1 id="fab1" class="kj kk ij bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">盲点</h1><p id="c531" class="pw-post-body-paragraph jk jl ij jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh hn dt translated">在查看了所有事实之后，首先想到的是可能存在可重入攻击。这可以通过调用<code class="ei ma mb mc md b">_safeMint</code>的<code class="ei ma mb mc md b">onERC721Received</code>回调来实现。这肯定会让我们买更多的芯片。我们可以打电话给<code class="ei ma mb mc md b">buyChips(16)</code>，然后在<code class="ei ma mb mc md b">onERC721Received</code>回调时，我们可以再次打电话给<code class="ei ma mb mc md b">buyChips(16)</code>，从而总共购买32个筹码。但是，这仍然不起作用，因为<code class="ei ma mb mc md b">getVerified</code>函数会计算出要支付的总金额为576460752303423488 * 32，由于使用了<code class="ei ma mb mc md b">SafeMath</code>，这将溢出并还原交易</p><p id="1f89" class="pw-post-body-paragraph jk jl ij jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hn dt translated">一遍又一遍地检查Etherscan中的代码并没有对可能的攻击提供任何线索，直到我被暗示Etherscan可能在骗我。撒谎？怎么会？</p><h1 id="2447" class="kj kk ij bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">真理的来源</h1><p id="02f1" class="pw-post-body-paragraph jk jl ij jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh hn dt translated">当您在Etherscan中验证一个合同时，您会发送与合同编译相关的所有文件。但是，在使用库时，您也可以链接一个已经部署的库，以便在协定中使用。这个独立的库必须至少有一个外部/公共函数，这样它们才能被链接。如果一个库有所有的内部函数，它将被嵌入到使用它们的契约中。</p><p id="7db0" class="pw-post-body-paragraph jk jl ij jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hn dt translated">这个链接库可以在Etherscan代码选项卡底部的<code class="ei ma mb mc md b">Libraries Used</code>部分看到。有什么条件？Etherscan的code选项卡中显示的源代码是合同编译时可用的代码。然而，为库实际部署的代码可能会有所不同。通过将<code class="ei ma mb mc md b">Gambler</code>契约代码页中的<code class="ei ma mb mc md b">libGambler</code>源代码与契约中链接的<code class="ei ma mb mc md b">libGambler</code>库的验证源代码(可在地址<code class="ei ma mb mc md b">0x8674141e5af6B97D0be342C1DD157D0B8bb7ef57</code>获得)进行比较，我们可以看到。</p><p id="9df9" class="pw-post-body-paragraph jk jl ij jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hn dt translated">我们可以看到，代码是不同的，骰子滚动的计算方式在结尾有一个额外的可疑参数。</p><p id="152a" class="pw-post-body-paragraph jk jl ij jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hn dt translated">好，这是一个可能会打乱我们赌注计算的差异。但是我们引起溢出的惊人想法呢？</p><p id="51b9" class="pw-post-body-paragraph jk jl ij jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hn dt translated">如果我们在地址<code class="ei ma mb mc md b">0x8a5ba2bca9801BEac0A679f1D7e72a339b2Ca8c2</code>查看链接的<code class="ei ma mb mc md b">SafeMath</code>库，我们还会看到代码是不同的，事实上，<code class="ei ma mb mc md b">mul</code>函数实际上没有防止溢出。头奖！</p><h1 id="3f7a" class="kj kk ij bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">解决方案合同</h1><p id="529c" class="pw-post-body-paragraph jk jl ij jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh hn dt translated">现在，我们唯一需要做的就是在我们的解决方案契约中实现来自实际链接<code class="ei ma mb mc md b">libGambler</code>的掷骰子，并利用可重入攻击来解决挑战。我们的攻击函数看起来像这样:</p><pre class="me mf mg mh fr mi md mj bn mk ml bi"><span id="43b6" class="mm kk ij md b be mn mo l mp mq"> address account = 0x0000000000000000000000000000000000000000;<br/> uint256 bet = uint256(keccak256(abi.encodePacked(block.timestamp, block.coinbase,<br/> account, “sus”))) % block.difficulty;<br/><br/> gambler.buyChips(16);<br/> gambler.getVerified{ value: 0 }();<br/> gambler.doubleOrNothing(account, bet);</span></pre><p id="b84e" class="pw-post-body-paragraph jk jl ij jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hn dt translated">零地址在这里用于<code class="ei ma mb mc md b">account</code>强制<code class="ei ma mb mc md b">doubleOrNothing</code>中的<code class="ei ma mb mc md b">to</code>变量取<code class="ei ma mb mc md b">msg.sender</code>的值，这是我们的解决方案契约。然后我们需要准备回调函数:</p><p id="4068" class="pw-post-body-paragraph jk jl ij jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hn dt translated"><code class="ei ma mb mc md b">buyAgain</code>变量在合约构造时设置为<code class="ei ma mb mc md b">true</code>，然后一旦回调被调用一次就设置为<code class="ei ma mb mc md b">false</code>，所以我们只买2次16个筹码。</p><pre class="me mf mg mh fr mi md mj bn mk ml bi"><span id="7f2e" class="mm kk ij md b be mn mo l mp mq">function onERC721Received(<br/>    address operator,<br/>    address from,<br/>    uint256 tokenId,<br/>    bytes calldata data<br/>) external returns (bytes4) {<br/>    if (buyAgain) {<br/>        buyAgain = false;<br/>        gambler.buyChips(16);<br/>    }<br/>    return this.onERC721Received.selector;<br/>}</span></pre><h1 id="81e1" class="kj kk ij bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">准备攻击！</h1><p id="ca6a" class="pw-post-body-paragraph jk jl ij jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh hn dt translated">最后，我们可以pwn赌徒契约。我们部署我们的解决方案契约，然后调用<code class="ei ma mb mc md b">pwn</code>函数，该函数将执行以下步骤:</p><ul class=""><li id="b9e3" class="lm ln ij jm b jn jo jr js jv lo jz lp kd lq kh lr ls lt lu dt translated">买16个筹码</li><li id="664c" class="lm ln ij jm b jn lv jr lw jv lx jz ly kd lz kh lr ls lt lu dt translated">接受回调，在合约阻止我们购买更多筹码之前，再购买16个筹码</li><li id="63e9" class="lm ln ij jm b jn lv jr lw jv lx jz ly kd lz kh lr ls lt lu dt translated">通过支付0魏获得验证，因为计算将溢出，但不会触发恢复</li><li id="677c" class="lm ln ij jm b jn lv jr lw jv lx jz ly kd lz kh lr ls lt lu dt translated">双倍或零，计算出的赌注将与赌徒契约中的骰子滚动相匹配</li><li id="99e3" class="lm ln ij jm b jn lv jr lw jv lx jz ly kd lz kh lr ls lt lu dt translated">利润！</li></ul><p id="3dac" class="pw-post-body-paragraph jk jl ij jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hn dt translated">赌徒合同为我们铸造了额外的32个筹码，并标志着我们的合同是一个真正的赌徒！</p><h1 id="892e" class="kj kk ij bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">Github回购</h1><p id="ff4b" class="pw-post-body-paragraph jk jl ij jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh hn dt translated">你可以在我的Github repo:<a class="ae ki" href="https://github.com/robercano/ciphershastra" rel="noopener ugc nofollow" target="_blank">https://github.com/robercano/ciphershastra</a>中找到这个解决方案以及其他的密码破解挑战</p><h1 id="5f3a" class="kj kk ij bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">关于我</h1><p id="617f" class="pw-post-body-paragraph jk jl ij jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh hn dt translated">我叫罗伯特·卡诺，你可以在https://thesolidchain.com找到我</p><blockquote class="mr"><p id="cbfc" class="ms mt ij bd mu mv mw mx my mz na kh el translated">交易新手？尝试<a class="ae ki" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">加密交易机器人</a>或<a class="ae ki" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">复制交易</a></p><p id="debb" class="ms mt ij bd mu mv mw mx my mz na kh el translated">加入Coinmonks <a class="ae ki" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae ki" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>获取每日<a class="ae ki" href="http://coincodecap.com/" rel="noopener ugc nofollow" target="_blank">加密新闻</a></p></blockquote><h2 id="15d6" class="nb kk ij bd kl nc nd ne kp nf ng nh kt jv ni nj kx jz nk nl lb kd nm nn lf no dt translated">另外，阅读</h2><ul class=""><li id="20fb" class="lm ln ij jm b jn lh jr li jv np jz nq kd nr kh lr ls lt lu dt translated"><a class="ae ki" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">复制交易</a> | <a class="ae ki" rel="noopener" href="/coinmonks/crypto-tax-software-ed4b4810e338">加密税务软件</a></li><li id="723e" class="lm ln ij jm b jn lv jr lw jv lx jz ly kd lz kh lr ls lt lu dt translated"><a class="ae ki" href="https://coincodecap.com/grid-trading" rel="noopener ugc nofollow" target="_blank">电网交易</a> | <a class="ae ki" rel="noopener" href="/coinmonks/the-best-cryptocurrency-hardware-wallets-of-2020-e28b1c124069">加密硬件钱包</a></li><li id="874f" class="lm ln ij jm b jn lv jr lw jv lx jz ly kd lz kh lr ls lt lu dt translated"><a class="ae ki" rel="noopener" href="/coinmonks/top-3-telegram-channels-for-crypto-traders-in-2021-8385f4411ff4">密码电报信号</a> | <a class="ae ki" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">密码交易机器人</a></li><li id="f33b" class="lm ln ij jm b jn lv jr lw jv lx jz ly kd lz kh lr ls lt lu dt translated"><a class="ae ki" rel="noopener" href="/coinmonks/crypto-exchange-dd2f9d6f3769">最佳加密交易所</a> | <a class="ae ki" rel="noopener" href="/coinmonks/bitcoin-exchange-in-india-7f1fe79715c9">印度最佳加密交易所</a></li><li id="47a8" class="lm ln ij jm b jn lv jr lw jv lx jz ly kd lz kh lr ls lt lu dt translated"><a class="ae ki" rel="noopener" href="/coinmonks/best-crypto-apis-for-developers-5efe3a597a9f">面向开发人员的最佳加密API</a></li><li id="b359" class="lm ln ij jm b jn lv jr lw jv lx jz ly kd lz kh lr ls lt lu dt translated">最佳<a class="ae ki" rel="noopener" href="/coinmonks/top-5-crypto-lending-platforms-in-2020-that-you-need-to-know-a1b675cec3fa">密码借贷平台</a></li><li id="3c98" class="lm ln ij jm b jn lv jr lw jv lx jz ly kd lz kh lr ls lt lu dt translated"><a class="ae ki" rel="noopener" href="/coinmonks/free-crypto-signals-48b25e61a8da">免费加密信号</a> | <a class="ae ki" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">加密交易机器人</a></li><li id="9487" class="lm ln ij jm b jn lv jr lw jv lx jz ly kd lz kh lr ls lt lu dt translated">杠杆代币的终极指南</li></ul></div></div>    
</body>
</html>