<html>
<head>
<title>Learn Solidity lesson 27. Events.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">学习第27课固体。事件。</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/learn-solidity-lesson-27-events-f47070b55851?source=collection_archive---------4-----------------------#2022-08-20">https://medium.com/coinmonks/learn-solidity-lesson-27-events-f47070b55851?source=collection_archive---------4-----------------------#2022-08-20</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/52bac24b9886e5303e6ec4a17f9aa6a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lFULdIxaCkZVxWRPYSEHZg.jpeg"/></div></div></figure><p id="2422" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">不可能从智能合约中访问外部服务器。因此，EVM不可能直接向外部应用程序通知某个事件的发生。</p><p id="cd5e" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这就是为什么在坚固中有事件。它是在合同中发布的信息，有两个目的:以日志形式记录此类数据，并间接警告区块链事件的发生。这是因为外部应用程序可以监控事件的发出，从而对区块链的状态变化做出反应。</p><p id="91c6" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">开发人员应该清楚，事件的目的是生成信息，供区块链之外的应用程序读取。事件中记录的数据不记录在存储器中，而是记录在交易收据中。它们可以被分散的应用程序访问和监控，但是不能被契约访问，甚至不能被发出事件的契约访问。</p><p id="52ed" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">事件的声明类似于函数和错误，使用<strong class="jd hu">事件</strong>关键字、一个标识符和一系列参数。可以使用关键字<strong class="jd hu"> indexed </strong>来指示某些参数必须被索引。对于以这种方式声明的事件，最多可以索引3个参数。</p><p id="bfb4" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">也可以声明匿名事件，从而使用4个索引参数。在我们更好地理解事件是什么之后，我们很快就会看到这种可能性。</p><p id="274d" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">事件是在函数外部声明的，就像状态变量一样。一个事件的例子发生在ERC-20令牌上。我们很快会看到更多关于这个令牌的内容，但是它定义的事件之一如下。</p><pre class="jz ka kb kc fq kd ke kf kg aw kh dt"><span id="b722" class="ki kj ht ke b fv kk kl l km kn">event Transfer(address indexed _from, address indexed _to, uint256 value)</span></pre><p id="4604" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">索引参数与非索引参数的处理方式不同。除了通过这些参数的值监控事件的发射之外，还可以搜索索引参数。另一方面，非索引参数不能被过滤或监控，并且被记录到区块链ABI编码中。</p><p id="5465" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">事件也可以作为存储区块链信息的一种更廉价的方式。记录一个事件比在存储器中记录一个值需要更少的气体。</p><h1 id="63e3" class="ko kj ht bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">发射事件</h1><p id="7232" class="pw-post-body-paragraph jb jc ht jd b je ll jg jh ji lm jk jl jm ln jo jp jq lo js jt ju lp jw jx jy hm dt translated">一旦声明，事件就可以在函数中发出。它们是使用<strong class="jd hu"> emit </strong>关键字发出的，后跟事件名称及其参数。例如，<code class="eh lq lr ls ke b">Transfer</code>事件的发射如下。假设<code class="eh lq lr ls ke b">_to</code>和<code class="eh lq lr ls ke b">_amount</code>是函数中的两个变量。</p><pre class="jz ka kb kc fq kd ke kf kg aw kh dt"><span id="2c2d" class="ki kj ht ke b fv kk kl l km kn">emit Transfer(msg.sender, _to, _amount);</span></pre><p id="93d6" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">事件改变了区块链的世界状态(尽管它们没有改变存储)，因此需要事务。这意味着包含事件发射的函数不能有<em class="lt">视图</em>或<em class="lt">纯</em>可变性。</p><p id="1ba9" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">事件的发射可以在Remix中看到，在交易收据中，如下图所示。因为Remix拥有契约的ABI，所以它能够反序列化事件并显示其精确信息。对于一般的应用程序来说，这是不正确的。</p><figure class="jz ka kb kc fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff lu"><img src="../Images/31abc8db3c33bfc5e3eee4708ff97736.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eR6UYo-UJg2uXZu2Uw6xng.png"/></div></div><figcaption class="lv lw fg fe ff lx ly bd b be z ek">Remix shows the emission of an event, in the form of a log.</figcaption></figure><p id="f4f2" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">让我们发送同样的事务，但是现在发送到一个真实的区块链。在我的例子中，我将把契约部署到Rinkeby，并发送一个发出事件的事务。</p><p id="ce94" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">您可以使用块资源管理器查看发出的事件。在下图中，我们看到使用网站<a class="ae lz" href="http://rinkeby.etherscan.io/" rel="noopener ugc nofollow" target="_blank">rinkeby.etherscan.io/</a>的事件日志，寻找交易散列并点击<em class="lt">日志</em>标签。</p><figure class="jz ka kb kc fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff ma"><img src="../Images/cda797ec481a0cc5d635b8b9b06d83ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KiC36rBjkwxtTHtWqkJzJQ.png"/></div></div><figcaption class="lv lw fg fe ff lx ly bd b be z ek">You can view the event log in the block explorer.</figcaption></figure><p id="0edc" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在块资源管理器中，我们看到原始信息，而不是像在Remix中那样被反序列化。请注意，没有关于事件名称的明确信息，但是可以通过主题识别事件。事件的标识总是出现在第一个主题中，除非事件是匿名的。</p><p id="c181" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">事件主题是可以过滤和监控的索引参数。我们已经看到，在一个事件中可以声明多达3个索引参数，因为EVM可以存储多达4个主题的信息。由于第一个主题是事件标识符(如果不是匿名的)，在这种情况下，开发人员只能再选择3个主题。</p><p id="d764" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">上述事件的第一个主题如下:</p><pre class="jz ka kb kc fq kd ke kf kg aw kh dt"><span id="c49a" class="ki kj ht ke b fv kk kl l km kn">0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef</span></pre><p id="210b" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">毫不奇怪，上面的值是字符串<code class="eh lq lr ls ke b">Transfer(address,address,uint256)</code>的Keccak-256哈希。由于主题是32字节的值，这次签名是完整的散列，而不仅仅是前4个字节。</p><p id="e61c" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">以下两个主题是:</p><pre class="jz ka kb kc fq kd ke kf kg aw kh dt"><span id="6d4f" class="ki kj ht ke b fv kk kl l km kn">0x0000000000000000000000008303539291922ef29b518b5b93e8ab07f22f2d1d<br/>0x000000000000000000000000c66d07097f4823343bf116463070b3be5e941c4e</span></pre><p id="7285" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这是事件发射中记录的两个地址。虽然地址是20字节长，但是主题<strong class="jd hu">总是</strong>写到32字节。可以将占用超过32个字节的类型声明为索引类型，但是记录为主题的将是它的Keccak-256散列，而不是它的值。</p><p id="2625" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">例如，如果类型为<em class="lt"> string </em>的参数被声明为indexed，则该字符串的散列将被记录为日志，而不是该字符串本身的值。</p><p id="94f4" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">块浏览器中的最后一个字段名为<em class="lt">数据</em>，它存储所有非索引参数的信息，ABI编码。在上面的例子中，只有一个参数，类型为<em class="lt"> uint256 </em>。然后，100的值被编码为32个十六进制字节。</p><pre class="jz ka kb kc fq kd ke kf kg aw kh dt"><span id="69c6" class="ki kj ht ke b fv kk kl l km kn">0000000000000000000000000000000000000000000000000000000000000064</span></pre><h1 id="32f7" class="ko kj ht bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">匿名事件</h1><p id="53ad" class="pw-post-body-paragraph jb jc ht jd b je ll jg jh ji lm jk jl jm ln jo jp jq lo js jt ju lp jw jx jy hm dt translated">事件可以被声明为匿名的。因此，第一个主题不再涉及事件签名，可以自由使用。这样，匿名事件最多可以有4个索引参数。</p><p id="4f74" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">匿名事件是用<strong class="jd hu">匿名</strong>修饰符声明的，该修饰符必须放在参数声明之后。用4个索引参数声明匿名事件的示例如下:</p><pre class="jz ka kb kc fq kd ke kf kg aw kh dt"><span id="ba99" class="ki kj ht ke b fv kk kl l km kn">event NotMe(address indexed _to, address indexed _from, address indexed _spender, string indexed _message) anonymous;</span></pre><p id="d363" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">如果没有插入<em class="lt">匿名</em>修饰符，编译器将抛出一个错误，指出最多允许3个索引参数。</p><p id="b57e" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">开发人员必须理解，事务日志并不保留事件是否匿名的信息。记录的都是作为主题的索引值和作为<em class="lt">数据</em>的非索引值。为了正确解释题目的含义，有必要了解合同代码，或其ABI。</p><h1 id="e29b" class="ko kj ht bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">天然气事件的成本</h1><p id="4169" class="pw-post-body-paragraph jb jc ht jd b je ll jg jh ji lm jk jl jm ln jo jp jq lo js jt ju lp jw jx jy hm dt translated">事件的用途之一是将数据记录到区块链中，这比使用存储的成本低得多。</p><p id="cc7d" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">以太坊的黄皮书列出了每次EVM手术的费用，单位是天然气。从天然气到乙醚的转换是动态的，因为天然气的价格由服务供给和需求决定，并随时间变化(包括全天)。</p><p id="2270" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">目前，将存储中的变量从零变为非零的价格是20，000单位的天然气。作为比较，每个记录的日志花费375单位gas，加上每个索引主题的375单位，加上非索引参数的较低值(每字节8单位)。</p><p id="74da" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">匿名事件除了允许使用4个索引参数之外，还允许记录没有任何索引参数的日志。这是在区块链上记录信息以供外部访问的最便宜的方式。</p><p id="1718" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">感谢阅读！</strong></p><p id="4800" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">欢迎对本文提出意见和建议。</p><p id="c7b2" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">欢迎任何投稿。<a class="ae lz" href="http://www.buymeacoffee.com/jpmorais" rel="noopener ugc nofollow" target="_blank">www.buymeacoffee.com/jpmorais</a>。</p><blockquote class="mb"><p id="0df5" class="mc md ht bd me mf mg mh mi mj mk jy ek translated">交易新手？尝试<a class="ae lz" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">加密交易机器人</a>或<a class="ae lz" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">复制交易</a></p></blockquote></div></div>    
</body>
</html>