<html>
<head>
<title>Production Contract Security — Part 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">生产合同安全——第3部分</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/production-contract-security-part-3-40fa3ac7f78a?source=collection_archive---------10-----------------------#2022-07-26">https://medium.com/coinmonks/production-contract-security-part-3-40fa3ac7f78a?source=collection_archive---------10-----------------------#2022-07-26</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="5c6e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在我们之前的文章中，我们深入研究了多签名钱包的世界以及围绕它们的最佳实践。如果您不熟悉Gnosis multisig，在开始本练习之前，请查看一下<a class="ae jo" href="https://cipherz.medium.com/production-contract-security-part-1-81583b7bde75" rel="noopener">第1部分</a>和<a class="ae jo" href="https://cipherz.medium.com/production-contract-security-part-2-b631a67b6b4e" rel="noopener">第2部分</a>。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/72a22edb8e8c876aaca0c3301788180f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4oLWKfLy9KkwtGZD.jpg"/></div></div></figure><h1 id="5ba2" class="kb kc ht bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated"><strong class="ak">目的</strong></h1><p id="fcd0" class="pw-post-body-paragraph iq ir ht is b it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn hm dt translated">本文的目的是向开发人员展示如何创建现实生活中的智能契约，该契约具有适当的安全控制并由多签名契约拥有。我们将构建一个具有以下属性的智能合约:</p><ul class=""><li id="5428" class="le lf ht is b it iu ix iy jb lg jf lh jj li jn lj lk ll lm dt translated">访问控制</li><li id="8011" class="le lf ht is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm dt translated">归多重签名所有</li></ul></div><div class="ab cl ls lt hb lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="hm hn ho hp hq"><h1 id="de23" class="kb kc ht bd kd ke lz kg kh ki ma kk kl km mb ko kp kq mc ks kt ku md kw kx ky dt translated">入门指南</h1><p id="6ce7" class="pw-post-body-paragraph iq ir ht is b it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn hm dt translated">我们将使用<code class="eh me mf mg mh b">hardhat</code>来生成一个需要<code class="eh me mf mg mh b">node</code>的示例项目。如果你还没有它，你可以在这里安装<a class="ae jo" href="https://nodejs.org/en/download/" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="e4df" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">一旦安装了<code class="eh me mf mg mh b">node</code>，就可以运行下面的代码来生成一个示例<code class="eh me mf mg mh b">hardhat</code>项目</p><pre class="jq jr js jt fq mi mh mj mk aw ml dt"><span id="ff2c" class="mm kc ht mh b fv mn mo l mp mq"># Create a project directory<br/>mkdir upgrademe &amp;&amp; cd upgrademe</span><span id="3c25" class="mm kc ht mh b fv mr mo l mp mq"># Init the project as a node project<br/>npm init</span><span id="17f7" class="mm kc ht mh b fv mr mo l mp mq"># Install hardhat local to the project<br/>npm install --save-dev hardhat</span><span id="6134" class="mm kc ht mh b fv mr mo l mp mq"># Begin new project wizard<br/>npx hardhat</span><span id="47d7" class="mm kc ht mh b fv mr mo l mp mq"># Example Output<br/>✔ What do you want to do? · Create a TypeScript project<br/>✔ Hardhat project root: · /mnt/c/Users/markm/projects/datchat/upgrademe<br/>✔ Do you want to add a .gitignore? (Y/n) · y<br/>✔ Do you want to install this sample project's dependencies with npm (<a class="ae jo" href="http://twitter.com/nomicfoundation/hardhat-toolbox" rel="noopener ugc nofollow" target="_blank">@nomicfoundation/hardhat-toolbox</a>)? (Y/n) · y</span></pre><p id="972c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在您已经配置了一个启动项目，让我们运行一些命令，确保一切正常。</p><pre class="jq jr js jt fq mi mh mj mk aw ml dt"><span id="81b1" class="mm kc ht mh b fv mn mo l mp mq"># Compile the smart contract<br/>npx hardhat compile</span><span id="76dd" class="mm kc ht mh b fv mr mo l mp mq"># Run the unit tests<br/>npx hardhat test</span><span id="77f2" class="mm kc ht mh b fv mr mo l mp mq"># Run the standalone deploy script<br/>npx hardhat run scripts/deploy.ts</span></pre><p id="5474" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">您可能想知道这是在什么区块链上运行的——毕竟，我们没有指定任何目标区块链。Hardhat旋转一个独立的临时节点，在后台执行这些命令。这对我们来说已经足够好了，但是您可以通过<code class="eh me mf mg mh b">--network</code>参数将它发送到一个特定的网络，并在<code class="eh me mf mg mh b">hardhat.config.ts</code>文件中定义一个相应的网络。这超出了本文的范围，但是有很好的证明。</p></div><div class="ab cl ls lt hb lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="hm hn ho hp hq"><h1 id="1f7d" class="kb kc ht bd kd ke lz kg kh ki ma kk kl km mb ko kp kq mc ks kt ku md kw kx ky dt translated">合同</h1><p id="87d7" class="pw-post-body-paragraph iq ir ht is b it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn hm dt translated">我们只是要更新由<code class="eh me mf mg mh b">hardhat</code>创建的示例契约，因为这对我们的示例来说已经足够了。契约是一个简单的令牌锁，契约所有者可以将<code class="eh me mf mg mh b">eth</code>发送给它，并在指定的时间后解锁。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="ms mt l"/></div></figure><p id="1ba6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果我们看一下<code class="eh me mf mg mh b">test/Test.ts</code>，我们应该会看到它的正确用法。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="ms mt l"/></div></figure><p id="6fbf" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这是一个很好的起点，但是我们希望<code class="eh me mf mg mh b">Lock.sol</code>合同的所有者是一个multisig。如果你注意到，契约的<code class="eh me mf mg mh b">deployer</code>被设置为<code class="eh me mf mg mh b">owner</code>，并且没有办法改变它。我们将对这个契约进行一点点更新，以便在将<code class="eh me mf mg mh b">access control</code>设置为特定功能时给我们更多的灵活性，并给我们一种方法来将所有者从<code class="eh me mf mg mh b">deployer</code>更改为<code class="eh me mf mg mh b">multisig</code>。</p></div><div class="ab cl ls lt hb lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="hm hn ho hp hq"><h2 id="69da" class="mm kc ht bd kd mu mv mw kh mx my mz kl jb na nb kp jf nc nd kt jj ne nf kx ng dt translated">访问控制</h2><p id="9c52" class="pw-post-body-paragraph iq ir ht is b it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn hm dt translated">OpenZeppelin最初是一个公共可靠性模式和契约的开源库，是一个非常有价值的工具。我们将使用他们的<code class="eh me mf mg mh b">AccessControl</code>合同来扩展我们的合同，并提供我们需要的功能。</p><pre class="jq jr js jt fq mi mh mj mk aw ml dt"><span id="b5a7" class="mm kc ht mh b fv mn mo l mp mq"># Install the openzeppelin contracts library<br/>npm i @openzeppelin/contracts</span></pre><p id="c3b6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在我们可以添加<code class="eh me mf mg mh b">AccessControl</code>合同<code class="eh me mf mg mh b">Lock.sol</code>作为依赖项，如下所示:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="ms mt l"/></div><figcaption class="ni nj fg fe ff nk nl bd b be z ek">Rudimentary addition of AccessControl</figcaption></figure><p id="899d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">你会注意到合同中有几处增加/删除，所以让我们检查一下。</p><pre class="jq jr js jt fq mi mh mj mk aw ml dt"><span id="c41b" class="mm kc ht mh b fv mn mo l mp mq"># Imported the contract<br/>import "@openzeppelin/contracts/access/AccessControl.sol";</span><span id="addc" class="mm kc ht mh b fv mr mo l mp mq"># removed the `owner` variable as we don't need that anymore</span><span id="948f" class="mm kc ht mh b fv mr mo l mp mq"># set the owner via a helper method of AccessControl - note that DEFAULT_ADMIN_ROLE comes by default, but you can define custom roles as well.<br/>_setupRole(DEFAULT_ADMIN_ROLE, msg.sender);</span><span id="7fd9" class="mm kc ht mh b fv mr mo l mp mq"># Decorated withdraw() method with onlyRole(DEFAULT_ADMIN_ROLE) to set the security access</span></pre><p id="f131" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果您清理并再次运行测试，您将看到与返回的错误消息相关的错误。</p><pre class="jq jr js jt fq mi mh mj mk aw ml dt"><span id="11e7" class="mm kc ht mh b fv mn mo l mp mq"># Clean<br/>npx hardhat clean</span><span id="a455" class="mm kc ht mh b fv mr mo l mp mq"># Test<br/>npx hardhat test</span><span id="a4a5" class="mm kc ht mh b fv mr mo l mp mq">2) Lock<br/>       Withdrawals<br/>         Validations<br/>           Should revert with the right error if called from another account:<br/>     AssertionError: Expected transaction to be reverted with reason 'You aren't the owner', but it reverted with reason 'AccessControl: account 0x70997970c51812dc3a010c7d01b50e0d17dc79c8 is missing role 0x0000000000000000000000000000000000000000000000000000000000000000'</span></pre><p id="fcb7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">将失败的测试替换为:</p><pre class="jq jr js jt fq mi mh mj mk aw ml dt"><span id="14f5" class="mm kc ht mh b fv mn mo l mp mq">it("Should revert with the right error if called from another account", async function () {<br/>        const { lock, unlockTime, otherAccount } = await loadFixture(<br/>          deployOneYearLockFixture<br/>        );</span><span id="09a6" class="mm kc ht mh b fv mr mo l mp mq">// We can increase the time in Hardhat Network<br/>        await time.increaseTo(unlockTime);</span><span id="ccdc" class="mm kc ht mh b fv mr mo l mp mq">// We use lock.connect() to send a transaction from another account<br/>        await expect(lock.connect(otherAccount).withdraw()).to.be.revertedWith(<br/>          "AccessControl: account 0x70997970c51812dc3a010c7d01b50e0d17dc79c8 is missing role 0x0000000000000000000000000000000000000000000000000000000000000000"<br/>      );<br/>});</span></pre><p id="9a4b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">您还必须替换另一个测试，因为<code class="eh me mf mg mh b">owner</code>变量已经不存在了。将<code class="eh me mf mg mh b">Should set correct owner</code>测试替换为:</p><pre class="jq jr js jt fq mi mh mj mk aw ml dt"><span id="3ecf" class="mm kc ht mh b fv mn mo l mp mq">it.only("Should set the right owner", async function () {<br/>      const { lock, owner } = await loadFixture(deployOneYearLockFixture);<br/>      expect(await lock.hasRole(await lock.DEFAULT_ADMIN_ROLE(), owner.address)).to.be.true;<br/>});</span></pre><p id="09d0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在您的测试应该通过了:)我们现在准备创建一个hardhat脚本，将我们的合同所有者从<code class="eh me mf mg mh b">deployer</code>更改为<code class="eh me mf mg mh b">multisig</code>合同。系好安全带…</p></div><div class="ab cl ls lt hb lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="hm hn ho hp hq"><h2 id="5441" class="mm kc ht bd kd mu mv mw kh mx my mz kl jb na nb kp jf nc nd kt jj ne nf kx ng dt translated">重新分配所有权</h2><p id="cac5" class="pw-post-body-paragraph iq ir ht is b it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn hm dt translated">到目前为止，我们一直使用本地hardhat节点来运行我们的部署和测试，只是为了确保一切正常。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="nm mt l"/></div></figure><p id="7db3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在，我们将使用一个testnet来部署我们的契约，并创建一个定制的hardhat脚本来将契约的所有权分配给我们在<a class="ae jo" href="https://cipherz.medium.com/production-contract-security-part-1-81583b7bde75" rel="noopener">第1部分</a>中创建的multisig。</p><p id="70d6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu"> RPC </strong></p><p id="6301" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">为了与testnet交互，您需要为您的应用程序创建一个rpc端点。我建议使用<a class="ae jo" href="https://infura.io/" rel="noopener ugc nofollow" target="_blank"> infura </a>或<a class="ae jo" href="https://www.alchemy.com/" rel="noopener ugc nofollow" target="_blank"> alchemy </a>来创建一个指向<code class="eh me mf mg mh b">ethereum </code>网络和<code class="eh me mf mg mh b">rinkeby </code>测试网的rpc节点。你可以用这个水龙头为你的交易做一些测试。</p><p id="cf21" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu"> Hardhat.config.ts </strong></p><p id="9ee2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">下面是您应该在项目中使用的更新的<code class="eh me mf mg mh b">hardhat.config.ts</code>。我们增加了几样东西</p><ul class=""><li id="27a2" class="le lf ht is b it iu ix iy jb lg jf lh jj li jn lj lk ll lm dt translated">将合同所有权从部署者转移到multisig的安全帽</li><li id="3986" class="le lf ht is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm dt translated">rinkeby的<code class="eh me mf mg mh b">network</code>定义。</li><li id="1956" class="le lf ht is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm dt translated">部署者帐户的私钥——您用于<code class="eh me mf mg mh b">rinkeby</code> testnet的那个。</li></ul><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="ms mt l"/></div></figure><h2 id="8eaf" class="mm kc ht bd kd mu mv mw kh mx my mz kl jb na nb kp jf nc nd kt jj ne nf kx ng dt translated">。包封/包围（动词envelop的简写）</h2><p id="1abc" class="pw-post-body-paragraph iq ir ht is b it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn hm dt translated">因为这是一篇关于安全性的文章，所以最好向您展示如何在代码中隐藏秘密，而不是直接将它们放入配置文件中。你会惊讶地发现有多少开发者不知不觉地将他们的秘密提交给了公共存储库…</p><pre class="jq jr js jt fq mi mh mj mk aw ml dt"><span id="3931" class="mm kc ht mh b fv mn mo l mp mq"># Install dotenv package<br/>npm i --save-dev dotenv</span><span id="a174" class="mm kc ht mh b fv mr mo l mp mq"># Install hardhat ethers<br/>npm i --save-dev @nomiclabs/hardhat-ethers 'ethers@^5.0.0'</span><span id="3b82" class="mm kc ht mh b fv mr mo l mp mq"># Install chai to test assertions<br/>npm i --save-dev chai</span></pre><p id="8f68" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">用以下值在项目的根目录下创建一个<code class="eh me mf mg mh b">.env</code>文件</p><pre class="jq jr js jt fq mi mh mj mk aw ml dt"><span id="3774" class="mm kc ht mh b fv mn mo l mp mq">RPC_URL=https://https://eth-rinkeby.alchemyapi.io/v2/&lt;your api key&gt;</span><span id="f581" class="mm kc ht mh b fv mr mo l mp mq">DEPLOYER_PRIVATE_KEY=&lt;your private key&gt;</span></pre><p id="5091" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">请注意，在我们的<code class="eh me mf mg mh b">.gitignore</code>文件中，我们排除了所有名为<code class="eh me mf mg mh b">.env</code>的文件，因此这将永远不会提交给我们的回购。</p></div><div class="ab cl ls lt hb lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="hm hn ho hp hq"><h2 id="7461" class="mm kc ht bd kd mu mv mw kh mx my mz kl jb na nb kp jf nc nd kt jj ne nf kx ng dt translated">我们要去林克比</h2><p id="8dfd" class="pw-post-body-paragraph iq ir ht is b it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn hm dt translated">现在我们已经配置好了一切，让我们继续将我们的合同部署到<code class="eh me mf mg mh b">rinkeby</code> testnet。我们实际上要修改一下我们的<code class="eh me mf mg mh b">deploy.ts</code>脚本，把以太的锁定量从1减少到0.01。Testnet eth很难获得，所以我们不要锁定整个eth。此外，我们将把锁定时间减少到5分钟，这样我们就可以看到真正成功的<code class="eh me mf mg mh b">withdrawal</code>，而不是等待一年。</p><p id="132c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">将<code class="eh me mf mg mh b">scripts/deploy.ts</code>中的第5行改为</p><pre class="jq jr js jt fq mi mh mj mk aw ml dt"><span id="574e" class="mm kc ht mh b fv mn mo l mp mq">const ONE_YEAR_IN_SECS = 5 * 60; // 5 minutes</span></pre><p id="e276" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">将<code class="eh me mf mg mh b">scripts/deploy.ts</code>中的第8行改为</p><pre class="jq jr js jt fq mi mh mj mk aw ml dt"><span id="8b0f" class="mm kc ht mh b fv mn mo l mp mq">const lockedAmount = ethers.utils.parseEther(".01");</span></pre><p id="2da5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">展开</strong></p><p id="2ce2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们继续使用下面的命令部署合同</p><pre class="jq jr js jt fq mi mh mj mk aw ml dt"><span id="0801" class="mm kc ht mh b fv mn mo l mp mq"># Deploy to Rinkeby<br/>npx hardhat run scripts/deploy.ts --network rinkeby</span></pre><p id="6ead" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">脚本应该返回已部署的契约地址，如下所示</p><pre class="jq jr js jt fq mi mh mj mk aw ml dt"><span id="092f" class="mm kc ht mh b fv mn mo l mp mq">Lock with .01 ETH deployed to: 0x73f701a4a56AA14513a2A108624b4D00f90D27b2</span></pre><p id="503a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">多信号</strong></p><p id="a220" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在，让我们来看看在本系列的第2部分中我们用Gnosis为Rinkeby部署的multisig契约。在下一步中，我们将使用这个地址和部署的契约地址。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff nn"><img src="../Images/e71a39049b4ff40cf04099e6dc889b4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OZR--9zYgNn2d2JQCAsBWw.png"/></div></div></figure><p id="54be" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">将合同所有权转让给Multisig </strong></p><p id="ba12" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">接下来，我们将运行我们创建的定制任务，将契约的所有权从部署者帐户转移到rinkeby上的multisig</p><pre class="jq jr js jt fq mi mh mj mk aw ml dt"><span id="abf3" class="mm kc ht mh b fv mn mo l mp mq">npx hardhat xfer-contract-multisig --multisig 0x8cB6021aB0eCBE65988dA55D0e55d6B4c601fA36 --contract 0x73f701a4a56AA14513a2A108624b4D00f90D27b2 --network rinkeby</span></pre><p id="1b24" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">您应该会看到类似下面的输出</p><pre class="jq jr js jt fq mi mh mj mk aw ml dt"><span id="770a" class="mm kc ht mh b fv mn mo l mp mq">Grant DEFAULT_ADMIN_ROLE to multisig: 0x8cB6021aB0eCBE65988dA55D0e55d6B4c601fA36<br/>Revoke DEFAULT_ADMIN_ROLE from deployer: 0xec2FFc240CbDE001643a045e2C1Ad928D9eB8aee<br/>Transferred ownership to: 0x8cB6021aB0eCBE65988dA55D0e55d6B4c601fA36</span></pre><p id="76a1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在，我们的合同已经完成部署，所有权也已转移到我们的multisig，让我们继续设置我们的<em class="nh"> OpenZeppelin Defender </em>应用程序，以便为我们的<em class="nh"> Gnosis </em> multisig签名。</p></div><div class="ab cl ls lt hb lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="hm hn ho hp hq"><h2 id="16db" class="mm kc ht bd kd mu mv mw kh mx my mz kl jb na nb kp jf nc nd kt jj ne nf kx ng dt translated">OpenZeppelin防御者</h2><p id="25f6" class="pw-post-body-paragraph iq ir ht is b it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn hm dt translated">让我们在https://defender.openzeppelin.com/的<a class="ae jo" href="https://defender.openzeppelin.com/" rel="noopener ugc nofollow" target="_blank">创建一个帐户，用于管理我们已部署合同的操作。Defender是一个很有用的工具，可用于编排我们已部署合同的提案和签名，它可以做很多事情，但我们主要是用它来管理我们的multisig行动。</a></p><p id="6274" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">添加Gnosis Multisig </strong></p><p id="d639" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">一旦你创建了你的OpenZeppelin账户，点击右上角的<code class="eh me mf mg mh b">Add Contract </code>按钮添加我们的multisig合同。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff no"><img src="../Images/8138725b4364d1dfcd0a4cb45106f53b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ie8cUxajzQDsiJyuFYzCIA.png"/></div></div></figure><p id="822a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">输入可以从Gnosis应用程序获得的名称、网络和合同地址。这将把合同导入到OpenZeppelin Defender中，以便我们可以使用它进行签名。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff np"><img src="../Images/c1327c4e7e2fb4d2f4112e1eaf471a66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MHEnO9dGmRUZjCyRQlRtow.png"/></div></div></figure><p id="fea3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">滚动到底部并点击<code class="eh me mf mg mh b">Add</code>，我们就都好了。您现在应该看到Defender将我们的合同识别为multisig，它显示如下。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff nq"><img src="../Images/6f04ee91d4e9a214e2536dfcc48dcc55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BRNVHnx-ZUr4zfj2J2-YqA.png"/></div></div></figure><p id="26af" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">添加锁定合同</strong></p><p id="36ea" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">再次点击<code class="eh me mf mg mh b">Add Contract</code>，添加我们部署到Rinkeby的<code class="eh me mf mg mh b">Lock</code>契约。同样的做法—只需给它一个名称、网络和地址。然而，由于该合同未在Rinkeby上验证，我们需要粘贴<code class="eh me mf mg mh b">abi</code>以添加该合同。你可以在<code class="eh me mf mg mh b">artifacts/contracts/Lock.sol/Lock.json</code>文件中找到<code class="eh me mf mg mh b">abi</code>。找到<code class="eh me mf mg mh b">abi</code>属性并将整个值复制/粘贴到Defender abi部分。您应该可以点击<code class="eh me mf mg mh b">Add</code>来完成添加您的合同。现在，您应该可以在仪表板中看到这两个合同，如下所示。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff nr"><img src="../Images/b1694303f55ae85b8dce6ab5725bf5c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uVs5bXnk_7rVEc5S1LdV6w.png"/></div></div></figure><p id="938a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们现在处于一个非常好的状态，一切都配置好了，现在我们可以在我们的合同上创建一个提案，并通过multisig的多个签署人来执行它。</p></div><div class="ab cl ls lt hb lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="hm hn ho hp hq"><h2 id="ff8e" class="mm kc ht bd kd mu mv mw kh mx my mz kl jb na nb kp jf nc nd kt jj ne nf kx ng dt translated">把所有的放在一起</h2><p id="2d78" class="pw-post-body-paragraph iq ir ht is b it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn hm dt translated">在我们最后的努力中，我们将做以下事情</p><ul class=""><li id="7711" class="le lf ht is b it iu ix iy jb lg jf lh jj li jn lj lk ll lm dt translated">为我们的<code class="eh me mf mg mh b">Lock</code>合同创建提案</li><li id="becf" class="le lf ht is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm dt translated">用多个授权账户签署提议的交易</li><li id="5e10" class="le lf ht is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm dt translated">参见multisig执行提案</li></ul><h2 id="0cd9" class="mm kc ht bd kd mu mv mw kh mx my mz kl jb na nb kp jf nc nd kt jj ne nf kx ng dt translated">创建建议</h2><p id="3c95" class="pw-post-body-paragraph iq ir ht is b it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn hm dt translated">导航到Defender中的<code class="eh me mf mg mh b">Dashboard =&gt; Contracts =&gt; Lock =&gt; New Proposal =&gt; Admin Action</code>。选择<code class="eh me mf mg mh b">withdraw</code>动作和<code class="eh me mf mg mh b">Multisig</code>的执行策略，选择导入的multisig。输入标题和描述的简介，然后点击<code class="eh me mf mg mh b">Create Admin Action</code>。请注意，任何人都可以创建提案，但是只有有效的签名者可以授权该提案。当您完成填写后，该表单应该类似于下面的表单。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff ns"><img src="../Images/04ddec987fdc2e8725aed743bdfb04c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tC3vnYSeDpaRgrCKw8q4Bg.png"/></div></div></figure><p id="7855" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">签署建议书</strong></p><p id="64db" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">既然我们的提案已经创建，我们可以使用分配给Gnosis multisig的所有者帐户对其进行签名。请访问您的Gnosis multisig，检查哪些签名者获得了授权。它应该看起来像这样。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff nt"><img src="../Images/349b7c078d9cfa8733760b455811b2e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ob3-WkugnUM9Yo5Gj0LJfQ.png"/></div></div></figure><p id="9f87" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">使用Metamask登录到此处列出的帐户之一，并再次导航到Defender中的提案页面。您现在应该会看到一个可选择的<code class="eh me mf mg mh b">Approval</code>按钮。如下所示，单击按钮批准该提议，并使用元掩码签名。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff nu"><img src="../Images/18f557c09070fd9204e460dd7c13a722.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qrvVqjqF9ssUhIWcc47EUQ.png"/></div></div></figure><p id="1b60" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">Defender随后会告诉您，您只有一个批准，还有多少个，如下所示。在这种情况下，我们还有一个批准要做。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff nv"><img src="../Images/10edc45266d5a44f9108297aefb7ed91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yflKDuUT1UkpL5l0iXxVKA.png"/></div></div></figure><p id="4a82" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">此时，您可以连接另一个元掩码帐户和<code class="eh me mf mg mh b">Approve and Execute</code>或仅仅是<code class="eh me mf mg mh b">Approve</code>。如果你只是批准了这个提议，其中一个签名者仍然必须执行它。有时，如果这是一笔耗油量很大的交易，其中一个较富裕的所有者将需要执行它。一旦所有批准人签署了交易并执行后，交易将被发送到区块链进行验证。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff nw"><img src="../Images/56e0426110096d45c1bb4ea551c80c4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GdUmbCE53OZcURcngKQNHA.png"/></div></div></figure><p id="2fdb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">验证</strong></p><p id="a874" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在，我们的multisig事务已经处理完毕，让我们验证一下一切是否如预期的那样工作。我们应该看到从<code class="eh me mf mg mh b">Lock</code>合同到我们的multisig的. 01 ETH存款，所以让我们通过查看我们的Gnosis multisig来验证这一点。正如您在下面看到的，执行了<code class="eh me mf mg mh b">withdraw</code>函数，如果我们查看etherscan上的事务，我们可以看到. 01 ETH的传输。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff nx"><img src="../Images/819baef54ed876a573df0847e2571d3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8e6yg_mBCIYUkEn_5P0q3Q.png"/></div></div></figure><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff ny"><img src="../Images/d4bd7d180ebd3952860afa7f7f9a1112.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HfgtAzaZ_Rcmer_Niu7Skg.png"/></div></div></figure><p id="1a59" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">成功！祝贺您在multisig管理的合同上执行了第一笔交易。</p></div><div class="ab cl ls lt hb lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="hm hn ho hp hq"><h2 id="4eef" class="mm kc ht bd kd mu mv mw kh mx my mz kl jb na nb kp jf nc nd kt jj ne nf kx ng dt translated">摘要</h2><p id="da21" class="pw-post-body-paragraph iq ir ht is b it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn hm dt translated">在本文中，我们学习了如何</p><ul class=""><li id="51f2" class="le lf ht is b it iu ix iy jb lg jf lh jj li jn lj lk ll lm dt translated">从头开始创建一个安全帽项目</li><li id="6d8e" class="le lf ht is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm dt translated">运行和修改测试</li><li id="0143" class="le lf ht is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm dt translated">延长我们与OpenZeppelin资源(AccessControl)的合同</li><li id="b0dc" class="le lf ht is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm dt translated">对我们的合同做些小的修改</li><li id="6302" class="le lf ht is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm dt translated">在我们的项目中安全地保管本地私钥</li><li id="39ca" class="le lf ht is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm dt translated">为我们的应用程序创建一个RPC端点，以便与区块链交互</li><li id="3704" class="le lf ht is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm dt translated">部署我们的合同</li><li id="2b2d" class="le lf ht is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm dt translated">编写自定义安全帽任务(将所有权转移给multisig)</li><li id="dec8" class="le lf ht is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm dt translated">将合同和multisig导入OpenZeppelin Defender</li><li id="8a39" class="le lf ht is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm dt translated">创建一个建议</li><li id="4780" class="le lf ht is b it ln ix lo jb lp jf lq jj lr jn lj lk ll lm dt translated">签署并执行提案</li></ul><p id="43cf" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">唷，太多了！您正在成为一名更好的具有安全意识的区块链开发人员。感谢您阅读本文，并根据需要随时返回本文和<a class="ae jo" href="https://cipherz.medium.com/production-contract-security-part-1-81583b7bde75" rel="noopener">第1部分</a>或<a class="ae jo" href="https://cipherz.medium.com/production-contract-security-part-2-b631a67b6b4e" rel="noopener">第2部分</a>。</p><blockquote class="nz oa ob"><p id="9433" class="iq ir nh is b it iu iv iw ix iy iz ja oc jc jd je od jg jh ji oe jk jl jm jn hm dt translated"><em class="ht">交易新手？试试</em> <a class="ae jo" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a"> <em class="ht">密码交易机器人</em> </a> <em class="ht">或</em> <a class="ae jo" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c"> <em class="ht">复制交易</em> </a></p></blockquote></div></div>    
</body>
</html>