<html>
<head>
<title>Ethereum Virtual Machine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">以太坊虚拟机</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/ethereum-virtual-machine-ea62cdea954d?source=collection_archive---------2-----------------------#2022-10-09">https://medium.com/coinmonks/ethereum-virtual-machine-ea62cdea954d?source=collection_archive---------2-----------------------#2022-10-09</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="5359" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">solidity开发者实用指南</h2></div><h1 id="8cbe" class="ji jj ht bd jk jl jm jn jo jp jq jr js iz jt ja ju jc jv jd jw jf jx jg jy jz dt translated">什么是EVM？</h1><p id="3fe9" class="pw-post-body-paragraph ka kb ht kc b kd ke iu kf kg kh ix ki kj kk kl km kn ko kp kq kr ks kt ku kv hm dt translated">你可能听说过<strong class="kc hu"> Java虚拟机</strong>，开发者用Java(或其他语言)编写的代码编译成Java字节码，JVM是一个运行时引擎<strong class="kc hu">执行Java字节码</strong>。以太坊虚拟机在高层次上是类似的，开发者用Solidity(或其他语言，如Vyper)编码，并向下编译成EVM字节码，EVM是一个运行时引擎，执行EVM字节码。</p><figure class="kx ky kz la fq lb fe ff paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="fe ff kw"><img src="../Images/d4038eedaff58040e9149e0d85150661.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*neO_53prQ3rGBgBu.png"/></div></div><figcaption class="li lj fg fe ff lk ll bd b be z ek">credit to ethereum.org on a high level of EVM</figcaption></figure><p id="cf23" class="pw-post-body-paragraph ka kb ht kc b kd lm iu kf kg ln ix ki kj lo kl km kn lp kp kq kr lq kt ku kv hm dt translated"><strong class="kc hu">它是如何工作的？</strong></p><p id="3de3" class="pw-post-body-paragraph ka kb ht kc b kd lm iu kf kg ln ix ki kj lo kl km kn lp kp kq kr lq kt ku kv hm dt translated">EVM是一个基于事务的状态机——如果事务失败，状态不会更新，除了发送者支付汽油的nonce和eth余额。</p><ol class=""><li id="944b" class="lr ls ht kc b kd lm kg ln kj lt kn lu kr lv kv lw lx ly lz dt translated"><strong class="kc hu"> EVM代码— </strong>开发人员编写智能合同，将其编译成字节码，然后签署并在链上推送交易，以在EVM创建智能合同。</li><li id="01b2" class="lr ls ht kc b kd ma kg mb kj mc kn md kr me kv lw lx ly lz dt translated">当用户或另一个智能合约与智能合约交互时，EVM会将合约字节码(操作码序列)加载到<strong class="kc hu">内存</strong>中。</li><li id="0227" class="lr ls ht kc b kd ma kg mb kj mc kn md kr me kv lw lx ly lz dt translated">然后，EVM将执行操作码序列。当执行正在进行时，<strong class="kc hu">程序计数器</strong>(下一条指令的地址)将增加。<strong class="kc hu">可用气体</strong>将根据操作码减少，如果可用气体不足则终止。任何在存储器中存储数据的操作将在<strong class="kc hu">账户存储器</strong>中持续存在(仅适用于智能合约)。</li></ol><h1 id="7e0f" class="ji jj ht bd jk jl jm jn jo jp jq jr js iz jt ja ju jc jv jd jw jf jx jg jy jz dt translated"><strong class="ak">什么是操作码？</strong></h1><p id="f97f" class="pw-post-body-paragraph ka kb ht kc b kd ke iu kf kg kh ix ki kj kk kl km kn ko kp kq kr ks kt ku kv hm dt translated">总共有141个EVM操作码可以执行如下几类任务(不完全)。完整的清单及其相关的天然气成本可在以下位置找到:<a class="ae mf" href="https://www.evm.codes/" rel="noopener ugc nofollow" target="_blank"> https://www.evm.codes/ </a></p><ol class=""><li id="48ba" class="lr ls ht kc b kd lm kg ln kj lt kn lu kr lv kv lw lx ly lz dt translated">加载并保存到内存/存储器(<code class="eh mg mh mi mj b">mload</code> | <code class="eh mg mh mi mj b">mstore</code> | <code class="eh mg mh mi mj b">sload</code> | 【T3)</li><li id="389f" class="lr ls ht kc b kd ma kg mb kj mc kn md kr me kv lw lx ly lz dt translated">工艺流程(<code class="eh mg mh mi mj b">jump</code></li><li id="d2df" class="lr ls ht kc b kd ma kg mb kj mc kn md kr me kv lw lx ly lz dt translated">算术(<code class="eh mg mh mi mj b">add</code> | <code class="eh mg mh mi mj b">mul</code> | <code class="eh mg mh mi mj b">sub</code> | <code class="eh mg mh mi mj b">div</code>等)</li><li id="94b0" class="lr ls ht kc b kd ma kg mb kj mc kn md kr me kv lw lx ly lz dt translated">比较(<code class="eh mg mh mi mj b">eq</code> | <code class="eh mg mh mi mj b">isZero</code>)</li><li id="aeaf" class="lr ls ht kc b kd ma kg mb kj mc kn md kr me kv lw lx ly lz dt translated">EVM环境相关(<code class="eh mg mh mi mj b">gas</code> | <code class="eh mg mh mi mj b">caller</code>)</li></ol></div><div class="ab cl mk ml hb mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="hm hn ho hp hq"><h1 id="e040" class="ji jj ht bd jk jl mr jn jo jp ms jr js iz mt ja ju jc mu jd jw jf mv jg jy jz dt translated">例如:可靠性-&gt;字节码-&gt;操作码</h1><p id="88da" class="pw-post-body-paragraph ka kb ht kc b kd ke iu kf kg kh ix ki kj kk kl km kn ko kp kq kr ks kt ku kv hm dt translated">在本节中，我们将使用一个简单的Solidity代码示例和演练</p><ol class=""><li id="8588" class="lr ls ht kc b kd lm kg ln kj lt kn lu kr lv kv lw lx ly lz dt translated">一个契约在字节码和操作码中是什么样子的</li><li id="7687" class="lr ls ht kc b kd ma kg mb kj mc kn md kr me kv lw lx ly lz dt translated">EVM如何知道函数调用要执行哪个操作码</li></ol><h2 id="f619" class="mw jj ht bd jk mx my mz jo na nb nc js kj nd ne ju kn nf ng jw kr nh ni jy nj dt translated"><strong class="ak">在字节码和操作码中，契约看起来像什么</strong></h2><p id="19e7" class="pw-post-body-paragraph ka kb ht kc b kd ke iu kf kg kh ix ki kj kk kl km kn ko kp kq kr ks kt ku kv hm dt translated">我们将使用如下所示的简单契约:</p><figure class="kx ky kz la fq lb"><div class="bz el l di"><div class="nk nl l"/></div></figure><p id="f673" class="pw-post-body-paragraph ka kb ht kc b kd lm iu kf kg ln ix ki kj lo kl km kn lp kp kq kr lq kt ku kv hm dt translated">通过<a class="ae mf" href="https://github.com/ethereum/solc-js" rel="noopener ugc nofollow" target="_blank"> solcjs </a> <br/> <code class="eh mg mh mi mj b">&gt; solcjs -o BytecodeDir --bin src/Demo.sol</code>编译成字节码后</p><pre class="kx ky kz la fq nm mj nn no aw np dt"><span id="6adc" class="mw jj ht mj b fv nq nr l ns nt">608060405234801561001057600080fd5b50610133806100206000396000f3fe6080604052348015600f57600080fd5b506004361060325760003560e01c80633c6bb4361460375780633d4197f0146051575b600080fd5b603d6069565b604051604891906090565b60405180910390f35b606760048036038101906063919060d5565b606f565b005b60005481565b8060008190555050565b6000819050919050565b608a816079565b82525050565b600060208201905060a360008301846083565b92915050565b600080fd5b60b5816079565b811460bf57600080fd5b50565b60008135905060cf8160ae565b92915050565b60006020828403121560e85760e760a9565b5b600060f48482850160c2565b9150509291505056fea26469706673582212202008ce9f466108e302b16a0a7d864882e3925c470c9a7371c7c03dfa5083b56f64736f6c63430008110033</span></pre><p id="ea2a" class="pw-post-body-paragraph ka kb ht kc b kd lm iu kf kg ln ix ki kj lo kl km kn lp kp kq kr lq kt ku kv hm dt translated">您还可以使用<a class="ae mf" href="https://etherscan.io/opcode-tool" rel="noopener ugc nofollow" target="_blank"> Etherscan的</a>工具转换成操作码(也可以使用<code class="eh mg mh mi mj b">solc</code>命令)</p><pre class="kx ky kz la fq nm mj nn no aw np dt"><span id="7328" class="mw jj ht mj b fv nq nr l ns nt">[0] DUP1<br/>[2] PUSH1 0x40<br/>[3] MSTORE<br/>[4] CALLVALUE<br/>...</span></pre></div><div class="ab cl mk ml hb mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="hm hn ho hp hq"><p id="ccc2" class="pw-post-body-paragraph ka kb ht kc b kd lm iu kf kg ln ix ki kj lo kl km kn lp kp kq kr lq kt ku kv hm dt translated">当你调用一个函数时，例如<code class="eh mg mh mi mj b">setVal(uint256)</code>——你的输入数据将包含你的方法签名和输入值。例如，当您调用<code class="eh mg mh mi mj b">setVal(10)</code>时，前4个字节是<code class="eh mg mh mi mj b">3d4197f0</code>，接下来的32个字节包含您的输入值<code class="eh mg mh mi mj b">10</code></p><pre class="kx ky kz la fq nm mj nn no aw np dt"><span id="dcec" class="mw jj ht mj b fv nq nr l ns nt">&gt; abi.encodeWithSignature("setVal(uint256)", 10)</span><span id="8c3a" class="mw jj ht mj b fv nu nr l ns nt">0x3d4197f0000000000000000000000000000000000000000000000000000000000000000a</span></pre><p id="87c1" class="pw-post-body-paragraph ka kb ht kc b kd lm iu kf kg ln ix ki kj lo kl km kn lp kp kq kr lq kt ku kv hm dt translated">您可以尝试搜索<code class="eh mg mh mi mj b">3d4197f0</code>——它存在于字节码中！这是第一个关于EVM如何知道为一个方法调用执行哪个操作码的提示😀</p><h2 id="abb5" class="mw jj ht bd jk mx my mz jo na nb nc js kj nd ne ju kn nf ng jw kr nh ni jy nj dt translated"><strong class="ak">EVM如何知道函数调用要执行哪个操作码</strong></h2><p id="1207" class="pw-post-body-paragraph ka kb ht kc b kd ke iu kf kg kh ix ki kj kk kl km kn ko kp kq kr ks kt ku kv hm dt translated"><strong class="kc hu">第一步:</strong> <br/>将上面的<code class="eh mg mh mi mj b">Demo.sol</code>复制到<a class="ae mf" href="https://remix.ethereum.org/" rel="noopener ugc nofollow" target="_blank"> Remix </a>中，编译部署。然后调用<code class="eh mg mh mi mj b">setVal(10)</code>并按下“调试”图标，它会把你带到调试器</p><p id="f059" class="pw-post-body-paragraph ka kb ht kc b kd lm iu kf kg ln ix ki kj lo kl km kn lp kp kq kr lq kt ku kv hm dt translated">你应该看到它直接把你带到了这个操作码，它在函数体中，尽管我们热衷于EVM如何把我们带到这个操作码，而不是函数执行的操作码。</p><pre class="kx ky kz la fq nm mj nn no aw np dt"><span id="3afd" class="mw jj ht mj b fv nq nr l ns nt">112 DUP1 <br/>113 PUSH1 00<br/>115 DUP2<br/></span></pre><p id="57e3" class="pw-post-body-paragraph ka kb ht kc b kd lm iu kf kg ln ix ki kj lo kl km kn lp kp kq kr lq kt ku kv hm dt translated"><strong class="kc hu">第二步:<br/> </strong>按下后退，直到看到这条指令高亮显示。</p><figure class="kx ky kz la fq lb fe ff paragraph-image"><div class="fe ff nw"><img src="../Images/175fca49e09654ee19578f12544fed33.png" data-original-src="https://miro.medium.com/v2/resize:fit:754/format:webp/1*iXNbp6tHDH-iZJDG5i9sZQ.png"/></div></figure><p id="ff2f" class="pw-post-body-paragraph ka kb ht kc b kd lm iu kf kg ln ix ki kj lo kl km kn lp kp kq kr lq kt ku kv hm dt translated">此时，您可以看到方法签名在堆栈中。从堆栈中取出两件物品。如果相等，则按1，否则按0)是下一个要调用的操作码。立即堆叠:</p><pre class="kx ky kz la fq nm mj nn no aw np dt"><span id="f86d" class="mw jj ht mj b fv nq nr l ns nt">Since both value are equal<br/>0: 0x..01<br/>1: 0x..3d4197f0</span></pre><p id="f68c" class="pw-post-body-paragraph ka kb ht kc b kd lm iu kf kg ln ix ki kj lo kl km kn lp kp kq kr lq kt ku kv hm dt translated">随后是将<code class="eh mg mh mi mj b">0x51</code>推入堆栈的<code class="eh mg mh mi mj b">PUSH 51</code>。立即堆叠:</p><pre class="kx ky kz la fq nm mj nn no aw np dt"><span id="aae0" class="mw jj ht mj b fv nq nr l ns nt">0: 0x..51<br/>1: 0x..01<br/>2: 0x..3d4197f0</span></pre><p id="79c3" class="pw-post-body-paragraph ka kb ht kc b kd lm iu kf kg ln ix ki kj lo kl km kn lp kp kq kr lq kt ku kv hm dt translated">之后是关键部分<code class="eh mg mh mi mj b">JUMPI</code>(从堆栈中弹出2值，如果index 1大于0则进行index 0程序计数器，否则继续)。</p><p id="84d9" class="pw-post-body-paragraph ka kb ht kc b kd lm iu kf kg ln ix ki kj lo kl km kn lp kp kq kr lq kt ku kv hm dt translated">在我们的例子中，由于堆栈的索引1是非零的，程序计数器将前进到我们的方法体<code class="eh mg mh mi mj b">0x51</code>。这就是EVM如何看待函数签名，并继续执行正确的操作码。</p><p id="bdf6" class="pw-post-body-paragraph ka kb ht kc b kd lm iu kf kg ln ix ki kj lo kl km kn lp kp kq kr lq kt ku kv hm dt translated"><strong class="kc hu">如果在JUMPIO </strong>中不相等怎么办？程序将不会跳转，并最终在操作码<code class="eh mg mh mi mj b">054</code>处到达<code class="eh mg mh mi mj b">REVERT</code>调用</p><h1 id="a95c" class="ji jj ht bd jk jl jm jn jo jp jq jr js iz jt ja ju jc jv jd jw jf jx jg jy jz dt translated"><strong class="ak">结尾注释</strong></h1><p id="46d0" class="pw-post-body-paragraph ka kb ht kc b kd ke iu kf kg kh ix ki kj kk kl km kn ko kp kq kr ks kt ku kv hm dt translated">理解EVM是如何工作的有助于成为更好的可靠性开发人员，就像Java开发人员应该理解JVM一样。例如，查看<a class="ae mf" href="https://www.evm.codes/" rel="noopener ugc nofollow" target="_blank">操作码</a> <code class="eh mg mh mi mj b">mstore</code>和<code class="eh mg mh mi mj b">sstore</code>的gas—您会看到存储在内存和存储中的gas差异。</p><p id="0622" class="pw-post-body-paragraph ka kb ht kc b kd lm iu kf kg ln ix ki kj lo kl km kn lp kp kq kr lq kt ku kv hm dt translated">我真的希望这篇文章能有所帮助！在下一篇文章中，我们将讨论智能合约的gas优化，这些操作码知识应该会派上用场！</p><h1 id="cd9f" class="ji jj ht bd jk jl jm jn jo jp jq jr js iz jt ja ju jc jv jd jw jf jx jg jy jz dt translated">参考</h1><p id="aed3" class="pw-post-body-paragraph ka kb ht kc b kd ke iu kf kg kh ix ki kj kk kl km kn ko kp kq kr ks kt ku kv hm dt translated">这些文章极大地帮助了我了解EVM，这要归功于他们！</p><ol class=""><li id="bf2d" class="lr ls ht kc b kd lm kg ln kj lt kn lu kr lv kv lw lx ly lz dt translated"><a class="ae mf" href="https://www.evm.codes/" rel="noopener ugc nofollow" target="_blank"> https://www.evm.codes/ </a></li><li id="bb38" class="lr ls ht kc b kd ma kg mb kj mc kn md kr me kv lw lx ly lz dt translated"><a class="ae mf" href="https://leftasexercise.com/2021/08/08/q-smart-contracts-and-the-ethereum-virtual-machine/" rel="noopener ugc nofollow" target="_blank">https://leftasexercise . com/2021/08/08/q-smart-contracts-and-the-ether eum-virtual-machine/</a></li><li id="dc31" class="lr ls ht kc b kd ma kg mb kj mc kn md kr me kv lw lx ly lz dt translated"><a class="ae mf" href="https://noxx.substack.com/p/evm-deep-dives-the-path-to-shadowy" rel="noopener ugc nofollow" target="_blank">https://noxx . substack . com/p/EVM-deep-dives-the-path-to-shadow</a></li></ol><blockquote class="nx"><p id="bf4d" class="ny nz ht bd oa ob oc od oe of og kv ek translated">交易新手？尝试<a class="ae mf" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">加密交易机器人</a>或<a class="ae mf" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">复制交易</a></p></blockquote></div></div>    
</body>
</html>