<html>
<head>
<title>Guide to Query Bitcoin Balances Using BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用BigQuery查询比特币余额指南</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/guide-to-query-bitcoin-balances-using-bigquery-a4b52ec2466a?source=collection_archive---------15-----------------------#2022-12-09">https://medium.com/coinmonks/guide-to-query-bitcoin-balances-using-bigquery-a4b52ec2466a?source=collection_archive---------15-----------------------#2022-12-09</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="83d6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在本文中，我们将展示如何在Google BigQuery中查询比特币地址的余额。</p><p id="0343" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">特别是，我们将展示如何使用<strong class="is hu"> LEAD </strong>、<strong class="is hu"> UNNEST </strong>和<strong class="is hu"> GENERATE_DATE_ARRAY </strong>来填补区块链地址上没有交易的日期空白。</p><figure class="jp jq jr js fq jt fe ff paragraph-image"><div role="button" tabindex="0" class="ju jv di jw bf jx"><div class="fe ff jo"><img src="../Images/8407240e6a70a390bcc8ab4cd22747b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LJY0rGCBbTdGrw7EBnWc6g.png"/></div></div><figcaption class="ka kb fg fe ff kc kd bd b be z ek">Extract on-chain Bitcoin data</figcaption></figure><h1 id="47ab" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">第一步</h1><p id="9ec4" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hm dt translated">我们将运用借记和贷记的会计概念，对区块链上的所有交易建立复式账簿。这遵循了<a class="ae lh" href="https://www.cloudskillsboost.google/focuses/8486?parent=catalog" rel="noopener ugc nofollow" target="_blank">谷歌云网站</a>上描述的想法。</p><pre class="jp jq jr js fq li lj lk bn ll lm bi"><span id="14da" class="ln kf ht lj b be lo lp l lq lr">WITH double_entry_book AS (<br/>    -- debits<br/>    SELECT array_to_string(inputs.addresses, ",") AS address, -inputs.value AS value, <br/>    DATE(block_timestamp) AS date<br/>    FROM `bigquery-public-data.crypto_bitcoin.inputs` AS inputs<br/>    UNION ALL<br/>    -- credits<br/>    SELECT array_to_string(outputs.addresses, ",") AS address, outputs.value AS value, <br/>    DATE(block_timestamp) AS date<br/>    FROM `bigquery-public-data.crypto_bitcoin.outputs` AS outputs<br/>),</span></pre><h1 id="a750" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">第二步</h1><p id="eb93" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hm dt translated">条目按日期和地址分组。</p><p id="403f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">“价值”的单位通过除以10^8.转换成比特币</p><pre class="jp jq jr js fq li lj lk bn ll lm bi"><span id="6ef8" class="ln kf ht lj b be lo lp l lq lr">double_entry_book_grouped AS (<br/>    SELECT date, address, SUM(value / POWER(10,8)) AS value<br/>    FROM double_entry_book<br/>    GROUP BY date, address<br/>),</span></pre><h1 id="0f6c" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">第三步</h1><p id="3aae" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hm dt translated">对于那些没有任何事务的日期，时间序列显示为完全缺失的记录。</p><ul class=""><li id="d81d" class="ls lt ht is b it iu ix iy jb lu jf lv jj lw jn lx ly lz ma dt translated"><strong class="is hu"> LEAD </strong> —返回每个地址间隔后的日期</li></ul><pre class="jp jq jr js fq li lj lk bn ll lm bi"><span id="203f" class="ln kf ht lj b be lo lp l lq lr">daily_balances_gappy AS (<br/>    SELECT date, address,<br/>    SUM(value) OVER (PARTITION BY address ORDER BY date) AS balance,<br/>    LEAD(date, 1, CURRENT_DATE()) OVER (PARTITION BY address ORDER BY date) AS next_date<br/>    FROM double_entry_book_grouped<br/>),</span></pre><h1 id="9404" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">第四步</h1><p id="0545" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hm dt translated">为了创建合成行，我们将使用<strong class="is hu"> UNNEST </strong>将一个数组转换为一个表，其中数组中的每个元素都有一行，并使用<strong class="is hu"> GENERATE_DATE_ARRAY </strong>创建一个从‘2009–01–01’到当前日期的日期数组。</p><pre class="jp jq jr js fq li lj lk bn ll lm bi"><span id="1f3d" class="ln kf ht lj b be lo lp l lq lr"><br/>all_dates AS (<br/>    SELECT date FROM UNNEST(GENERATE_DATE_ARRAY('2009-01-01', CURRENT_DATE())) AS date<br/>),</span></pre><h1 id="0511" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">第五步</h1><p id="2789" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hm dt translated">接下来，我们创建一个包含连续系列每日余额的表。合成行被<strong class="is hu">连接到原始时间序列上</strong>以填补空白。</p><pre class="jp jq jr js fq li lj lk bn ll lm bi"><span id="b58b" class="ln kf ht lj b be lo lp l lq lr">daily_balances_gapless AS (<br/>    SELECT address, all_dates.date, balance<br/>    FROM daily_balances_gappy<br/>    JOIN all_dates ON daily_balances_gappy.date &lt;= all_dates.date AND all_dates.date &lt; daily_balances_gappy.next_date<br/>  ),</span></pre><h1 id="ea00" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">第六步</h1><p id="32c9" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hm dt translated">计算所有地址的每日余额。</p><pre class="jp jq jr js fq li lj lk bn ll lm bi"><span id="0783" class="ln kf ht lj b be lo lp l lq lr"><br/>all_daily_balances AS (<br/>    SELECT DISTINCT date, SUM(balance) OVER(PARTITION BY date) AS balance<br/>    FROM daily_balances_gapless<br/>  )</span></pre><h1 id="5f7c" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">第七步</h1><p id="4fd1" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hm dt translated">以下查询获取“all_daily_balances”表中所有列的值。</p><pre class="jp jq jr js fq li lj lk bn ll lm bi"><span id="72dd" class="ln kf ht lj b be lo lp l lq lr"><br/>  SELECT * FROM all_daily_balances<br/>  ORDER BY date</span></pre><h1 id="faa5" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">结论</h1><p id="8b4f" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hm dt translated">完整的查询如下所示。该查询使用218.6 GB在BigQuery中运行。</p><pre class="jp jq jr js fq li lj lk bn ll lm bi"><span id="2674" class="ln kf ht lj b be lo lp l lq lr">WITH double_entry_book AS (<br/>    -- debits<br/>    SELECT array_to_string(inputs.addresses, ",") AS address, -inputs.value AS value, <br/>    DATE(block_timestamp) AS date<br/>    FROM `bigquery-public-data.crypto_bitcoin.inputs` AS inputs<br/>    UNION ALL<br/>    -- credits<br/>    SELECT array_to_string(outputs.addresses, ",") AS address, outputs.value AS value, <br/>    DATE(block_timestamp) AS date<br/>    FROM `bigquery-public-data.crypto_bitcoin.outputs` AS outputs<br/>), <br/><br/>double_entry_book_grouped AS (<br/>    SELECT date, address, SUM(value / POWER(10,8)) AS value<br/>    FROM double_entry_book<br/>    GROUP BY date, address<br/>),<br/><br/>daily_balances_gappy AS (<br/>    SELECT date, address,<br/>    SUM(value) OVER (PARTITION BY address ORDER BY date) AS balance,<br/>    LEAD(date, 1, CURRENT_DATE()) OVER (PARTITION BY address ORDER BY date) AS next_date<br/>    FROM double_entry_book_grouped<br/>),<br/><br/>all_dates AS (<br/>    SELECT date FROM UNNEST(GENERATE_DATE_ARRAY('2009-01-01', CURRENT_DATE())) AS date<br/>),<br/><br/>daily_balances_gapless AS (<br/>    SELECT address, all_dates.date, balance<br/>    FROM daily_balances_gappy<br/>    JOIN all_dates ON daily_balances_gappy.date &lt;= all_dates.date and all_dates.date &lt; daily_balances_gappy.next_date<br/>  ),<br/><br/>all_daily_balances AS (<br/>    SELECT DISTINCT date, SUM(balance) OVER(PARTITION BY date) AS balance<br/>    FROM daily_balances_gapless<br/>)<br/><br/>SELECT * FROM all_daily_balances<br/>ORDER BY date</span></pre><p id="6c5d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在下一篇文章中，我们将展示如何使用这个查询来计算交易所的比特币余额。</p></div><div class="ab cl mb mc hb md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="hm hn ho hp hq"><p id="2c1a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu"> <em class="mi">感谢阅读！</em> </strong></p><p id="e455" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果您喜欢这篇文章，并想了解更多，请考虑关注我。我定期发布与链上分析、机器学习和BigQuery相关的主题。我尽量让我的文章简单而精确，尽可能提供代码、例子和模拟。</p></div></div>    
</body>
</html>