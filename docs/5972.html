<html>
<head>
<title>Uniswap v3. Using to your contracts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Uniswap v3。使用您的合同</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/uniswap-v3-using-to-your-contracts-19032a62e4e8?source=collection_archive---------3-----------------------#2022-11-06">https://medium.com/coinmonks/uniswap-v3-using-to-your-contracts-19032a62e4e8?source=collection_archive---------3-----------------------#2022-11-06</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="c4a1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><em class="jo">uni WAP v3的新增功能以及如何集成uni WAP v3</em></p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/456661efad04659e6a90484e674c03d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2G3TUnwxqMxcRIdZzxN6CQ.png"/></div></div></figure><p id="ef23" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果你还不熟悉Uniswap，它是以太坊上自动化流动性供应的完全去中心化的协议。一个更容易理解的描述是，它是一个依赖外部流动性提供商的分散式交易所(DEX)，可以向智能合约池添加令牌，用户可以直接交易这些令牌。</p><p id="36fe" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">因为它是在以太坊上运行的，我们可以交易的是以太坊ERC-20代币。每种代币都有自己的智能合约和流动性池。Uniswap是完全分散的，对可以添加哪些令牌没有限制。如果还没有令牌对的合约，任何人都可以使用他们的工厂创建一个，任何人都可以向池提供流动性。每笔交易收取0.3%的费用，作为对流动性提供者的激励。</p><p id="d6d5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">代币的价格由资金池中的流动性决定。例如，如果用户用<strong class="is hu">托EN2 </strong>购买<strong class="is hu">托EN1 </strong>，那么库存中<strong class="is hu">托EN1 </strong>的供应量将会减少，而<strong class="is hu">托EN2 </strong>的供应量将会增加，托EN1的价格将会上涨。同样，如果用户正在出售<strong class="is hu">托克EN1 </strong>，那么<strong class="is hu">托克EN1 </strong>的价格将会下降。因此，代币价格总是反映供求关系。</p><p id="7042" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">当然，用户不一定是人，也可以是智能合同。这使我们能够将Uniswap添加到我们自己的合同中，为我们合同的用户增加额外的支付选项。Uniswap使这一过程非常方便，见下文如何整合它。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kb"><img src="../Images/7e2904407534a1516e411a9ae8d46925.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*45O_IOV3eSLXwJ4d1C_B8Q.jpeg"/></div></div></figure><h1 id="07e5" class="kc kd ht bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">UniSwap v3有什么新功能？</h1><p id="8329" class="pw-post-body-paragraph iq ir ht is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hm dt translated">您可以在这里阅读更多关于Uniswap v2 <a class="ae lf" href="https://v2.info.uniswap.org/" rel="noopener ugc nofollow" target="_blank">的信息，但现在让我们看看Uniswap v3的新功能:</a></p><ul class=""><li id="965f" class="lg lh ht is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo dt translated">流动性提供者的新功能，允许他们定义有效的价格范围。每当该池当前在该范围之外时，它们的流动性被忽略。这不仅降低了流动性提供者的非永久性损失的风险，也大大提高了资本效率，因为…</li><li id="a45f" class="lg lh ht is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo dt translated">不同的费用等级，由资金池的风险水平决定。有三个不同的等级:<br/> <strong class="is hu"> 1) </strong> <strong class="is hu">稳定对</strong> : 0.05%。这些费用应该是针对像和戴这样波动风险较低的投资组合的。由于两者都是稳定的硬币，潜在的非永久性损失是非常低的。这对于交易者来说尤其有趣，因为它将允许稳定硬币之间非常便宜的互换。<br/> <strong class="is hu"> 2)中等风险对</strong> : 0.30%。中等风险被认为是任何具有高交易量/受欢迎程度的非相关货币对，受欢迎的货币对往往具有稍低的波动风险。<br/> <strong class="is hu"> 3)高风险对</strong> : 1.00%。任何其他外来货币对将被视为流动性提供者的高风险，并产生1%的最高交易费。</li><li id="7775" class="lg lh ht is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo dt translated">改进的uni WAP v2 TWAP Oracle机制，其中单个链上调用可以检索最近9天的TWAP价格。为了实现这一点，不是只存储一个累计价格总和，而是将所有相关的价格总和存储在一个固定大小的数组中。这可能会略微增加汽油成本，但总的来说，对于oracle的大规模增强来说是值得的。</li></ul><h2 id="1514" class="lu kd ht bd ke lv lw lx ki ly lz ma km jb mb mc kq jf md me ku jj mf mg ky mh dt translated">更多Uniswap v3资源</h2><ul class=""><li id="45d6" class="lg lh ht is b it la ix lb jb mi jf mj jj mk jn ll lm ln lo dt translated"><a class="ae lf" href="https://uniswap.org/blog/launch-uniswap-v3/" rel="noopener ugc nofollow" target="_blank">自2021年5月5日起在Mainnet上直播</a></li><li id="8d66" class="lg lh ht is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo dt translated"><a class="ae lf" href="https://docs.uniswap.org/" rel="noopener ugc nofollow" target="_blank">单据</a></li><li id="49e4" class="lg lh ht is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo dt translated"><a class="ae lf" href="https://uniswap.org/whitepaper-v3.pdf" rel="noopener ugc nofollow" target="_blank">白皮书</a></li></ul><blockquote class="ml mm mn"><p id="cfb3" class="iq ir jo is b it iu iv iw ix iy iz ja mo jc jd je mp jg jh ji mq jk jl jm jn hm dt translated"><strong class="is hu">uni swap v2会怎么样？<br/></strong>“uni swap是一套自动化、去中心化的智能合约。只要以太坊存在，它就会继续运作。”—海登·亚当斯。</p></blockquote><h1 id="e7fd" class="kc kd ht bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">集成UniSwap v3</h1><p id="46b1" class="pw-post-body-paragraph iq ir ht is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hm dt translated">Uniswap如此受欢迎的原因之一可能是将它们集成到您自己的智能合同中的简单方式。假设你有一个系统，用户用戴付款。有了Uniswap，只需几行代码，您就可以为他们添加在ETH中支付的选项。ETH可以在实际逻辑之前自动转换为DAI。它看起来会像这样</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="mr ms l"/></div></figure><p id="a0b8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在函数开始时做一个简单的检查就足够了。至于<code class="eh mt mu mv mw b">convertEthToExactDai</code>函数，它看起来像这样:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="mr ms l"/></div></figure><p id="496f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这里有几样东西需要解开。</p><ul class=""><li id="91c7" class="lg lh ht is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo dt translated">交换路由器(Swap Router):交换路由器将是Uniswap提供的一个包装器契约，具有多种安全机制和便利功能。您可以使用<code class="eh mt mu mv mw b">ISwapRouter(0xE592427A0AEce92De3Edee1F18E0157C05861564</code>为任何main或testnet实例化它。接口代码可以在这里找到<a class="ae lf" href="https://github.com/Uniswap/uniswap-v3-periphery/blob/main/contracts/interfaces/ISwapRouter.sol" rel="noopener ugc nofollow" target="_blank">。</a></li><li id="b6cd" class="lg lh ht is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo dt translated"><strong class="is hu">我们</strong>:你可能会注意到我们这里用的是ETH。在Uniswap中，不再有直接的ETH对，所有的ETH必须首先转换成WETH(即包装为ERC-20的ETH)。在我们的例子中，这是由路由器完成的。</li><li id="628b" class="lg lh ht is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo dt translated"><a class="ae lf" href="https://docs.uniswap.org/reference/periphery/interfaces/ISwapRouter#exactoutputsingle" rel="noopener ugc nofollow" target="_blank"><strong class="is hu">exactOutputSingle</strong></a><strong class="is hu">:</strong>该函数可用于使用ETH并为其接收精确数量的令牌。任何剩余的ETH将被退还，但<strong class="is hu">不会自动</strong>！我自己并没有首先意识到这一点，ETH最终签订了交换路由器合同。所以<strong class="is hu">互换之后别忘了调用</strong> <code class="eh mt mu mv mw b"><strong class="is hu">uniswapRouter.refundETH()</strong></code>！并确保您的合同中有一个后备功能来接收ETH: <code class="eh mt mu mv mw b">receive() payable external {}</code>。<code class="eh mt mu mv mw b">deadline</code>参数将确保矿商不能扣留互换，并在以后更有利可图的时候使用。确保从您的前端传递这个UNIX时间戳，<strong class="is hu">不要在契约</strong>中使用 <code class="eh mt mu mv mw b"><strong class="is hu">now</strong></code> <strong class="is hu">。</strong></li><li id="547c" class="lg lh ht is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo dt translated">退款:一旦交易完成，我们可以将剩余的ETH退还给用户。这将发送合同中的所有ETH，因此如果您的合同由于其他原因可能有ETH余额，请确保更改这一点。</li><li id="7921" class="lg lh ht is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo dt translated"><strong class="is hu">费用</strong>:这是一个不稳定的，但受欢迎的一对，所以我们在这里使用的费用是0.3%(见上面的费用部分)。</li><li id="ce67" class="lg lh ht is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo dt translated"><strong class="is hu"> sqrtPriceLimitX96 </strong>:可用于确定互换不能超过的池价格限制。如果将它设置为0，它将被忽略。</li></ul></div><div class="ab cl mx my hb mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="hm hn ho hp hq"><h1 id="87bd" class="kc kd ht bd ke kf ne kh ki kj nf kl km kn ng kp kq kr nh kt ku kv ni kx ky kz dt translated">如何在前端使用它</h1><p id="07c4" class="pw-post-body-paragraph iq ir ht is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hm dt translated">我们现在面临的一个问题是，当用户调用支付功能并希望在ETH中支付时，我们不知道他需要多少ETH。我们可以使用<a class="ae lf" href="https://docs.uniswap.org/reference/periphery/interfaces/IQuoter#quoteexactoutputsingle" rel="noopener ugc nofollow" target="_blank"> quoteExactOutputSingle </a>函数来精确计算。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="mr ms l"/></div></figure><p id="76f4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">但是请注意，我们没有将它声明为视图函数，但是<strong class="is hu">不要在链上调用这个函数</strong>。它仍然意味着作为一个视图函数被调用，但由于它使用了非视图函数来计算结果，所以它不可能声明它本身是一个视图函数(Solidity特性请求？).例如，使用Web3的<a class="ae lf" href="https://web3js.readthedocs.io/en/v1.3.4/web3-eth-contract.html#methods-mymethod-call" rel="noopener ugc nofollow" target="_blank"> call() </a>功能在前端读取结果。</p><p id="1e41" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在我们可以在前端调用<code class="eh mt mu mv mw b">getEstimatedETHforDAI</code>。为了确保我们发送足够的ETH，并且事务不会被恢复，我们可以将ETH的估计量增加一点:</p><pre class="jq jr js jt fq nj mw nk nl aw nm dt"><span id="b811" class="lu kd ht mw b fv nn no l np nq">const requiredEth = (await myContract.getEstimatedETHforDAI(daiAmount).call())[0];<br/>const sendEth = requiredEth * 1.1;</span></pre><h1 id="bd15" class="kc kd ht bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">如果没有可用于交换的直接池，该怎么办？</h1><p id="bf60" class="pw-post-body-paragraph iq ir ht is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hm dt translated">在这种情况下，您可以使用以<code class="eh mt mu mv mw b">path</code>为参数的<a class="ae lf" href="https://docs.uniswap.org/reference/periphery/interfaces/ISwapRouter#exactinput" rel="noopener ugc nofollow" target="_blank">精确输入</a>和<a class="ae lf" href="https://docs.uniswap.org/reference/periphery/interfaces/ISwapRouter#exactoutput" rel="noopener ugc nofollow" target="_blank">精确输出</a>功能。该路径是令牌地址的字节编码数据(为气体效率而编码)。</p><p id="f9ad" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">任何交换都需要有开始和结束路径。虽然在Uniswap中，您可以拥有直接的令牌对，但并不总是保证这样的池确实存在。但是只要你能找到一条路径，你仍然可以交易它们，例如<strong class="is hu">token 1</strong>→<strong class="is hu">token 2</strong>→<strong class="is hu">WETH</strong>→<strong class="is hu">token 3</strong>。在这种情况下，您仍然可以用令牌1交换令牌3，这只会比直接交换多花一点汽油。</p><p id="623a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">下面你可以看到如何在前端计算这个路径的Uniswap示例代码。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="mr ms l"/></div></figure><h1 id="322a" class="kc kd ht bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">完全工作的例子</h1><p id="db4c" class="pw-post-body-paragraph iq ir ht is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hm dt translated">这里有一个完全可行的例子，你可以直接用在混音上。它允许您用ETH交换<a class="ae lf" href="https://oasis.app/borrow?network=kovan" rel="noopener ugc nofollow" target="_blank">多整理剂Kovan DAI </a>。它还包括对<a class="ae lf" href="https://docs.uniswap.org/reference/periphery/interfaces/ISwapRouter#exactoutputsingle" rel="noopener ugc nofollow" target="_blank"> exactOutputSingle </a>的替代方案，即<a class="ae lf" href="https://docs.uniswap.org/reference/periphery/interfaces/ISwapRouter#exactinputsingle" rel="noopener ugc nofollow" target="_blank">exact output single</a>，并允许您交易ETH以获得您将获得的DAI。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="mr ms l"/></div></figure><h1 id="020c" class="kc kd ht bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">精确输入和精确输出的区别</h1><p id="4cc0" class="pw-post-body-paragraph iq ir ht is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hm dt translated">一旦您执行了这些功能，并在Etherscan中查看它们，差异就会变得非常明显。这里我们用精确输出进行交易。我们提供1个ETH，希望得到100 DAI的回报。多余的ETH将退还给我们。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff nr"><img src="../Images/d703c63766dc207d1e8d927a2b1f5dec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BxjR5pqmgXG1yL3dfnFhhA.jpeg"/></div></div></figure><p id="65c4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这里我们使用exactInput进行交易。我们提供1个ETH，并希望收到我们所能得到的DAI，正好是196个DAI。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff nr"><img src="../Images/4d306d2b8cc06db5bc6fed388886fe34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lvkzbN0wRXGKxA7u36KGcw.jpeg"/></div></div></figure><p id="9c7b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这里我使用了一个旧的测试网络。要在另一个测试网络(如Goerli)中实现这一点，请找到一个水龙头或创建自己的DAI和WETH令牌进行交换。</p><p id="0bd1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu"> <em class="jo">感谢您的关注，后会有期！😉</em> </strong></p><blockquote class="ns"><p id="4165" class="nt nu ht bd nv nw nx ny nz oa ob jn ek translated">交易新手？试试<a class="ae lf" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">加密交易机器人</a>或者<a class="ae lf" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">复制交易</a></p></blockquote></div></div>    
</body>
</html>