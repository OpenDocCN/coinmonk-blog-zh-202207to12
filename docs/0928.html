<html>
<head>
<title>Metamorphic Contracts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">变形合同</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/metamorphic-contracts-5e6a022914e5?source=collection_archive---------5-----------------------#2022-07-19">https://medium.com/coinmonks/metamorphic-contracts-5e6a022914e5?source=collection_archive---------5-----------------------#2022-07-19</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="9d04" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">为初学者打破变质合同。</h2></div><p id="5cc1" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">上一篇:<a class="ae ke" rel="noopener" href="/coinmonks/dark-side-of-create2-opcode-6b6838a42d71">https://medium . com/coin monks/dark-side-of-create 2-opcode-6b 6838 a42d 71</a></p><p id="301b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">上一篇文章TL；DR:我们已经部署并销毁了2个契约，并使用create和create2操作码将它们部署在同一个地址。</p><p id="df39" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">在继续之前，我想回答一个与前一篇文章相关的常见问题。</p><p id="332f" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">之前的文章想说什么(非以太坊开发者)？</p><p id="1ad1" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">如果以这种方式编写，智能契约是完全可变。</p><p id="7b05" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">好了，我们继续。首先，让我们从向目标地址部署全新的代码开始</p><p id="519f" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">遵循前一篇文章中的步骤，直到第4步，现在重新部署CreatorContract，而不是部署目标契约的代码，而是部署它仍将部署在同一地址的任何代码。</p><p id="0d8e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">这是它的代码。</p><pre class="kf kg kh ki fq kj kk kl km aw kn dt"><span id="6aa8" class="ko kp ht kk b fv kq kr l ks kt">// SPDX-License-Identifier: UNLICENSED</span><span id="bb4b" class="ko kp ht kk b fv ku kr l ks kt">pragma solidity ^0.8.12;</span><span id="6c6c" class="ko kp ht kk b fv ku kr l ks kt">contract Target {</span><span id="6bc7" class="ko kp ht kk b fv ku kr l ks kt">address public owner;</span><span id="2537" class="ko kp ht kk b fv ku kr l ks kt">constructor() {</span><span id="a728" class="ko kp ht kk b fv ku kr l ks kt">owner = msg.sender;</span><span id="fefc" class="ko kp ht kk b fv ku kr l ks kt">}</span><span id="034d" class="ko kp ht kk b fv ku kr l ks kt">function approve (address _spender,uint _value) public  returns (string memory) {</span><span id="65a7" class="ko kp ht kk b fv ku kr l ks kt">return "Thug Life BGM playing...";</span><span id="bdfe" class="ko kp ht kk b fv ku kr l ks kt">}</span><span id="e597" class="ko kp ht kk b fv ku kr l ks kt">function destroy() public {</span><span id="875d" class="ko kp ht kk b fv ku kr l ks kt">selfdestruct(payable(msg.sender));</span><span id="6038" class="ko kp ht kk b fv ku kr l ks kt">}</span><span id="a609" class="ko kp ht kk b fv ku kr l ks kt">}</span></pre><p id="0028" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">事务哈希:</p><p id="4a4f" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">目标契约自毁-<a class="ae ke" href="https://mumbai.polygonscan.com/tx/0x3cb50d84b48c2ec1b6d0c58a925fe6fb56d515aedbcd843d5e0bb9e562378a20" rel="noopener ugc nofollow" target="_blank">0 x3cb 50d 84 b 48 C2 EC 1 b 6d 0 c 58 a 925 Fe 6 FB 56d 515 aed BCD 843 D5 E0 bb 9 e 562378 a 20</a></p><p id="5646" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">目标合同部署-<a class="ae ke" href="https://mumbai.polygonscan.com/tx/0xb311cd648cdb08313e90abeefa27b54f68128543f5b484eb515d84ff974a5388" rel="noopener ugc nofollow" target="_blank">0xb 311 CD 648 CDB 08313 e 90 Abe EFA 27 b 54 f 68128543 f5b 484 EB 515d 84 ff 974 a 5388</a></p><figure class="kf kg kh ki fq kw fe ff paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="fe ff kv"><img src="../Images/711a069e4ffd0394e74e5f79ab50e81c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hsR0qcRDAOxXlBRIhcZjZw.png"/></div></div></figure><p id="fea0" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">观察结果:</p><ol class=""><li id="ca9f" class="ld le ht jk b jl jm jo jp jr lf jv lg jz lh kd li lj lk ll dt translated">只有当它使用create或create2操作码创建新合同时，合同nonces才会增加。</li><li id="d392" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll dt translated">在较新的合同中，合同用随机数1初始化，而旧的合同用随机数0初始化。(更详细的上下文阅读→ <a class="ae ke" href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-161.md" rel="noopener ugc nofollow" target="_blank"> EIP-161 </a>)</li><li id="078e" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll dt translated">任何具有自毁功能的合约或通过委托调用与其他合约交互的合约都是不安全的。</li><li id="4eed" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll dt translated">当Create2构造函数参数改变时地址改变。</li></ol><p id="e012" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">5.为什么不能用这个代替代理？→答案是存储在契约中的先前状态被破坏，这不是我们所需要的。</p><p id="0535" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">变形合同:</p><ul class=""><li id="53ec" class="ld le ht jk b jl jm jo jp jr lf jv lg jz lh kd lr lj lk ll dt translated">我们在上面看到的是如何使用<strong class="jk hu"> create </strong>操作码在同一地址中重新部署不同代码的契约。</li><li id="a5a2" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd lr lj lk ll dt translated">现在让我们看看如何使用<strong class="jk hu"> create2 </strong>操作码在同一地址中重新部署具有不同代码的契约。</li><li id="fc7b" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd lr lj lk ll dt translated">变形契约的要点→想法是部署一个智能契约，在部署时，用不同的字节码替换它自己的字节码。因此，通过CREATE2运行的字节码总是相同的，并且在部署期间回调工厂并替换自身。</li></ul><pre class="kf kg kh ki fq kj kk kl km aw kn dt"><span id="5aea" class="ko kp ht kk b fv kq kr l ks kt">//SPDX-License-Identifier: MIT</span><span id="db1e" class="ko kp ht kk b fv ku kr l ks kt">pragma solidity 0.8.1;</span><span id="92fb" class="ko kp ht kk b fv ku kr l ks kt">contract Factory {<br/>    mapping (address =&gt; address) _implementations;</span><span id="85b0" class="ko kp ht kk b fv ku kr l ks kt">event Deployed(address _addr);</span><span id="95e4" class="ko kp ht kk b fv ku kr l ks kt">function deploy(uint salt, bytes calldata bytecode) public {</span><span id="b813" class="ko kp ht kk b fv ku kr l ks kt">bytes memory implInitCode = bytecode;</span><span id="4133" class="ko kp ht kk b fv ku kr l ks kt">// assign the initialization code for the metamorphic contract.<br/>        bytes memory metamorphicCode  = (<br/>          hex"5860208158601c335a63aaf10f428752fa158151803b80938091923cf3"<br/>        );</span><span id="678a" class="ko kp ht kk b fv ku kr l ks kt">// determine the address of the metamorphic contract.<br/>        address metamorphicContractAddress = _getMetamorphicContractAddress(salt, metamorphicCode);</span><span id="764a" class="ko kp ht kk b fv ku kr l ks kt">// declare a variable for the address of the implementation contract.<br/>        address implementationContract;</span><span id="dba8" class="ko kp ht kk b fv ku kr l ks kt">// load implementation init code and length, then deploy via CREATE.<br/>        /* solhint-disable no-inline-assembly */<br/>        assembly {<br/>          let encoded_data := add(0x20, implInitCode) // load initialization code.<br/>          let encoded_size := mload(implInitCode)     // load init code's length.<br/>          implementationContract := create(       // call CREATE with 3 arguments.<br/>            0,                                    // do not forward any endowment.<br/>            encoded_data,                         // pass in initialization code.<br/>            encoded_size                          // pass in init code's length.<br/>          )<br/>        } /* solhint-enable no-inline-assembly */</span><span id="c31a" class="ko kp ht kk b fv ku kr l ks kt">//first we deploy the code we want to deploy on a separate address<br/>        // store the implementation to be retrieved by the metamorphic contract.<br/>        _implementations[metamorphicContractAddress] = implementationContract;</span><span id="8369" class="ko kp ht kk b fv ku kr l ks kt">address addr;<br/>        assembly {<br/>            let encoded_data := add(0x20, metamorphicCode) // load initialization code.<br/>            let encoded_size := mload(metamorphicCode)     // load init code's length.<br/>            addr := create2(0, encoded_data, encoded_size, salt)<br/>        }</span><span id="2318" class="ko kp ht kk b fv ku kr l ks kt">require(<br/>          addr == metamorphicContractAddress,<br/>          "Failed to deploy the new metamorphic contract."<br/>        );<br/>        emit Deployed(addr);<br/>    }</span><span id="f923" class="ko kp ht kk b fv ku kr l ks kt">/**<br/>    * <a class="ae ke" href="http://twitter.com/dev" rel="noopener ugc nofollow" target="_blank">@dev</a> Internal view function for calculating a metamorphic contract address<br/>    * given a particular salt.<br/>    */<br/>    function _getMetamorphicContractAddress(<br/>        uint256 salt,<br/>        bytes memory metamorphicCode<br/>        ) internal view returns (address) {</span><span id="d34b" class="ko kp ht kk b fv ku kr l ks kt">// determine the address of the metamorphic contract.<br/>        return address(<br/>          uint160(                      // downcast to match the address type.<br/>            uint256(                    // convert to uint to truncate upper digits.<br/>              keccak256(                // compute the CREATE2 hash using 4 inputs.<br/>                abi.encodePacked(       // pack all inputs to the hash together.<br/>                  hex"ff",              // start with 0xff to distinguish from RLP.<br/>                  address(this),        // this contract will be the caller.<br/>                  salt,                 // pass in the supplied salt value.<br/>                  keccak256(<br/>                      abi.encodePacked(<br/>                        metamorphicCode<br/>                      )<br/>                    )     // the init code hash.<br/>                )<br/>              )<br/>            )<br/>          )<br/>        );<br/>    }</span><span id="9799" class="ko kp ht kk b fv ku kr l ks kt">//those two functions are getting called by the metamorphic Contract<br/>    function getImplementation() external view returns (address implementation) {<br/>        return _implementations[msg.sender];<br/>    }</span><span id="8d13" class="ko kp ht kk b fv ku kr l ks kt">}</span><span id="2a15" class="ko kp ht kk b fv ku kr l ks kt">contract Test1 {<br/>    uint public myUint;</span><span id="462e" class="ko kp ht kk b fv ku kr l ks kt">function setUint(uint _myUint) public {<br/>        myUint = _myUint;<br/>    }</span><span id="c695" class="ko kp ht kk b fv ku kr l ks kt">function killme() public {<br/>        selfdestruct(payable(msg.sender));<br/>    }<br/>}</span><span id="6503" class="ko kp ht kk b fv ku kr l ks kt">contract Test2 {<br/>    uint public myUint;</span><span id="9f1b" class="ko kp ht kk b fv ku kr l ks kt">function setUint(uint _myUint) public {<br/>        myUint = 2*_myUint;<br/>    }</span><span id="0fe5" class="ko kp ht kk b fv ku kr l ks kt">function killme() public {<br/>        selfdestruct(payable(msg.sender));<br/>    }</span><span id="513b" class="ko kp ht kk b fv ku kr l ks kt">}</span></pre><ol class=""><li id="0be1" class="ld le ht jk b jl jm jo jp jr lf jv lg jz lh kd li lj lk ll dt translated">部署工厂</li><li id="69b3" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll dt translated">使用salt=1的Test1字节码来部署Test1。</li><li id="cca1" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll dt translated">告诉Remix that在变形契约的地址上运行</li><li id="9749" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll dt translated">将“myUint”设置为您想要的任何值，它都会工作</li><li id="8f33" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll dt translated">杀死测试1</li><li id="be88" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll dt translated">使用相同的salt=1部署Test2字节码</li><li id="27cd" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll dt translated">它将部署一个不同的字节码到相同的地址！！！</li><li id="675b" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll dt translated">现在setUint使输入量增加了一倍。</li></ol><p id="8c05" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">观察结果:</p><ol class=""><li id="63fa" class="ld le ht jk b jl jm jo jp jr lf jv lg jz lh kd li lj lk ll dt translated">有两种类型的合同字节码(即</li></ol><ul class=""><li id="6c49" class="ld le ht jk b jl jm jo jp jr lf jv lg jz lh kd lr lj lk ll dt translated"><strong class="jk hu">创作代码</strong></li><li id="3a9e" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd lr lj lk ll dt translated"><strong class="jk hu">运行时间码</strong></li></ul><p id="9a64" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">2.创建代码→</p><ul class=""><li id="6ee3" class="ld le ht jk b jl jm jo jp jr lf jv lg jz lh kd lr lj lk ll dt translated">包含协定的创建字节码的内存字节数组。</li><li id="7e03" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd lr lj lk ll dt translated">这可以在内联汇编中用来构建定制的创建例程，尤其是通过使用<code class="eh ls lt lu kk b">create2</code>操作码。</li><li id="c43c" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd lr lj lk ll dt translated">该属性不能在契约本身或任何派生的契约中被访问。</li><li id="14ff" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd lr lj lk ll dt translated">它导致字节码包含在调用站点的字节码中，因此像这样的循环引用是不可能的。</li></ul><p id="3ea5" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">3.<strong class="jk hu"> RuntimeCode → </strong></p><ul class=""><li id="0f59" class="ld le ht jk b jl jm jo jp jr lf jv lg jz lh kd lr lj lk ll dt translated">包含协定的运行时字节码的内存字节数组。</li><li id="5b9f" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd lr lj lk ll dt translated">这是通常由<code class="eh ls lt lu kk b">C</code>的构造器部署的代码。</li><li id="57ea" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd lr lj lk ll dt translated">如果<code class="eh ls lt lu kk b">C</code>有一个使用内联汇编的构造函数，这可能与实际部署的字节码不同。</li><li id="8bfc" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd lr lj lk ll dt translated">还要注意，库在部署时会修改它们的运行时字节码，以防止常规调用。</li><li id="6c6d" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd lr lj lk ll dt translated">与<code class="eh ls lt lu kk b">.creationCode</code>相同的限制也适用于该属性。</li></ul><p id="4059" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">由于上述原因，我目前无法在polyscan上验证create2变形合同。在下一篇文章中，我会分解</p><p id="3e23" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">“5860208158601 c 335 a 63 AAF 10 f 428752 fa 158151803 b 80938091923 cf 3”这段字节码在evm playground为了更好的上下文。</p><blockquote class="lv lw lx"><p id="6a7c" class="ji jj ly jk b jl jm iu jn jo jp ix jq lz js jt ju ma jw jx jy mb ka kb kc kd hm dt translated">交易新手？尝试<a class="ae ke" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">加密交易机器人</a>或<a class="ae ke" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">复制交易</a></p></blockquote><p id="811f" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">为了深入了解，请前往https://github.com/0age/metamorphic</p><p id="a2fa" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">变形合同工作的详细分类在这个回购中，我将发布下一篇打破这个回购的文章。(PS →是好评回购)</p><p id="8d28" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">阅读更多关于此主题的好文章:</p><ol class=""><li id="5c7b" class="ld le ht jk b jl jm jo jp jr lf jv lg jz lh kd li lj lk ll dt translated"><a class="ae ke" rel="noopener" href="/@jason.carver/defend-against-wild-magic-in-the-next-ethereum-upgrade-b008247839d2">https://medium . com/@ Jason . carver/defend-against-wild-magic-in-the-next-ether eum-upgrade-b 008247839 D2</a>。</li><li id="fa65" class="ld le ht jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll dt translated"><a class="ae ke" rel="noopener" href="/zeppelin-blog/the-promise-and-the-peril-of-metamorphic-contracts-9eb8b8413c5e">https://medium . com/zeppelin-blog/the-promise-and-the-margin-of-derivative-contracts-9e b8 b 8413 C5 e</a>。</li></ol></div></div>    
</body>
</html>