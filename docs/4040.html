<html>
<head>
<title>Building a crypto application using Polars (part 1): Retrieving historical data from Binance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Polars构建加密应用程序(第1部分):从币安检索历史数据</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/building-a-crypto-application-using-polars-part-1-retrieving-historical-data-from-binance-8b657b1e5cc1?source=collection_archive---------4-----------------------#2022-09-22">https://medium.com/coinmonks/building-a-crypto-application-using-polars-part-1-retrieving-historical-data-from-binance-8b657b1e5cc1?source=collection_archive---------4-----------------------#2022-09-22</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/cbe240e6d9f026ec916742b4a45f619a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*crmBmr5sXOkj44ZNzZY2fw.jpeg"/></div></div></figure><p id="b989" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在这个多篇文章系列中，我们将构建一个加密应用程序，它能够从不同的交换中检索数据，在这些数据的基础上实现一些技术指标，甚至可能在云中部署解决方案。</p><p id="20c3" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这个系列的灵感是基于我对这个领域的兴趣，以及可以在<a class="ae kb" rel="noopener" href="/swlh/retrieving-full-historical-data-for-every-cryptocurrency-on-binance-bitmex-using-the-python-apis-27b47fd8137f">这里</a>找到的<a class="jz ka gr" href="https://medium.com/u/93675cf59306?source=post_page-----8b657b1e5cc1--------------------------------" rel="noopener" target="_blank">彼得·尼斯特鲁普</a>的博客。在他的文章中，数据是从币安和Bitmex用熊猫在一个笔记本上检索的。尽管这样工作，我想通过使用<a class="ae kb" href="https://github.com/pola-rs/polars" rel="noopener ugc nofollow" target="_blank"> Polars </a>让它更健壮，更适合生产，尤其是更快。使用这个库，我能够显著提高应用程序的速度，这是至关重要的，因为当你实时交易时，每一毫秒都很重要。因此，这些帖子的主要焦点将集中在Polars的使用上，而其余的代码可以在资源库中找到。</p></div><div class="ab cl kc kd hb ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hm hn ho hp hq"><h2 id="5b60" class="kj kk ht bd kl km kn ko kp kq kr ks kt jm ku kv kw jq kx ky kz ju la lb lc ld dt translated">先决条件</h2><p id="b001" class="pw-post-body-paragraph jb jc ht jd b je le jg jh ji lf jk jl jm lg jo jp jq lh js jt ju li jw jx jy hm dt translated">为了从交易所获取数据，你需要一个币安账户。你可以通过<a class="ae kb" href="https://accounts.binance.com/en/register?ref=TFYZGJ88" rel="noopener ugc nofollow" target="_blank">这个</a>链接注册。按照这个教程，你不需要购买任何东西或者花任何钱。</p><p id="898c" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">对于一个有效的币安帐户，我们需要创建一个API密钥，以允许应用程序使用您的帐户从交换中读取加密数据。确保只给API密匙读的权限，这样，如果你的密匙以某种方式暴露，就不能用它购买任何东西。<a class="ae kb" href="https://www.binance.com/en/support/faq/360002502072" rel="noopener ugc nofollow" target="_blank">在这里</a>你可以找到如何创建API密匙。</p><p id="e8dd" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我添加了一个requirements.txt文件，其中包含运行代码所需的所有python库。您可以通过在虚拟环境中运行以下代码来快速安装:</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="0d6d" class="kj kk ht lo b fv ls lt l lu lv">pip install -r requirements.txt</span></pre><p id="e715" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">完成后，我们就可以开始编码了！</p></div><div class="ab cl kc kd hb ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hm hn ho hp hq"><p id="f08f" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在这第一部分中，我们将集中于从币安检索所有的BTC对并将它们写入磁盘。这篇文章中使用的代码可以在<a class="ae kb" href="https://github.com/romanovacca/polars-crypto-application-part-1" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="4b05" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">回购的结构如下所示:</p><figure class="lj lk ll lm fq iu fe ff paragraph-image"><div class="fe ff lw"><img src="../Images/83c50b4fa18c66aba1fd6d77b6c2fdc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1060/format:webp/1*Xx6SOZzVCrCn3IoLkNv97A.png"/></div><figcaption class="lx ly fg fe ff lz ma bd b be z ek">structure of the <a class="ae kb" href="https://github.com/romanovacca/polars-crypto-application-part-1" rel="noopener ugc nofollow" target="_blank">repository</a> used</figcaption></figure><p id="a5e0" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这里最重要的两个文件是:</p><ul class=""><li id="7a03" class="mb mc ht jd b je jf ji jj jm md jq me ju mf jy mg mh mi mj dt translated">main.py</li><li id="a7c5" class="mb mc ht jd b je mk ji ml jm mm jq mn ju mo jy mg mh mi mj dt translated">订单簿. py</li></ul><p id="9360" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我们还需要使用币安API密钥。为此，我们使用一个名为“config.ini”的配置文件，可以在本地存储凭证。我们使用的方法不是最安全的，不推荐在生产环境中使用，但是对于一个简单的本地帖子来说，这很好。</p><h2 id="6139" class="kj kk ht bd kl km kn ko kp kq kr ks kt jm ku kv kw jq kx ky kz ju la lb lc ld dt translated">config.ini</h2><figure class="lj lk ll lm fq iu"><div class="bz el l di"><div class="mp mq l"/></div></figure><h2 id="fa8e" class="kj kk ht bd kl km kn ko kp kq kr ks kt jm ku kv kw jq kx ky kz ju la lb lc ld dt translated">main.py</h2><figure class="lj lk ll lm fq iu"><div class="bz el l di"><div class="mp mq l"/></div></figure><p id="7803" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在我们已经完成了设置，我们将创建一个orderbook类，它将包含连接到交换机、获取数据、处理数据并将其写入磁盘的代码。这个想法是，这个订单簿可以处理多个不同的交换，但这是未来的帖子。</p><h2 id="6927" class="kj kk ht bd kl km kn ko kp kq kr ks kt jm ku kv kw jq kx ky kz ju la lb lc ld dt translated">阿辛西奥</h2><p id="c93e" class="pw-post-body-paragraph jb jc ht jd b je le jg jh ji lf jk jl jm lg jo jp jq lh js jt ju li jw jx jy hm dt translated">因为我们将多次调用api，所以我们必须考虑速率限制。您从币安请求的数据越多，他们系统上的请求就越“沉重”。币安的速率限制值是每分钟1500。例如，请求BTC/ETH对最后一天的数据可能花费3英镑，而检索2022年全年的数据可能花费30英镑。</p><p id="f344" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">为了提高api调用的速度，我们使用<a class="ae kb" href="https://docs.python.org/3/library/asyncio.html" rel="noopener ugc nofollow" target="_blank"> Asyncio </a>来同时进行调用和从API获取数据。接下来，我们实施了一项预防措施，以确保我们不会超过速率限制。</p><p id="9d89" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这是这篇文章最终的main.py的样子。</p><figure class="lj lk ll lm fq iu"><div class="bz el l di"><div class="mp mq l"/></div></figure><p id="087c" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我们创建一个名为main的异步函数，它是应用程序的入口点。我们初始化orderbook，并传递我们想要检索数据的基本符号的值。传递“BTC”将意味着我们将检索与BTC配对的所有数百枚硬币的数据，如“ETH/BTC”、“XRP/BTC”等。此外，我们定义了检索数据的时间范围，在本例中是每小时。</p><p id="9249" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">下一步是创建将调用币安API的客户端。我们显式地等待，直到一个客户端被返回，否则我们不能获得任何信息。这里我们传递存储在配置文件中的凭证。</p><figure class="lj lk ll lm fq iu"><div class="bz el l di"><div class="mp mq l"/></div></figure><p id="c229" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在在“get_orderbook”函数中，大部分逻辑已经存在。解释那里的一切可以形成一个完整的独立帖子。我相信更有趣的功能将出现在下一部分，在这里我们将实际处理检索到的数据。因此，我将跳过代码中使用Polars处理数据的部分。</p></div><div class="ab cl kc kd hb ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hm hn ho hp hq"><h2 id="81ef" class="kj kk ht bd kl km kn ko kp kq kr ks kt jm ku kv kw jq kx ky kz ju la lb lc ld dt translated"><strong class="ak">使用polars </strong></h2><figure class="lj lk ll lm fq iu"><div class="bz el l di"><div class="mp mq l"/></div></figure><p id="0976" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在上面的要点中，我们使用“_get_klines_data”从api中检索数据。在前一步骤中，已经为特定符号确定了最早存储的数据点和最新可用的数据点。接下来，我们创建一个polars数据帧，传入数据和列名。</p><p id="ddec" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">使用<a class="ae kb" href="https://pola-rs.github.io/polars-book/user-guide/dsl/intro.html#:~:text=Polars%20expressions%20are%20a%20mapping,to%20method%20chaining%20in%20Pandas%20)." rel="noopener ugc nofollow" target="_blank"> Polars表达式API </a>的一个好处是，在一次选择中，我们可以执行不同的动作。我们不仅将所有列转换为正确的类型，还能够创建一个新列。列的原因是在数据集内，我们想要存储硬币的名称。当我们稍后将所有不同的数据集组合在一起并使用该列作为过滤器时，这很有用。</p><figure class="lj lk ll lm fq iu"><div class="bz el l di"><div class="mp mq l"/></div></figure><p id="9e79" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">下一步是实际写入我们刚刚检索到的数据。为了做到这一点，我们首先必须检查我们是否已经存储了一些数据。如果是这种情况，我们需要追加数据，我们应该排除头部。将两个数据帧附加在一起的方法可以通过使用polars中的“vstack”来实现。</p><p id="b365" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这个项目选择polars的原因之一是，在Polars中读写csv比熊猫快得多。让我给你看一个例子:</p><h2 id="1ebf" class="kj kk ht bd kl km kn ko kp kq kr ks kt jm ku kv kw jq kx ky kz ju la lb lc ld dt translated">熊猫</h2><figure class="lj lk ll lm fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mr"><img src="../Images/f11e669ab2b448c42a1752ff75f61785.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WG4D38p6fUuqTD7XsHHIbA.png"/></div></div><figcaption class="lx ly fg fe ff lz ma bd b be z ek">Pandas speed reading and writing</figcaption></figure><h2 id="b6f8" class="kj kk ht bd kl km kn ko kp kq kr ks kt jm ku kv kw jq kx ky kz ju la lb lc ld dt translated">极地</h2><figure class="lj lk ll lm fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff ms"><img src="../Images/0c7d2289a7ff7a7a5148548b3d80b114.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BOFuabLBqZiv4XzMp0vXFA.png"/></div></div><figcaption class="lx ly fg fe ff lz ma bd b be z ek">Polars speed reading and writing</figcaption></figure><p id="95b2" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">关于这个测试的数据量的一些上下文:</p><ul class=""><li id="4493" class="mb mc ht jd b je jf ji jj jm md jq me ju mf jy mg mh mi mj dt translated">2020年1月1日至2022年9月21日的数据</li><li id="8a15" class="mb mc ht jd b je mk ji ml jm mm jq mn ju mo jy mg mh mi mj dt translated">行数:23848</li><li id="6304" class="mb mc ht jd b je mk ji ml jm mm jq mn ju mo jy mg mh mi mj dt translated">文件大小:3.1 MB</li></ul><p id="f0d5" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">虽然极地熊读取数据的速度大约是熊猫的1.5倍，但我们看到的最大区别是书写。用极坐标书写比用熊猫写字快16倍。速度提升现在可能看起来不那么令人印象深刻，但如果你考虑到这只是针对1个特定硬币的2.5年的每小时数据的事实，想象一下如果你在更长的时间内这样做，并且针对币安上所有的+- 400 BTC对，性能会有所提高。</p><h1 id="2025" class="mt kk ht bd kl mu mv mw kp mx my mz kt na nb nc kw nd ne nf kz ng nh ni lc nj dt translated"><strong class="ak">结论</strong></h1><p id="0e9c" class="pw-post-body-paragraph jb jc ht jd b je le jg jh ji lf jk jl jm lg jo jp jq lh js jt ju li jw jx jy hm dt translated">本系列的第一部分主要是设置和获取我们将在下一系列中使用的数据。通过这篇文章中的代码，可以用4行代码从币安交易所获取所有数据。</p><p id="34e6" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在第二篇文章中，我们将使用Polars实现一些技术指标。</p><p id="426d" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">一旦第二部分完成，我会在这里添加帖子的链接。</p><h2 id="7904" class="kj kk ht bd kl km kn ko kp kq kr ks kt jm ku kv kw jq kx ky kz ju la lb lc ld dt translated">资源</h2><p id="802c" class="pw-post-body-paragraph jb jc ht jd b je le jg jh ji lf jk jl jm lg jo jp jq lh js jt ju li jw jx jy hm dt translated">官方git回购Polars:【https://github.com/pola-rs/polars T4】</p><p id="c83c" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">Polars post入门:<a class="ae kb" rel="noopener" href="/analytics-vidhya/introduction-to-polars-ee9e638dc163">https://medium . com/analytics-vid hya/introduction-to-Polars-ee9e 638 DC 163</a></p><p id="2bb0" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">Git回购本贴代码:<a class="ae kb" href="https://github.com/romanovacca/polars-crypto-application" rel="noopener ugc nofollow" target="_blank">https://github.com/romanovacca/polars-crypto-application</a></p></div><div class="ab cl kc kd hb ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hm hn ho hp hq"><p id="7c91" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">本系列的第二部分可以在这里找到:<a class="ae kb" rel="noopener" href="/@romanovacca/building-a-crypto-application-using-polars-part-2-creating-technical-indicators-to-predict-50b263ab65e8">创造技术指标来预测未来的价格走势</a></p><blockquote class="nk"><p id="8bb6" class="nl nm ht bd nn no np nq nr ns nt jy ek translated">交易新手？试试<a class="ae kb" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">密码交易机器人</a>或者<a class="ae kb" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">复制交易</a></p></blockquote></div></div>    
</body>
</html>