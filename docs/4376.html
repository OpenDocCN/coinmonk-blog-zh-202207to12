<html>
<head>
<title>Beginner's guide to Transparent proxy pattern</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">透明代理模式初学者指南</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/beginners-guide-to-transparent-proxy-pattern-f40d6085bf3c?source=collection_archive---------4-----------------------#2022-09-30">https://medium.com/coinmonks/beginners-guide-to-transparent-proxy-pattern-f40d6085bf3c?source=collection_archive---------4-----------------------#2022-09-30</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/86e41b8407c7e766da98453b1824535b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mz5aj9ZGDm2FSr0HV_aPLA.jpeg"/></div></div></figure><p id="c633" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在我们开始之前，应该注意到已经有许多关于这个主题的文章发表了。然而，我还没有遇到任何对初学者来说容易理解的教程或任何关于如何部署可升级合同的详细说明。</p><p id="b327" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这就是我们今天要学习的内容。</p><h1 id="de25" class="jz ka ht bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw dt translated">什么是代理模式？</h1><p id="bfc4" class="pw-post-body-paragraph jb jc ht jd b je kx jg jh ji ky jk jl jm kz jo jp jq la js jt ju lb jw jx jy hm dt translated">代理是一种设计模式，允许您为另一个对象提供替代或占位符。代理控制对原始对象的访问，允许您在请求到达原始对象之前或之后执行某些操作。</p><h1 id="d4d2" class="jz ka ht bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw dt translated">为什么我们要使用代理模式？</h1><p id="4bf0" class="pw-post-body-paragraph jb jc ht jd b je kx jg jh ji ky jk jl jm kz jo jp jq la js jt ju lb jw jx jy hm dt translated">在区块链世界，写在区块链上的任何东西都不能被编辑或操纵。如果开发人员在智能合约开发期间犯了任何错误，那么宝贵的资金就容易受到攻击。为了防止这些错误，使用代理契约，如果在实现契约上发现任何问题，则将部署新的实现契约。</p><h1 id="7fe7" class="jz ka ht bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw dt translated">代理模式的类型:</h1><p id="8f3f" class="pw-post-body-paragraph jb jc ht jd b je kx jg jh ji ky jk jl jm kz jo jp jq la js jt ju lb jw jx jy hm dt translated">有几种类型的代理模式可用。他们是</p><p id="072e" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">1)透明代理模式</p><p id="eebd" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">2)通用可升级代理标准(UUPS)模式</p><p id="0389" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">3)信标模式</p><p id="13ab" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">但是今天我们将只看到透明代理模式</p><figure class="ld le lf lg fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff lc"><img src="../Images/56d158070318c2ee4f216ed11984d5e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LuFLjmFi6Bybv_m1vjVYhg.jpeg"/></div></div></figure><h1 id="dda5" class="jz ka ht bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw dt translated">透明代理模式:</h1><p id="1b8d" class="pw-post-body-paragraph jb jc ht jd b je kx jg jh ji ky jk jl jm kz jo jp jq la js jt ju lb jw jx jy hm dt translated">透明代理模式由三个契约组成。</p><ul class=""><li id="0b63" class="lh li ht jd b je jf ji jj jm lj jq lk ju ll jy lm ln lo lp dt translated"><strong class="jd hu">代理合同。</strong>用户与之交互的智能合约。它将保存数据/状态，这意味着数据存储在该代理契约帐户的上下文中。</li><li id="dbc8" class="lh li ht jd b je lq ji lr jm ls jq lt ju lu jy lm ln lo lp dt translated"><strong class="jd hu">实施契约。</strong>智能合约提供了功能和逻辑。请注意，该数据也在本合同中定义。这是您正在构建的智能合约。</li><li id="b881" class="lh li ht jd b je lq ji lr jm ls jq lt ju lu jy lm ln lo lp dt translated"><strong class="jd hu">代理人合同。</strong>契约链接代理和实现。</li></ul><p id="9f75" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">让我们转向实际问题</p><h1 id="3b37" class="jz ka ht bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw dt translated">我们要做什么？</h1><p id="41ee" class="pw-post-body-paragraph jb jc ht jd b je kx jg jh ji ky jk jl jm kz jo jp jq la js jt ju lb jw jx jy hm dt translated">使用面向Hardhat的OpenZeppelin升级插件，我们将部署可升级的合同。</p><p id="7083" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">让我们从创建一个安全帽项目开始</p><blockquote class="lv lw lx"><p id="7b20" class="jb jc ly jd b je jf jg jh ji jj jk jl lz jn jo jp ma jr js jt mb jv jw jx jy hm dt translated">npm初始化-y</p><p id="e229" class="jb jc ly jd b je jf jg jh ji jj jk jl lz jn jo jp ma jr js jt mb jv jw jx jy hm dt translated">npm安装—保存-开发硬件</p><p id="4ac6" class="jb jc ly jd b je jf jg jh ji jj jk jl lz jn jo jp ma jr js jt mb jv jw jx jy hm dt translated">npx安全帽</p><p id="6a37" class="jb jc ly jd b je jf jg jh ji jj jk jl lz jn jo jp ma jr js jt mb jv jw jx jy hm dt translated">npm安装@ open zeppelin/hard hat-升级</p></blockquote><p id="548b" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">打开<strong class="jd hu"><em class="ly">hard hat . config . js</em></strong>并添加以下语句</p><blockquote class="lv lw lx"><p id="475d" class="jb jc ly jd b je jf jg jh ji jj jk jl lz jn jo jp ma jr js jt mb jv jw jx jy hm dt translated">require(" @ open zeppelin/hard hat-upgrades ")；</p></blockquote><p id="b275" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">接下来，我们将在合同文件夹中创建一个合同。在本例中，我们将使用Openzeppelin学习指南中的合同。你可以从这个<a class="ae mc" href="https://docs.openzeppelin.com/learn/developing-smart-contracts#setting-up-a-solidity-project" rel="noopener ugc nofollow" target="_blank">链接</a>得到代码。</p><figure class="ld le lf lg fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff md"><img src="../Images/1f581d7ad802c3d5a6b1642d08f39443.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0sK7DRsFFxnj9stCOY9tEA.png"/></div></div></figure><p id="c2ca" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">让我描述一下这个契约的作用。把这个合同想象成一个盒子。</p><figure class="ld le lf lg fq iu fe ff paragraph-image"><div class="fe ff me"><img src="../Images/18255d1cc68e6ecba632f6d0eed49d74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1212/format:webp/1*geqfDaRKo1HgMMxXO_W_3A.jpeg"/></div></figure><p id="c4ab" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在盒子里，我们可以存放一些物品，并且很容易找回它们。这里发生了同样的事情:使用store()函数存储一个新值，然后使用retrieve()函数检索它。</p><p id="2242" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在让我们部署合同。</p><p id="ea77" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">为了部署一个普通的契约，我们使用了<strong class="jd hu"> deploy() </strong>方法。</p><pre class="ld le lf lg fq mf mg mh mi aw mj dt"><span id="cb20" class="mk ka ht mg b fv ml mm l mn mo">const Greeter = await ethers.getContractFactory("Greeter");<br/>const greeter = await Greeter.deploy("Hello, Hardhat!");</span></pre><p id="72fc" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">但是对于可升级的契约，我们使用deployProxy()方法。</p><pre class="ld le lf lg fq mf mg mh mi aw mj dt"><span id="c6c8" class="mk ka ht mg b fv ml mm l mn mo">const Box = await ethers.getContractFactory("Box")<br/>const box = await upgrades.deployProxy(Box,[42],{initializer:'store' })<!-- --> </span></pre><p id="3d9e" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在第二行，我们使用OpenZeppelin <strong class="jd hu">升级</strong>插件，通过调用<code class="eh mp mq mr mg b">store()</code>作为<strong class="jd hu">初始化器</strong>来部署具有初始值<code class="eh mp mq mr mg b">42</code>的<code class="eh mp mq mr mg b">Box</code>。</p><h2 id="6bf0" class="mk ka ht bd kb ms mt mu kf mv mw mx kj jm my mz kn jq na nb kr ju nc nd kv ne dt translated">那么，什么是初始化式呢？</h2><p id="c850" class="pw-post-body-paragraph jb jc ht jd b je kx jg jh ji ky jk jl jm kz jo jp jq la js jt ju lb jw jx jy hm dt translated">初始化器是一个像构造函数一样工作的函数。它应该包含所有只需要初始化一次的值。</p><p id="821d" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在打开scripts文件夹，创建一个名为deploy.js的文件</p><figure class="ld le lf lg fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff nf"><img src="../Images/e00e223aa9ae8b61cec044732e16c335.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_gQ66x-HgYuTmFqappaHEQ.png"/></div></div></figure><p id="fb2d" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">您的部署脚本应该与上面的相同</p><p id="8389" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在上面的脚本中，我们使用deployProxy()方法部署契约。现在快跑</p><blockquote class="lv lw lx"><p id="425c" class="jb jc ly jd b je jf jg jh ji jj jk jl lz jn jo jp ma jr js jt mb jv jw jx jy hm dt translated">npx hard hat run scripts/deploy . js—网络本地主机</p></blockquote><p id="bd77" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">该命令成功后，将部署三个合同。</p><figure class="ld le lf lg fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff ng"><img src="../Images/bef8a44633f930380148a3048fce02a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tvnmwXU1zB5YLS8aQSMYiA.png"/></div></div></figure><blockquote class="lv lw lx"><p id="0f1b" class="jb jc ly jd b je jf jg jh ji jj jk jl lz jn jo jp ma jr js jt mb jv jw jx jy hm dt translated"><strong class="jd hu">重要提示:</strong>需要注意的是，在测试时，您应该在本地主机或任何测试网络中部署契约，因为hardhat的本地区块链每次都会被重置。因此，如果您尝试升级您的合同，它将在新的区块链上部署它，我们的旧部署代码将不在那里，它将是一个新的区块链，因此它将抛出以下错误。</p><p id="0f74" class="jb jc ly jd b je jf jg jh ji jj jk jl lz jn jo jp ma jr js jt mb jv jw jx jy hm dt translated">错误:0xabcde12345处的协定看起来不像具有逻辑协定地址的ERC 1967代理</p></blockquote><h2 id="517a" class="mk ka ht bd kb ms mt mu kf mv mw mx kj jm my mz kn jq na nb kr ju nc nd kv ne dt translated">升级到版本2:</h2><p id="cac1" class="pw-post-body-paragraph jb jc ht jd b je kx jg jh ji ky jk jl jm kz jo jp jq la js jt ju lb jw jx jy hm dt translated">现在让我们制作合同的第二版。</p><p id="0858" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">创建一个继承箱式合同的新合同。在这个契约中，我们创建了一个名为increment()的新函数。该函数的目的是增加存储在value变量中的值。</p><figure class="ld le lf lg fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff nh"><img src="../Images/cd6b4d06e2e43bec50432be55570aa56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bveL45C9NcHXHIKHjJDHgQ.png"/></div></div></figure><p id="3767" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在，在scripts/文件夹中为版本2创建另一个部署脚本。</p><figure class="ld le lf lg fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff nf"><img src="../Images/1bcc523c97e4e04aced0572ccf2bf6da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J1ekmWGFbFRlzUieauR0DQ.png"/></div></div></figure><p id="15d6" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在上面的脚本中，我们使用了upgradeProxy()方法，该方法接受proxyAddress和新的实现契约地址作为参数。</p><p id="2bd7" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在快跑，</p><blockquote class="lv lw lx"><p id="1883" class="jb jc ly jd b je jf jg jh ji jj jk jl lz jn jo jp ma jr js jt mb jv jw jx jy hm dt translated">npx hardhat运行脚本/deployV2.js —网络本地主机</p></blockquote><figure class="ld le lf lg fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff ni"><img src="../Images/8b6688a2ac5d631e726336db93155159.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kPEqL8nxFJkAYw6zKNSQmw.png"/></div></div></figure><p id="d2a7" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">就是这样。这是我们部署和升级合同的方式。</p><p id="f6e7" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">现在，如果您查看实施地址，它将会发生变化，这意味着我们已经成功部署了新合同，现在我们可以与新合同进行交互了。</p><blockquote class="nj"><p id="8da3" class="nk nl ht bd nm nn no np nq nr ns jy ek translated">交易新手？尝试<a class="ae mc" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">加密交易机器人</a>或<a class="ae mc" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">复制交易</a></p></blockquote></div></div>    
</body>
</html>