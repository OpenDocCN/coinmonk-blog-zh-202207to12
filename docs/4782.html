<html>
<head>
<title>Diving into UniSwap</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">潜入UniSwap</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/otemadiving-into-uniswap-3354e26469ee?source=collection_archive---------4-----------------------#2022-10-10">https://medium.com/coinmonks/otemadiving-into-uniswap-3354e26469ee?source=collection_archive---------4-----------------------#2022-10-10</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/56003a2295d44e36528891d3b91e516b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N7BQXxw5H3SsdlOYUG7oZQ.png"/></div></div></figure><p id="9227" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在你阅读之前，你应该看完这个视频并完全理解他们所说的一切— <strong class="jd hu"> </strong> <a class="ae jz" href="https://youtu.be/Ehm-OYBmlPM" rel="noopener ugc nofollow" target="_blank"> <strong class="jd hu">链接</strong> </a> <br/>我们将与这个资源库— <strong class="jd hu"> </strong> <a class="ae jz" href="https://github.com/Uniswap/v3-core/tree/main/contracts" rel="noopener ugc nofollow" target="_blank"> <strong class="jd hu">链接</strong> </a> <br/>并且你需要尽可能多地按下<strong class="jd hu"/><a class="ae jz" href="https://app.uniswap.org/#/swap?chain=mainnet" rel="noopener ugc nofollow" target="_blank"><strong class="jd hu">unis WAP</strong></a>本身的按钮。<br/>这里是UniSwap的奖金文档— <strong class="jd hu"> </strong> <a class="ae jz" href="https://uniswap.org/whitepaper-v3.pdf" rel="noopener ugc nofollow" target="_blank"> <strong class="jd hu">链接</strong> </a></p><figure class="kb kc kd ke fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff ka"><img src="../Images/8e0685637c9898e5af42082f44023a95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_vLbJi2Dh4k7n_8shSQh1Q.png"/></div></div><figcaption class="kf kg fg fe ff kh ki bd b be z ek">This mini-scheme may be needed throughout the article to understand what we are doing in general</figcaption></figure><blockquote class="kj kk kl"><p id="73cc" class="jb jc km jd b je jf jg jh ji jj jk jl kn jn jo jp ko jr js jt kp jv jw jx jy hm dt translated">P.S. <br/>本文仅作为对uniswap v3 githab代码的回顾而撰写，所有内容都是与对该技术本身的研究并行编写的，因此可能会有一些不准确和粗鲁之处</p></blockquote><h1 id="fa2c" class="kq kr ht bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln dt translated">工厂</h1><p id="c6b9" class="pw-post-body-paragraph jb jc ht jd b je lo jg jh ji lp jk jl jm lq jo jp jq lr js jt ju ls jw jx jy hm dt translated">池是在这里创建的</p><figure class="kb kc kd ke fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff lt"><img src="../Images/b657e751a3086f7f5b737c2da7c5ed36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BQmDm9QM_qJnOEK1fRgSrw.png"/></div></div></figure><p id="766e" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在这里，我们得到了两个硬币的合同，这两个硬币之间将形成一对，以及将在这一对中设置的佣金。该函数返回我们形成的新地址池的地址</p><p id="4a8a" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这个函数做的第一件事是检查我们的令牌是否不同。<br/>然后计算具有较小地址的一个，并将较小的命名为token0，将较大的命名为token1 <br/>现在它检查token0是否不为零(token1显然不需要检查)<br/>我们将存储在费用地址<br/>的<strong class="jd hu"> feeAmountTickSpacing </strong>变量中的值分配给TickSpacing，检查tickSpacing是否不为零。<br/>检查没有包含我们的代币和佣金的池(3D array getPool使用给定的数据返回池地址)。<br/>调用<strong class="jd hu"> deploy </strong>函数，向其传递工厂地址、令牌、佣金和tickSpacing，然后将返回的数据(新的池地址)传递给池变量，然后将该变量传递给带有两个令牌位置的getPool数组，从而保存该变量，这样其他人就不能创建这样的池</p><h2 id="2921" class="lu kr ht bd ks lv lw lx kw ly lz ma la jm mb mc le jq md me li ju mf mg lm mh dt translated">feeAmountTickSpacing</h2><p id="f00d" class="pw-post-body-paragraph jb jc ht jd b je lo jg jh ji lp jk jl jm lq jo jp jq lr js jt ju ls jw jx jy hm dt translated">它存储分笔成交点之间的距离，对应于佣金的每个特定值(最初在构造函数中设置，但也可以有自定义距离，由合同所有者为佣金的每个值单独设置)。</p><h2 id="f9f1" class="lu kr ht bd ks lv lw lx kw ly lz ma la jm mb mc le jq md me li ju mf mg lm mh dt translated">部署</h2><figure class="kb kc kd ke fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mi"><img src="../Images/c8918852e50afae1e75b00c2134fd78e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YirEGIaKD8OORHeRkj2OvQ.png"/></div></div></figure><p id="51ef" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我们将工厂地址、令牌、佣金和tickSpacing传递给这个函数，输出是新池的地址。在函数本身中，我们创建结构参数，然后我们使用构造函数UniswapV3Pool创建一个新的契约，并将该契约的地址传递到变量Pool(我们返回该变量pool ),然后我们使用delete将参数返回到初始值，从而节省了时间</p><p id="62b8" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">滴答<br/> </strong>为了实现集中的流动性，曾经连续的价格区间被滴答分割</p><p id="50ed" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">分笔成交点是价格空间中区域之间的边界。分笔成交点的排列方式是，在价格空间的任何一点，增加或减少1个分笔成交点代表价格增加或减少0.01% (1个基点)</p><p id="8a98" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">分笔成交点是流动性头寸的边界。创建仓位时，供应商必须选择代表仓位边界的上下刻度</p><p id="7438" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">随着现货价格在互换期间发生变化，池合约将不断用流出资产交换流入资产，逐渐使用当前价格点间隔期间的所有可用流动性，直到到达下一个价格点。此时，合约切换到新的分笔成交点，并激活在新的活跃分笔成交点上有边界的头寸内的任何休眠流动性</p><p id="8e98" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">尽管每个池都有相同数量的基础分笔成交点，但实际上只有其中一些可以作为活动分笔成交点。由于v3智能合约的性质，分笔成交点之间的距离与互换佣金直接相关。佣金水平越低，潜在活跃分笔成交点越近，佣金水平越高，潜在活跃分笔成交点之间的间隔越大</p><p id="68ac" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">虽然在掉期交易中，非活跃分笔成交点对交易价值没有影响，但穿过活跃分笔成交点会增加交易的价值，因为穿过分笔成交点会激活以该分笔成交点为边界的任何新头寸的流动性</p><p id="97c3" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在资本效率至关重要的领域，如稳定的硬币对，较窄的分笔成交点距离增加了流动性供应的粒度，并可能减少互换期间对价格的影响，从而为稳定的硬币互换带来更好的价格。</p><h1 id="6556" class="kq kr ht bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln dt translated">泳池</h1><p id="d4be" class="pw-post-body-paragraph jb jc ht jd b je lo jg jh ji lp jk jl jm lq jo jp jq lr js jt ju ls jw jx jy hm dt translated">工厂创造了那个东西，但是它本身是由什么组成的呢？</p><blockquote class="kj kk kl"><p id="f81d" class="jb jc km jd b je jf jg jh ji jj jk jl kn jn jo jp ko jr js jt kp jv jw jx jy hm dt translated">重要提示:Pool是一个成熟的智能合约，Factory从输入变量创建一个成熟的智能合约</p></blockquote><p id="90af" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">头寸库存储每个特定头寸的所有信息，即在每个情况下将流动性存入池中。</p><p id="ca30" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">造币厂</strong></p><figure class="kb kc kd ke fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mj"><img src="../Images/8ef8f1bc1edfaf6d319e5d2aafc42e63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cPw2o_QKvQN8rrTH-w_IWA.png"/></div></div></figure><p id="d0ef" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">该功能负责向池中添加流动性</p><p id="6dee" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">我们给出以下一组变量作为输入:</strong></p><p id="29e6" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">recipient —我们要添加流动性的池的地址<br/>ticker lower—底部tick <br/> tickUpper —上部tick <br/> amount —我们要添加的流动性的数量<br/> data —要传递给回调的任何数据</p><p id="c9d9" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在这个函数的输出端，我们得到:</p><p id="d257" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">amount0 —为增加此数量的<br/>流动性而支付的token0的数量。对应于回调<br/> amount1中的值——为添加此数量的<br/>流动性而支付的token1的数量。对应于回调中的值</p><p id="d79f" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">这个功能是做什么的？</strong></p><p id="45cf" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">检查我们是否至少添加了一些流动性并且不是零<br/>之后，我们定义要添加的令牌的比例(这是在<strong class="jd hu"><em class="km">_ modify position</em></strong>函数中完成的，而<strong class="jd hu"><em class="km">modify position params</em></strong>需要调整到必要的数据类型)<br/>之后，我们将从<strong class="jd hu"><em class="km">_ modify position</em></strong>中获得的值赋给那些我们想要的主<strong class="jd hu"> 【T22</strong></p><h2 id="0f4e" class="lu kr ht bd ks lv lw lx kw ly lz ma la jm mb mc le jq md me li ju mf mg lm mh dt translated">_modifyPosition。</h2><p id="9bdd" class="pw-post-body-paragraph jb jc ht jd b je lo jg jh ji lp jk jl jm lq jo jp jq lr js jt ju ls jw jx jy hm dt translated">这个函数计算我们需要添加到池中的硬币的比例</p><figure class="kb kc kd ke fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mk"><img src="../Images/431d426e41263be3b8eba8add07b2836.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xrcGGM4ePhbz-ImmcHIQbw.png"/></div></div></figure><figure class="kb kc kd ke fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff ml"><img src="../Images/cd872bf4d154ca91aa988f826ba739c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RWU_oJuJH9Q19SHB5jU4Mg.png"/></div></div></figure><p id="1141" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在这个函数的输入端，我们给出了结构ModifyPositionParams，输出端给出了位置，数量0和数量1</p><p id="bd5b" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">该功能的作用:</strong></p><p id="1e28" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">检查滴答是否在允许的范围内<br/>创建一个Slot0类型的局部变量_Slot0以节省气体<br/>将变量position分配给_updatePosition函数的输出<br/>检查液体性是否有变化δ:</p><blockquote class="kj kk kl"><p id="9baa" class="jb jc km jd b je jf jg jh ji jj jk jl kn jn jo jp ko jr js jt kp jv jw jx jy hm dt translated">比较当前分笔成交点和设定分笔成交点的界限，如果当前分笔成交点低于我们的分笔成交点界限，那么我们提供更多的令牌0，因为它变得更有价值当前分笔成交点在我们的分笔成交点界限内，那么我们提供等量的硬币当前分笔成交点高于我们的分笔成交点界限，那么我们提供更多的令牌1，因为它变得更有价值</p></blockquote><h2 id="451d" class="lu kr ht bd ks lv lw lx kw ly lz ma la jm mb mc le jq md me li ju mf mg lm mh dt translated">_更新位置</h2><p id="7825" class="pw-post-body-paragraph jb jc ht jd b je lo jg jh ji lp jk jl jm lq jo jp jq lr js jt ju ls jw jx jy hm dt translated">根据输入数据，它返回以下结构:</p><figure class="kb kc kd ke fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mm"><img src="../Images/50745253bce86ffa5ae86ba6ae51d51f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H7b3MxzUIgMUYSwIBWsuGw.png"/></div></div></figure><h2 id="5be3" class="lu kr ht bd ks lv lw lx kw ly lz ma la jm mb mc le jq md me li ju mf mg lm mh dt translated">插槽0</h2><figure class="kb kc kd ke fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mn"><img src="../Images/9784f9c971f1f9a131bef78f12eb1cdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VWi1ejYx3w0ECtLl22_njA.png"/></div></div></figure><h2 id="94be" class="lu kr ht bd ks lv lw lx kw ly lz ma la jm mb mc le jq md me li ju mf mg lm mh dt translated">修改位置参数</h2><figure class="kb kc kd ke fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mo"><img src="../Images/d4e1b3c895bcf66b60edd626045e8a3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yJe3Q2r1u1ambnvMwley-w.png"/></div></div></figure><h2 id="2272" class="lu kr ht bd ks lv lw lx kw ly lz ma la jm mb mc le jq md me li ju mf mg lm mh dt translated">收集</h2><p id="89c0" class="pw-post-body-paragraph jb jc ht jd b je lo jg jh ji lp jk jl jm lq jo jp jq lr js jt ju ls jw jx jy hm dt translated">此功能允许我们从资金池中提取佣金</p><figure class="kb kc kd ke fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mp"><img src="../Images/73520a671f04d916060329e9ccd67d77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EmrsJMFIYBR6v3-c8vr5oQ.png"/></div></div></figure><p id="5b02" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">我们给出以下一组变量作为输入:</strong></p><p id="aaef" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">收款人—我们将从中提取酒的池地址<br/> tickLower —底部tick <br/> tickUpper —上部tick <br/> amount0Requested —应该从<br/>commissions<br/>amount 1 requested—应该从commissions中提取多少token1</p><p id="83d4" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">在函数的输出中，我们得到了:</strong></p><p id="e964" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">amount 0—token 0<br/>中收取的佣金金额amount 1—token 1中收取的佣金金额</p><p id="9755" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">功能是做什么的？</strong></p><p id="64ab" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">首先我们得到发件人的初始位置和上下勾号<br/>,然后我们得到可以从每对硬币中提取的酒的数量(基于佣金)<br/>最后我们减去我们从总位置中提取的硬币</p><h1 id="9ab8" class="kq kr ht bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln dt translated">互换</h1><p id="b44b" class="pw-post-body-paragraph jb jc ht jd b je lo jg jh ji lp jk jl jm lq jo jp jq lr js jt ju ls jw jx jy hm dt translated">这个功能允许我们兑换硬币</p><figure class="kb kc kd ke fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mq"><img src="../Images/bfe6ecfd4a946f0a38dd333721fc1063.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LVXWHus3TGiGlSL05NhLrQ.png"/></div></div></figure><figure class="kb kc kd ke fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mr"><img src="../Images/f61d6a9269e9954361230c8e4e8bc661.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G0oHDM0DNKn1Veq4oBk15Q.png"/></div></div></figure><figure class="kb kc kd ke fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff ms"><img src="../Images/326538c10f32521fb4eb75bc1a621f50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6ZDXlULutInT2V13wlzPkQ.png"/></div></div></figure><figure class="kb kc kd ke fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mt"><img src="../Images/a24c06bc6beb6a14fd2aba3e493852fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AuckLxkgTzNBqTRfYLUQ5A.png"/></div></div></figure><figure class="kb kc kd ke fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mq"><img src="../Images/69c114628af1ad733ba337e21de7d118.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z4OSbKP5UUjJenIiiXAzmA.png"/></div></div></figure><figure class="kb kc kd ke fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mu"><img src="../Images/66dba5a59c6234518182105ca170e65b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HegBnglVUBJBCrQccdHdJw.png"/></div></div></figure><p id="80a8" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">我们给出以下一组变量作为输入:</strong></p><p id="db55" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">recipient —接收互换资金的地址<br/> zeroForOne —互换的方向，对于token0 - &gt; token1为true，对于token 1-&gt;token 0<br/>Amount specified—互换的金额，它隐式地将互换设置为精确输入(正)或精确输出(负)。<br/>sqrtpricelimitx 96——q 64.96(一个用逗号精确定义的数，其中64位负责整数部分，96位负责小数部分)sqrt的价格限制。如果零对一，交换后价格不能低于该值。如果1代表0，交换数据后价格不能大于该值——任何应该传递给回调的数据</p><p id="e361" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">该函数的输出为:</strong></p><p id="5083" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">amount0 —令牌0池的增量余额，负值时精确，正值时最小<br/> amount1 —令牌1池余额的增量，负值时精确，正值时最小</p><p id="7600" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">该功能是做什么的？</strong></p><p id="83c0" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">检查交换是否不为零<br/>创建一个本地变量slot0Start like slot0，将slot0传递给它，并检查池是否处于活动状态<br/>检查交换将发生在哪个方向(token0 - &gt; token1或token1 - &gt; token0) <br/>在slot0结构中，在“unlocked”字段中写入false，以在交换期间阻塞池<br/>创建一个SwapCache类型的缓存变量，并将该对的流动性传递给它， 块的时间戳，输入硬币的coms，也将tickCumulatives(从块的时间戳开始每秒的总滴答数)和secondsPerLiquidityCumulativeX128s(从块的时间戳开始每秒的范围内每单位流动性的总秒数)清零，最后我们将false赋给computedLatestObservation(如果我们能够计算以上两个值，则为true， false otherwise) <br/>现在，我们最终将我们想要交换的硬币分配给exact put<br/>我们创建了一个SwapState类型的变量state，并为其提供我们的交换量、我们已经交换了多少(因此为0)、货币对的当前价格、分笔成交点价格、输入令牌的kmsa、我们支付的输入令牌的数量kmsa(最初设置为0)、此时分笔成交点中的流动性</p><blockquote class="kj kk kl"><p id="2433" class="jb jc km jd b je jf jg jh ji jj jk jl kn jn jo jp ko jr js jt kp jv jw jx jy hm dt translated">现在我们开始进行条件交换，直到我们已经交换了全部数量<br/>初始化类型为<strong class="jd hu">的空步长结构步长计算<br/> </strong>将值从sqrtPriceX96字段的状态传递到<strong class="jd hu"> sqrtPriceStartX96 </strong>字段的步长变量<br/>之后调用tickBitmap库的<strong class="jd hu">nextinitializetickwithoneword</strong>函数，并将值state.tick(当前tick)、tick spacing(tick之间的距离)、<strong class="jd hu"> zeroForOne 【T10 它返回两个值——下一个分笔成交点和是否已初始化<br/>我们确保不超过最小/最大分笔成交点，因为位图分笔成交点不知道限制，并将结果(下一个分笔成交点)传递到分笔成交点下一个字段<br/>中的步骤结构中，然后我们将下一个分笔成交点的价格分配给sqrtPriceNextX96字段中的步骤结构<br/>计算传递到目标分笔成交点、价格限制或I/O量耗尽点的值，所有这些都通过此<a class="ae jz" href="https://github.com/Uniswap/v3-core/blob/main/contracts/libraries/SwapMath.sol" rel="noopener ugc nofollow" target="_blank">完成 在输出中，我们获得4个值，并将它们写入state.sqrtPriceX96(货币对中的当前价格)、step.amountIn(在此步骤中进行的交换量)、step.amountOut(在此步骤中进行的交换量)、step.feeAmount(支付了多少钱)。最后，我们计算应该从哪个互换金额中减去池中的哪个menta，以及应该添加哪个menta。<br/>如果池中的comsa打开，我们计算comsa大小，减少step.feeAmount并增加state.protocolFee <br/>之后，我们通过调用<strong class="jd hu"> FullMath.mulDiv </strong>函数<br/>来更新池中的佣金。接下来是一个大块，这可以被描述为“如果我们到达下一个价格，则进行tick shift”</a></strong></p></blockquote><p id="0a32" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">然后，我们简单地更新分笔成交点，并记录来自oracle的结果(我认为会有一篇关于它的单独文章)，如果分笔成交点已经改变，否则我们简单地更新价格，使其等于state.sqrtPriceX96 <br/>之后，我们更新流动性，如果它已经改变<br/>现在我们改变硬币池中的佣金，这取决于我们进行互换的方式<br/>，最后，我们通过调用我们都知道的安全转移函数并改变池中的代币余额<br/>来完成转移本身，最后我们解锁池</p><h2 id="26f9" class="lu kr ht bd ks lv lw lx kw ly lz ma la jm mb mc le jq md me li ju mf mg lm mh dt translated"><strong class="ak">肚子疼</strong></h2><figure class="kb kc kd ke fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff lt"><img src="../Images/8034fb1e121059949c762faa90432661.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*07IJGhSQvAeJjLfdsAF1Cw.png"/></div></div></figure><h2 id="5ffd" class="lu kr ht bd ks lv lw lx kw ly lz ma la jm mb mc le jq md me li ju mf mg lm mh dt translated">交换状态</h2><figure class="kb kc kd ke fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mv"><img src="../Images/6ff4074fcbca0d803ae54d1c7e86dd57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7_nireZRCCzY5Evie8bwFA.png"/></div></div></figure><h2 id="0f11" class="lu kr ht bd ks lv lw lx kw ly lz ma la jm mb mc le jq md me li ju mf mg lm mh dt translated">分步计算</h2><figure class="kb kc kd ke fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mw"><img src="../Images/f3a724751426e540fea0375ba5db5364.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JZCHhZUSIRk6h-eAB9BMxg.png"/></div></div></figure><h2 id="b39e" class="lu kr ht bd ks lv lw lx kw ly lz ma la jm mb mc le jq md me li ju mf mg lm mh dt translated">tick bitmap . nextinitializedtickwithinoneword</h2><figure class="kb kc kd ke fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mx"><img src="../Images/08f6d80d683fd23410012047d2744919.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1HJdIG1hF9cSkNXwu-ByFQ.png"/></div></div></figure><p id="5496" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><em class="km">感谢阅读！我希望这篇文章是有趣和清晰的！</em></p><blockquote class="my"><p id="354b" class="mz na ht bd nb nc nd ne nf ng nh jy ek translated">交易新手？试试<a class="ae jz" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">加密交易机器人</a>或者<a class="ae jz" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">复制交易</a></p></blockquote></div></div>    
</body>
</html>