<html>
<head>
<title>Learn Solidity lesson 18. Global variables and the Umwelt.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">学习第18课坚固性。全局变量和Umwelt。</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/learn-solidity-lesson-18-global-variables-and-the-umwelt-efcf7336d2df?source=collection_archive---------6-----------------------#2022-08-08">https://medium.com/coinmonks/learn-solidity-lesson-18-global-variables-and-the-umwelt-efcf7336d2df?source=collection_archive---------6-----------------------#2022-08-08</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/24aede1e8921f841d561aeee4baaae71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tPpsjonXOFds5qTPLzGsYA.jpeg"/></div></div></figure><p id="b7ab" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">Umwelt是生物学家Thomas A. Sebeok创造的一个术语，意思是“生物周围的环境”。虽然它与区块链无关，但我真的很喜欢这个术语，在这节课中，我们将谈论EVM周围的环境。</p><p id="10c8" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">需要了解的区块链的一个特征是，它是一个封闭的、完全确定的环境。智能合同不能访问区块链的外部；例如，它不能访问API。它甚至不能生成随机数，这很容易理解为什么。</p><p id="8456" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">区块链包含一个状态变量数据库，这些变量会随着交易而变化。该数据库在所有网络节点上必须是相同的，并且一旦在网络上验证，每个节点就在本地执行所有事务。</p><p id="4d5d" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">如果可以与外部API进行交互，也许一个节点在执行事务时会记录一个结果，而另一个节点会记录另一个结果，因为在此期间API服务已经失败，不再可用。</p><p id="0865" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">让我们看一个新的例子，一个叫做薛定谔彩票的合同。这种合同有一个功能，接受一定数量的乙醚，并根据系统生成的一个假定的随机数，决定你是否中奖。</p><p id="b040" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">有人向契约提交了一个事务，该事务在被挖掘(或验证)后必须由网络中的所有节点执行。如果这个数字真的是随机的，那么每个节点都会产生一个不同的数字，所以对于某些节点来说，你会获奖，而对于其他节点来说，你不会获奖。你会成为薛定谔的富人。</p><p id="d324" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我希望这些争论足以让你意识到区块链需要自我约束。它无法与外部世界互动，因此需要将外部世界注入区块链。世界是通过全局变量来实现的。至少是一小部分。</p><h1 id="f5ab" class="ka kb ht bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">通过全局变量的块和事务信息</h1><p id="cfa0" class="pw-post-body-paragraph jb jc ht jd b je ky jg jh ji kz jk jl jm la jo jp jq lb js jt ju lc jw jx jy hm dt translated">契约能够访问关于其周围环境的一些信息；已执行事务的数据以及包含该事务的块。我们可以通过全局变量获得这些信息。</p><p id="f45c" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我们已经在<em class="jz"> msg.sender </em>属性中看到了这些变量之一，它返回调用该函数的地址。全局变量<em class="jz"> msg </em>有另一个常用属性<em class="jz"> msg.value </em>，返回事务中发送的<em class="jz"> wei </em>中的值。</p><p id="9ff8" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">下面是Solidity中最常用的全局变量和属性的简短列表。</p><ul class=""><li id="c74a" class="ld le ht jd b je jf ji jj jm lf jq lg ju lh jy li lj lk ll dt translated"><strong class="jd hu"> msg.sender. </strong>外部调用函数的地址。它不一定是发起交易的账户的地址。</li><li id="cc53" class="ld le ht jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated"><strong class="jd hu"> msg.value. </strong>交易中发送的金额，单位为魏。</li><li id="d300" class="ld le ht jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated"><strong class="jd hu"> block.number. </strong>包含交易的块号。</li><li id="1d76" class="ld le ht jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated"><strong class="jd hu">block . timestamp .</strong>Unix时间中的块日期，以秒为单位。是自1970年1月1日午夜以来的秒数。</li><li id="29ea" class="ld le ht jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated"><strong class="jd hu"> gasleft()。</strong>执行该功能时剩余的气体量。</li><li id="697b" class="ld le ht jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated"><strong class="jd hu"> tx.origin. </strong>发送原始交易的账户地址。</li></ul><h1 id="6281" class="ka kb ht bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">msg.sender和tx.origin的区别</h1><p id="9f24" class="pw-post-body-paragraph jb jc ht jd b je ky jg jh ji kz jk jl jm la jo jp jq lb js jt ju lc jw jx jy hm dt translated"><em class="jz"> msg.sender </em>和<em class="jz"> tx.origin </em>的区别可能很微妙，所以让我们进一步解释一下。契约中的函数可以调用其他契约中的函数。当他们这样做时，就创建了一个内部事务。</p><p id="b70b" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><em class="jz"> tx.origin </em>属性总是包含原始交易发送方的地址，因此它总是一个外部地址(EOA)。它永远不会是合同地址，因为合同从不启动交易。</p><p id="188d" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><em class="jz"> msg.sender </em>是从外部调用该函数的地址。如果该函数被某个契约通过内部事务调用，那么<em class="jz"> msg.sender </em>将返回调用该函数的契约的地址。</p><p id="2724" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">让我们在合同中看到这一点。</p><pre class="lr ls lt lu fq lv lw lx ly aw lz dt"><span id="c4a8" class="ma kb ht lw b fv mb mc l md me">pragma solidity ^0.8.7;</span><span id="d83d" class="ma kb ht lw b fv mf mc l md me">contract Transactions {</span><span id="5b23" class="ma kb ht lw b fv mf mc l md me">function directTx() public view returns(address, address) {<br/>        return (msg.sender, tx.origin);<br/>}</span><span id="1e35" class="ma kb ht lw b fv mf mc l md me">function internalTx() public view returns(address, address) {<br/>   return this.iAmExternal();<br/>}</span><span id="efe8" class="ma kb ht lw b fv mf mc l md me">function iAmExternal() external view returns(address, address) {<br/>        return (msg.sender, tx.origin);<br/>}<br/>}</span></pre><p id="d703" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><code class="eh mg mh mi lw b">directTx</code>和<code class="eh mg mh mi lw b">iAmExternal</code>功能都可以直接调用。因此，<em class="jz"> msg.sender </em>和<em class="jz"> tx.origin </em>将具有相同的值，因为调用该函数的是启动事务的同一个地址(在这种情况下，它只是一个调用，但如果它是一个事务，它将是相同的)。我们可以在下图中看到这一点。</p><figure class="lr ls lt lu fq iu fe ff paragraph-image"><div class="fe ff mj"><img src="../Images/7225dd4aebe18a6faf5c95bce13b8007.png" data-original-src="https://miro.medium.com/v2/resize:fit:776/format:webp/1*ghMP5i2cj86Abdci8UU7DA.png"/></div><figcaption class="mk ml fg fe ff mm mn bd b be z ek">Msg.sender and tx.origin have the same value.</figcaption></figure><p id="2b33" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">当我们调用函数<code class="eh mg mh mi lw b">internalTx</code>时，它会调用函数<code class="eh mg mh mi lw b">iAmExternal</code>，但是它会像外部调用一样进行调用。请注意，函数<code class="eh mg mh mi lw b">iAmExternal</code>具有外部可见性，也就是说，它不能从契约内部调用。这就是为什么我们在表达式<code class="eh mg mh mi lw b">this.iAmExternal()</code>中使用前缀<code class="eh mg mh mi lw b">this</code>，而不仅仅是<code class="eh mg mh mi lw b">iAmExternal()</code>。</p><p id="21c4" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">调用的结果可以在下图中看到。现在<em class="jz"> msg.sender </em>将是合约本身的地址，而<em class="jz"> tx.origin </em>仍然是发送交易的账户的地址。</p><figure class="lr ls lt lu fq iu fe ff paragraph-image"><div class="fe ff mo"><img src="../Images/3a5fba85dd02d782a61996153e804305.png" data-original-src="https://miro.medium.com/v2/resize:fit:784/format:webp/1*mKpZJ5uKTpVGZoKZHYrWjA.png"/></div><figcaption class="mk ml fg fe ff mm mn bd b be z ek">Msg.sender indicates the address that generated the internal transaction, and tx.origin holds the address of the account that sent the original transaction.</figcaption></figure><p id="3353" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">为什么<em class="jz"> msg.sender </em>是合同地址？记住<em class="jz"> msg.sender </em>是产生内部交易的账户地址。是契约本身生成了调用函数的内部事务，而不是发送事务的帐户。</p><p id="f9d4" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">契约通常从外部调用不同的其他契约的函数。但是为了简化这个例子，我只使用了一个契约。</p><p id="b5cc" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">在这个例子中，我还想展示从契约本身内部调用可见性在外部的函数是可能的。然而，当我们这样做时，它被认为是一个内部事务，并且<em class="jz"> msg.sender </em>将不再是<em class="jz"> tx.origin </em>，正如我们已经看到的。如果可见性是公共的，我们可以正常调用函数，而不必生成内部事务。</p><h1 id="6a93" class="ka kb ht bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">Ps:通话的<em class="mp">消息发送者</em></h1><p id="afaa" class="pw-post-body-paragraph jb jc ht jd b je ky jg jh ji kz jk jl jm la jo jp jq lb js jt ju lc jw jx jy hm dt translated">要将交易发送到区块链，您需要一个帐户，毕竟，交易需要用私钥签名。然而，呼叫可以是匿名的，因为它们不会在区块链中传播。那么，谁是电话的发件人呢？</p><p id="4a6c" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">因为调用不会改变区块链的状态，所以您不需要太担心。即使调用的<em class="jz"> msg.sender </em>值不明确，也不会干扰区块链的确定性行为。</p><p id="9270" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">出于好奇，我将合同部署到一个testnet，并使用etherscan调用函数，当涉及内部事务时，该函数返回<em class="jz"> msg.sender </em>和<em class="jz"> tx.origin </em>。获得的结果如下图所示。</p><figure class="lr ls lt lu fq iu fe ff paragraph-image"><div class="fe ff mq"><img src="../Images/8bf4f6d9eb7e5faf519c7e8db2b374ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*qyt3_fwiVqQTlKdgafNUdA.png"/></div><figcaption class="mk ml fg fe ff mm mn bd b be z ek">The tx.origin is address zero, but msg.sender takes the contract address, as it was supposed to.</figcaption></figure><p id="42a4" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">不明确的地址，也就是呼叫者，是地址零。<em class="jz"> msg.sender </em>是契约的地址，应该是这样。</p><p id="d4e6" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这次会议只是一个好奇心，因为在交易中使用<em class="jz"> msg.sender </em>和<em class="jz"> tx.origin </em>比在通话中更有意义，但我是一个好奇的人，我希望你也是。</p><h1 id="bb40" class="ka kb ht bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">区块链上的随机数</h1><p id="57dd" class="pw-post-body-paragraph jb jc ht jd b je ky jg jh ji kz jk jl jm la jo jp jq lb js jt ju lc jw jx jy hm dt translated">正如我所说，由于区块链的确定性行为，不可能在其上生成真正的随机数。当我们想生成随机数的时候应该怎么做？</p><p id="457c" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">一种可能是使用全局变量，如<em class="jz"> block.timestamp </em>。每个Solidity教程都不建议使用全局变量，因为它们并不是真正随机的，但根据项目的大小，这并没有太大的问题。尤其是当我们使用像块时间戳这样的值的散列时。</p><p id="848d" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">矿工确实可以操纵块时间戳，但除非你的合同涉及大量资金，否则这并不重要。此外，以太坊正在迁移到PoS，所以我们很快就会随机选择验证器而不是挖掘器。无论如何，应该明确的是，时间戳不是一个随机数。</p><p id="5c1d" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">如果你需要一个真正的随机数，无论花费多少，你都应该使用Oracle的服务。区块链的神谕是智能合约与外界沟通的方式。他们不施法，遵守游戏规则。</p><p id="a509" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">我们将在以后讨论更多关于神谕的内容，但是让我们来看一个创建神谕的简单方法。通过请求一个随机数，一个契约可以发出一个事件，这个事件由外界监控。假设同一个契约有一个接收随机数的函数。</p><p id="7d4e" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">先知，在外面的世界，监视着事件。在接收到对随机数的请求时，它生成随机数，并通过事务将该数发送给该函数。请注意，区块链在任何时候都不接触外部世界，是外部世界注入了它。</p><p id="790a" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">感谢阅读！</strong></p><p id="b820" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">欢迎对本文提出意见和建议。</p><p id="c6af" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">欢迎任何投稿。【www.buymeacoffee.com/jpmorais T2】号</p><blockquote class="ms"><p id="0810" class="mt mu ht bd mv mw mx my mz na nb jy ek translated">加入Coinmonks <a class="ae mr" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae mr" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h1 id="63b7" class="ka kb ht bd kc kd ke kf kg kh ki kj kk kl nc kn ko kp nd kr ks kt ne kv kw kx dt translated">另外，阅读</h1><ul class=""><li id="75f9" class="ld le ht jd b je ky ji kz jm nf jq ng ju nh jy li lj lk ll dt translated"><a class="ae mr" href="https://coincodecap.com/bookmap-review-2021-best-trading-software" rel="noopener ugc nofollow" target="_blank"> Bookmap评论</a> | <a class="ae mr" href="https://coincodecap.com/crypto-exchange-usa" rel="noopener ugc nofollow" target="_blank">美国5大最佳加密交易所</a></li><li id="52de" class="ld le ht jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated"><a class="ae mr" href="https://coincodecap.com/ftx-futures-trading" rel="noopener ugc nofollow" target="_blank">如何在FTX交易所交易期货</a> | <a class="ae mr" href="https://coincodecap.com/okex-vs-binance" rel="noopener ugc nofollow" target="_blank"> OKEx vs币安</a></li><li id="e607" class="ld le ht jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated"><a class="ae mr" href="https://coincodecap.com/coinloan-review" rel="noopener ugc nofollow" target="_blank"> CoinLoan评论</a> | <a class="ae mr" rel="noopener" href="/coinmonks/youhodler-4-easy-ways-to-make-money-98969b9689f2"> YouHodler评论</a> | <a class="ae mr" href="https://coincodecap.com/blockfi-review" rel="noopener ugc nofollow" target="_blank"> BlockFi评论</a></li><li id="e3f3" class="ld le ht jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated">《XT.COM评论》的<a class="ae mr" href="https://coincodecap.com/profittradingapp-for-binance" rel="noopener ugc nofollow" target="_blank">《币安评论》的</a>|<a class="ae mr" href="https://coincodecap.com/xt-com-review" rel="noopener ugc nofollow" target="_blank"/></li><li id="44f3" class="ld le ht jd b je lm ji ln jm lo jq lp ju lq jy li lj lk ll dt translated"><a class="ae mr" href="https://coincodecap.com/smithbot-review" rel="noopener ugc nofollow" target="_blank"> SmithBot评论</a> | <a class="ae mr" href="https://coincodecap.com/free-open-source-trading-bots" rel="noopener ugc nofollow" target="_blank"> 4款最佳免费开源交易机器人</a></li></ul></div></div>    
</body>
</html>