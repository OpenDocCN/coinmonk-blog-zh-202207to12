<html>
<head>
<title>OMNI Attack Analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">OMNI攻击分析</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/omni-attack-analysis-ddff7078df72?source=collection_archive---------12-----------------------#2022-07-25">https://medium.com/coinmonks/omni-attack-analysis-ddff7078df72?source=collection_archive---------12-----------------------#2022-07-25</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/f5358e4f80a11ad4ba1d91cfdac4363a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iCK3DHB7SK5BFSIQosEtvQ.jpeg"/></div></div></figure><h2 id="3a86" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">0x01背景预览</h2><p id="fe4e" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated">Omni是一个创建和交易定制数字资产和货币的平台。它是一个软件层，建立在最流行、最受审核、最安全的区块链——比特币之上。Omni transactions是在比特币区块链上启用下一代功能的比特币交易。我们的参考实现Omni Core是一个增强的比特币核心，提供比特币的所有功能以及高级Omni层功能。</p><h2 id="0bb7" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">0x02攻击信息</h2><p id="d3bd" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated"><strong class="kb hu">攻击钱包地址</strong>:</p><p id="354b" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">0x 00000000 c 251 faf 2de 8217 ab 64 accd 0070 b 97e 47</p><p id="ffb3" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">0x 627 a 22 ff 70 CB 84 e 74 c 9 c 70 e 2d 5b 0 b 75 af 5a 1 dcb 9</p><h2 id="22cd" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">攻击合同地址</h2><p id="2f4b" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated">0 x3c 10 e 78343 c 475 b 99d 20 fa 544 DD 30 b 43 c 0 CBA 26 f</p><p id="b8c7" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">0x1c 244 c 94090390 f 885d 472 b 83 df 267 f 083 c 72 faf</p><h2 id="b6f0" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">攻击交易</h2><p id="d7a8" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated">0x 264 e 16 f 4862d 182 a 6a 0b 74977 df 28 a 85747 b 6 f 237 b5 e 229 c 9 a5 bbacdf 499 cc b 4</p><h2 id="65d9" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">受到攻击的合同。</h2><p id="15b6" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated">0x 50 c7a 557d 408 a5 F5 a 7 fdbe 1091831728 AE 7 EBA 45</p><h2 id="bcf2" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">0x03攻击步骤</h2><ol class=""><li id="817a" class="kz la ht kb b kc kd kg kh jm lb jq lc ju ld kt le lf lg lh dt translated">攻击者flashloan 1000 WETH从平衡器到</li></ol><p id="8aaa" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">0 x3c 10 e 78343 c 475 b 99d 20 fa 544 DD 30 b 43 c 0 CBA 26</p><p id="b7c4" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">2.攻击者使用flashloan功能借了20个涂鸦，并使用13个涂鸦通过sushiswap交换1个涂鸦</p><figure class="lj lk ll lm fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff li"><img src="../Images/5196d38eb30cbdafcf3781ca69bdc917.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rzQ-ZWFYVyzfPUZDQhRZpQ.png"/></div></div></figure><p id="0469" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">3.调用supplyERC721方法来下注三个NFT并借出12.15 WETH</p><figure class="lj lk ll lm fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff li"><img src="../Images/e9c4bddd22a598c7e65e5b2d0b82181a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*shM6y5wckQeFx49avbsbIw.png"/></div></div></figure><figure class="lj lk ll lm fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff li"><img src="../Images/5e208b181c076ac641889df5f2a8a5f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3cC5VmR8jGI_otPmFCy5JQ.png"/></div></div></figure><figure class="lj lk ll lm fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff li"><img src="../Images/0e050f4d2b1d4648fbaeaf9b030d7777.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SDnKjODXKiUcXQI6Sfg6zg.png"/></div></div></figure><figure class="lj lk ll lm fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff li"><img src="../Images/632826ff0ce3d48ba0ac8246a715bfe3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9WaNzr29RPpvxs-fDJ6u-Q.png"/></div></div></figure><p id="0b93" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">4.干掉两个NFT</p><figure class="lj lk ll lm fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff li"><img src="../Images/6e75759cef5920d26245e15501537e3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LGte2uXWsjXzOIHYpAyktQ.png"/></div></div></figure><p id="61c0" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">5.归还借出的12.15 WTH和<strong class="kb hu">调用</strong>剩余一个NFT的清算方法</p><figure class="lj lk ll lm fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff li"><img src="../Images/c04a1ddb854bbb832d44a3c421d3e31c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f_z8PkMJ_Dg6Gd8_79rBTw.png"/></div></div></figure><p id="c1be" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">6.继续重入攻击，在清算过程中调用ERC721_checkOnERC721Received函数来下注20张涂鸦并借出81张wet</p><figure class="lj lk ll lm fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff ln"><img src="../Images/79b4e44ea6cabdefa04efb4fa0002a42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a-hLvw3n76_QqZJOqZ0SvQ.png"/></div></div></figure><figure class="lj lk ll lm fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff li"><img src="../Images/ed2e2843bed8cc145adb9fb93c14a249.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c6ExQ8f7oatHouv38gj0Qg.png"/></div></div></figure><p id="40b2" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">7 .取出20个NFT，由于清算函数的返回值将被设置为false状态，所以在取出函数中由于借贷状态错误，20个NFT可以被成功取出</p><p id="6ed0" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">8.由于在执行清算时首先移除NFT，然后扣除归还的钱，攻击者通过移除NFT进行重新进入，并在重新进入后继续进行判断，此时状态已经改变，先前借出的12.15 WETH不需要归还，因此攻击者最终将得到93.15 WETH</p><figure class="lj lk ll lm fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff li"><img src="../Images/ad558ad3bf03aa77cb3d729ebf501ca7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EhP08Nvt6cPrvZ-Zq5L6xg.png"/></div></div></figure><p id="e26c" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">9.返还调用闪贷获得的20个涂鸦，返还闪贷获得的1000个wet</p><figure class="lj lk ll lm fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff li"><img src="../Images/4dcdaf9ac0f386f7e01b76b83108995f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q3cnMkSEjZ9fns6LDGQQzw.png"/></div></div></figure><h2 id="9262" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">0x04漏洞核心</h2><p id="88e3" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated">攻击者通过调用LiquidationLogic.sol中的清算方法executeERC721LiquidationCall来实现这一点</p><figure class="lj lk ll lm fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff li"><img src="../Images/b0186818349e5504b7e232b0821c06bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nM3lgrg9QroSUudN3mambw.png"/></div></div></figure><p id="47d7" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">当调用<strong class="kb hu">_ burncolateraltokens</strong>方法时，burn函数调用ERC721中的<strong class="kb hu"> _checkOnERC721 </strong> Received方法</p><figure class="lj lk ll lm fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff li"><img src="../Images/66a0dcfd4b25a83c1502eb6918a88345.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XUDEZeFuzpjUdUO4Rhujkw.png"/></div></div></figure><figure class="lj lk ll lm fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff li"><img src="../Images/56ec264511b83354617bd60ae2c6ec5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cqkeHQ6AlKLPZX8-95Y9MA.png"/></div></div></figure><p id="9f43" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">此时，<strong class="kb hu"> <em class="lo">到</em> </strong>地址就是攻击契约的地址，攻击者在这里实施重入攻击。继续押20涂鸦求借。</p><figure class="lj lk ll lm fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff li"><img src="../Images/e561a9f9d3bea4f3f73c091a3b003873.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_o7rvcl6PWPN4pTDM708Hg.png"/></div></div></figure><p id="887f" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">ID状态被标记为真，并且清算功能在继续执行清算功能时将真覆盖为假。isBorrowAny()然后确定ID状态，这是假的，并成功地删除了staked涂鸦。</p><figure class="lj lk ll lm fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff lp"><img src="../Images/ca6be9dd548905d09af5123eca800554.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l4W-CTF-E9gDF40zg4CZ1A.png"/></div></div></figure><h2 id="bd42" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">0x05资金流</h2><p id="8fb6" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated">这两个攻击钱包地址已经向Tornado转移了800 ETH和426.5 ETH的捕获资金。现金</p><figure class="lj lk ll lm fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff li"><img src="../Images/a5a7a89dd45790009abca21264d9cd29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_8KjyPPV-VCxwSqUACGfEg.png"/></div></div></figure><h2 id="f89d" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">0x06摘要和建议</h2><p id="9d1f" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated">攻击的核心是项目契约的访问控制存在缺陷，没有限制池契约中质押物的重入，允许攻击者恶意调用ERC721中的_checkOnERC721Received函数进行重入攻击，以及在setBorrowing()方法之前没有设置状态判断操作。</p><blockquote class="lq"><p id="6da3" class="lr ls ht bd lt lu lv lw lx ly lz kt ek translated">交易新手？试试<a class="ae ma" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">加密交易机器人</a>或者<a class="ae ma" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">复制交易</a></p></blockquote></div></div>    
</body>
</html>