<html>
<head>
<title>Better Price Feeds With Uniswap v2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Uniswap v2提供更优惠的价格</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/better-price-feeds-with-uniswap-v2-dc0dc133347a?source=collection_archive---------1-----------------------#2022-09-02">https://medium.com/coinmonks/better-price-feeds-with-uniswap-v2-dc0dc133347a?source=collection_archive---------1-----------------------#2022-09-02</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="ba76" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">了解Uniswap v2价格源</h2></div><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff ji"><img src="../Images/afaf076647227246f9cde1ad4253aaaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CRfzB0tMQ2tijHYd90ISKA.png"/></div></div></figure><p id="5546" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">大家好，今天我们将讨论<strong class="jw hu"> Uniswap v2价格反馈</strong>以及Uniswap v2如何为您提供<strong class="jw hu">更好的价格反馈</strong>。</p><p id="6333" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">快速增长的分散金融(DeFi)生态系统旨在使用分散、非托管的金融产品来取代贷款、保险和衍生品等金融应用中的集中式中间人。</p><p id="18d7" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated"><strong class="jw hu"> Uniswap </strong>是<strong class="jw hu"> DeFi </strong>生态系统中核心产品之一的一个例子，即分散加密交易所，或<strong class="jw hu"> DEX </strong>。首先，我们来讨论一下Uniswap是什么。</p><h1 id="2a08" class="kq kr ht bd ks kt ku kv kw kx ky kz la iz lb ja lc jc ld jd le jf lf jg lg lh dt translated">什么是Uniswap？</h1><p id="508b" class="pw-post-body-paragraph ju jv ht jw b jx li iu jz ka lj ix kc kd lk kf kg kh ll kj kk kl lm kn ko kp hm dt translated"><strong class="jw hu"> Uniswap </strong>是<strong class="jw hu">以太坊</strong>上的一个协议，用于交换<strong class="jw hu"> ERC20 </strong>令牌，不需要买卖双方创造需求。换句话说，Uniswap是一个基于以太坊的<strong class="jw hu">去中心化交换(DEX) </strong>，允许任何人<strong class="jw hu">交换</strong> ERC20令牌。2020年9月，Uniswap推出了其<strong class="jw hu"> UNI governance token </strong>，向9月前使用该协议的任何人空投。<strong class="jw hu"> Uniswap V3 </strong>于2021年5月推出，增加了新功能，包括集中流动性和多层费用。</p><p id="0b72" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">与大多数旨在收取费用的交易所不同，Uniswap的功能是一种公共产品——社区交易代币的工具，没有平台费或中间人。此外，与大多数撮合买家和卖家以确定价格并执行交易的交易所不同，Uniswap使用一个简单的数学等式、代币池和ETH池来做同样的工作。</p><h1 id="6793" class="kq kr ht bd ks kt ku kv kw kx ky kz la iz lb ja lc jc ld jd le jf lf jg lg lh dt translated">Uniswap v1与v2</h1><p id="6d33" class="pw-post-body-paragraph ju jv ht jw b jx li iu jz ka lj ix kc kd lk kf kg kh ll kj kk kl lm kn ko kp hm dt translated">让我们提醒自己它的进化路径和<strong class="jw hu"> v1 </strong>与<strong class="jw hu"> v2 </strong>的区别。这将有助于我们理解为什么Uniswap成为这个领域的领导者是理所当然的事情。</p><h1 id="2d78" class="kq kr ht bd ks kt ku kv kw kx ky kz la iz lb ja lc jc ld jd le jf lf jg lg lh dt translated">uni swap v1—AMMs简介</h1><p id="b704" class="pw-post-body-paragraph ju jv ht jw b jx li iu jz ka lj ix kc kd lk kf kg kh ll kj kk kl lm kn ko kp hm dt translated"><strong class="jw hu"> Uniswap v1 </strong>于2018年11月2日在<strong class="jw hu">以太坊主网</strong>首发。尽管它不是第一个DEX，但它肯定是第一个吸引密码爱好者眼球的。在Uniswap之前，<a class="ae ln" href="https://etherdelta.com/" rel="noopener ugc nofollow" target="_blank"> EtherDelta </a>几乎是唯一一个获得一些关注的DEX。尽管如此，它还是基于<strong class="jw hu">订单簿</strong>模式，这并不被认为是分散交易所的最佳解决方案，因为它带来了成本、用户体验差和缺乏流动性等问题。</p><p id="b8da" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">与EtherDelta不同，Uniswap基于<strong class="jw hu">自动做市商(AMM) </strong>模式。这个模型依靠一个<strong class="jw hu">数学公式</strong>来给资产定价。AMMs依赖于流动性提供者(LP)而不是下单，流动性提供者投资于流动性池中的交易对。</p><p id="5ff1" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">Uniswap是一家<strong class="jw hu">恒定功能做市商</strong>，或者更具体地说，是一家恒定产品做市商。这意味着每个流动性池中交易对的比率必须遵循常数乘积公式:</p><p id="1664" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated"><strong class="jw hu"> <em class="lo"> x*y=k </em> </strong></p><p id="0324" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">其中<em class="lo"> k </em>为常数，<em class="lo"> x </em>为第一项资产的储备，<em class="lo"> y </em>为第二项资产的储备。</p><p id="f065" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">这意味着所有有限合伙人都要以不改变k的方式提供额外的流动性。此外，每个交易者都必须知道锁定的资金总量，以避免高滑点。</p><p id="b17b" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">Uniswap v1仅支持<strong class="jw hu"> ETH-ERC20 </strong>交易对，因此您只能用ETH交换一个ERC20令牌。所以，如果你想把换成戴，你必须把换成ETH，然后去ETH-DAI池得到戴。</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff lp"><img src="../Images/1a01abea83b11ebe973d4908f913f073.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*m6TC3Fjg6heiMXzo.png"/></div></div><figcaption class="lq lr fg fe ff ls lt bd b be z ek">Uniswap v1 Example — DAI to USDC Swap</figcaption></figure><p id="fad5" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">Uniswap v1引入的另一个特性是<strong class="jw hu"> LP令牌</strong>。每个流动性提供者将获得与他们增加的总流动性的百分比成比例的LP令牌的数量。这些LP代币代表LP对池的贡献，并且可以被出售/交易或燃烧以赎回存放的代币。此外，Uniswap上的每笔交易都会产生0.30%的交易费。这些费用作为对提供流动性的有限合伙人的奖励被自动发送到流动性准备金。</p><h1 id="6cb5" class="kq kr ht bd ks kt ku kv kw kx ky kz la iz lb ja lc jc ld jd le jf lf jg lg lh dt translated">uni WAP v2—优化、分散化和安全性</h1><p id="1227" class="pw-post-body-paragraph ju jv ht jw b jx li iu jz ka lj ix kc kd lk kf kg kh ll kj kk kl lm kn ko kp hm dt translated">Uniswap v1是一种新型分散市场的概念验证。它的初步成功是团队立即重申一个更好的解决方案的信号。Uniswap v2 于2020年5月推出。</p><p id="e0db" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">简而言之，<strong class="jw hu"> Uniswap v2 </strong>是Uniswap v1的一个更好、更用户友好的版本。这个新版本中解决的v1的主要问题是缺少ERC20-ERC20令牌池。对于那些想用一个<strong class="jw hu"> ERC20 </strong>令牌换另一个令牌的用户来说，这导致了更高的成本和延误。</p><h2 id="78cf" class="lu kr ht bd ks lv lw lx kw ly lz ma la kd mb mc lc kh md me le kl mf mg lg mh dt translated">ERC20-ERC20池</h2><p id="cf15" class="pw-post-body-paragraph ju jv ht jw b jx li iu jz ka lj ix kc kd lk kf kg kh ll kj kk kl lm kn ko kp hm dt translated">Uniswap v2引入了ERC20-ERC20流动性池来解决这个"<strong class="jw hu"> ETH桥接</strong>"问题。他们甚至在核心合同中使用包装ETH而不是本地ETH。然而，最终用户仍然可以通过帮助者合同使用ETH。</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff mi"><img src="../Images/bf0f63d8bfc9fa6f2308fd788725a9fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rxEcZau9zhSpaYNg.png"/></div></div><figcaption class="lq lr fg fe ff ls lt bd b be z ek">Uniswap V2 — ETH Bridging</figcaption></figure><h2 id="07ca" class="lu kr ht bd ks lv lw lx kw ly lz ma la kd mb mc lc kh md me le kl mf mg lg mh dt translated">神谕</h2><p id="382a" class="pw-post-body-paragraph ju jv ht jw b jx li iu jz ka lj ix kc kd lk kf kg kh ll kj kk kl lm kn ko kp hm dt translated">Uniswap的第二个版本还实现了新功能，支持高度分散和抗操纵的链上<strong class="jw hu">价格馈送</strong>。</p><p id="9b98" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">基本思想是通过将累积价格(整个合同历史中每秒的Uniswap价格之和)除以时间戳持续时间(持续时间结束时间戳减去持续时间开始时间戳)来计算一段时间内的平均价格(时间加权平均价格— <strong class="jw hu"> TWAP </strong>)。</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff lp"><img src="../Images/b48db0c2fb92587300b27b364ca19409.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pjRs36kIBr0M4o-X.png"/></div></div><figcaption class="lq lr fg fe ff ls lt bd b be z ek">Uniswap v2 — Time Weighted Average Price — <strong class="bd mj">TWAP</strong></figcaption></figure><h2 id="0604" class="lu kr ht bd ks lv lw lx kw ly lz ma la kd mb mc lc kh md me le kl mf mg lg mh dt translated">闪存互换</h2><p id="37bd" class="pw-post-body-paragraph ju jv ht jw b jx li iu jz ka lj ix kc kd lk kf kg kh ll kj kk kl lm kn ko kp hm dt translated">v2推出的另一个突破性特性是<strong class="jw hu">闪存交换</strong>。这些Flash Swaps允许用户在Uniswap上提取任意数量的ERC20令牌，无需任何前期费用，并且可以对其进行任何操作(执行任意代码)，前提是在交易执行结束时，他们可以:</p><ul class=""><li id="bdbb" class="mk ml ht jw b jx jy ka kb kd mm kh mn kl mo kp mp mq mr ms dt translated">支付所有提取的ERC20代币</li><li id="c79e" class="mk ml ht jw b jx mt ka mu kd mv kh mw kl mx kp mp mq mr ms dt translated">支付一定比例的ERC20代币，并返还剩余部分</li><li id="9f79" class="mk ml ht jw b jx mt ka mu kd mv kh mw kl mx kp mp mq mr ms dt translated">退回所有提取的ERC20代币</li></ul><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff lp"><img src="../Images/8a56610cd8ae0d8e357e4ebfdc7e1ecc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eVa_dwkvis7NPcFA.png"/></div></div><figcaption class="lq lr fg fe ff ls lt bd b be z ek">Uniswap v2 Flash Swaps</figcaption></figure><p id="7df7" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">Uniswap还引入了<strong class="jw hu">协议费</strong>(可以通过分散的社区投票来开启/关闭，将每0.30%的交易费中的0.05%交给Uniswap基金，以资助未来的发展。</p><p id="de76" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">即使在v2推出后Uniswap v1依然存在，但没过多久，LPs就将大部分流动性从一个版本转移到了另一个版本。Uniswap v2取得了巨大的成功，日交易量甚至超过了一些最著名的中央交易所。这一成功使Uniswap v2成为最分叉的项目之一，SushiSwap是其最大的竞争对手，被创建为分叉项目。SushiSwap的这一吸血鬼攻击耗尽了Uniswap的很大一部分流动性，导致了2020年9月著名的<strong class="jw hu"> UNI token空投</strong>。</p><h1 id="3823" class="kq kr ht bd ks kt ku kv kw kx ky kz la iz lb ja lc jc ld jd le jf lf jg lg lh dt translated">Uniswap V2提供更好的价格馈送</h1><p id="7372" class="pw-post-body-paragraph ju jv ht jw b jx li iu jz ka lj ix kc kd lk kf kg kh ll kj kk kl lm kn ko kp hm dt translated"><strong class="jw hu"> Uniswap v2 </strong>发布了该平台的第二个主要版本，它具有<strong class="jw hu">更好的价格反馈</strong> oracle的特性，同时引入了一个<strong class="jw hu">闪贷</strong>的变体。</p><h1 id="0a42" class="kq kr ht bd ks kt ku kv kw kx ky kz la iz lb ja lc jc ld jd le jf lf jg lg lh dt translated">Uniswap价格是如何确定的？</h1><p id="1ca5" class="pw-post-body-paragraph ju jv ht jw b jx li iu jz ka lj ix kc kd lk kf kg kh ll kj kk kl lm kn ko kp hm dt translated">正如我们在Uniswap概述中了解到的，Uniswap上的每一对实际上都是由流动性池支撑的。<strong class="jw hu">流动性池</strong>是智能合约，持有两种独特代币的余额，并执行有关存款和取款的规则。首要规则是<strong class="jw hu">不变乘积公式</strong>。当代币被提取(购买)时，必须存入(出售)一定比例的金额以保持不变。池中代币的比率，结合常数乘积公式，最终决定了互换执行的价格。</p><h1 id="6c1b" class="kq kr ht bd ks kt ku kv kw kx ky kz la iz lb ja lc jc ld jd le jf lf jg lg lh dt translated">Uniswap如何处理价格</h1><p id="1d25" class="pw-post-body-paragraph ju jv ht jw b jx li iu jz ka lj ix kc kd lk kf kg kh ll kj kk kl lm kn ko kp hm dt translated">在Uniswap V1，交易总是以执行时计算的“最佳可能”价格执行。有点令人困惑的是，这种计算实际上是用两种不同公式中的一种来完成的，这取决于交易是否指定了确切的<strong class="jw hu"> <em class="lo">投入</em>或<em class="lo">产出</em> </strong>金额。从功能上来说，这两个功能之间的差异很小，但是差异的存在增加了概念的复杂性。最初在V2支持这两种功能的尝试被证明是不合适的，于是决定不在核心中提供任何定价功能。相反，pairs在每次交易后直接检查不变量是否满足(考虑费用)。这意味着，<strong class="jw hu"> V2 </strong>对简单而透明地确保他们自己的安全，很好地分离了关注点，而不是依赖于定价函数来<em class="lo">也</em>实施不变量。一个下游好处是<strong class="jw hu"> V2 </strong>对更自然地支持出现的其他风格的交易(例如，在执行时交易到特定价格)。</p><p id="0452" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">从高层次来说，在Uniswap V2公司，<em class="lo">交易必须在外围进行定价</em>。好消息是，该库提供了各种旨在使这变得非常简单的函数，路由器中的所有交换函数在设计时都考虑到了这一点。</p><h1 id="34b0" class="kq kr ht bd ks kt ku kv kw kx ky kz la iz lb ja lc jc ld jd le jf lf jg lg lh dt translated">定价交易</h1><p id="8112" class="pw-post-body-paragraph ju jv ht jw b jx li iu jz ka lj ix kc kd lk kf kg kh ll kj kk kl lm kn ko kp hm dt translated">当<strong class="jw hu">在Uniswap上交换代币</strong>时，通常希望以<strong class="jw hu"> <em class="lo">的确切输入金额</em> </strong>获得尽可能多的输出代币，或者以<strong class="jw hu"> <em class="lo">的确切输出金额</em> </strong>支付尽可能少的输入代币。为了计算这些金额，合同必须查找一对货币的<strong class="jw hu"> <em class="lo">当前储备</em> </strong>，以便了解<strong class="jw hu">当前价格</strong>是多少。然而，<strong class="jw hu"> <em class="lo">不安全</em> </strong> <em class="lo">执行该查找并依赖结果而不访问外部价格</em>。</p><p id="3763" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">假设，一份智能合约天真地希望向DAI/WETH对发送10个DAI，并在给定当前准备金率的情况下接收尽可能多的WETH。如果在调用时，简单的智能合约只是查看当前价格并执行交易，那么它很容易受到抢先交易的影响，并可能遭受经济损失。要了解为什么要考虑一个在交易被确认之前就看到交易的恶意行为者。他们可以在简单互换进行之前立即执行大幅改变DAI/WETH价格的互换，等待简单互换以糟糕的价格执行，然后互换以将价格改变回简单互换之前的价格。这种攻击相当便宜且风险低，通常可以获利。</p><p id="4c52" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">为了防止这种类型的攻击，提交<strong class="jw hu">互换</strong> <em class="lo">是至关重要的，它们有权了解其互换应在</em>执行的“ <strong class="jw hu"> <em class="lo">公平</em> </strong> <em class="lo">”价格。换句话说，掉期交易需要访问一个<strong class="jw hu"> <em class="lo"> oracle </em> </strong>，以确保他们可以从Uniswap获得的最佳执行足够接近oracle认为的“T16】真实价格。虽然这听起来可能很复杂，但是<strong class="jw hu">预言</strong>可以简单到<em class="lo">对一双</em>鞋当前市场价格的离线观察。由于套利，通常情况下，一对货币的内部储备比率接近“真实”市场价格。因此，如果用户在提交交易时考虑到这一点，他们可以确保由于抢先交易造成的损失被严格控制。例如，Uniswap前端就是这样确保交易安全的。它计算给定观察到的块内价格的最佳输入/输出量，并使用路由器执行交换，这保证交换将以比观察到的块内速率差不小于<code class="eh my mz na nb b">x</code> %的速率执行，其中<code class="eh my mz na nb b">x</code>是用户指定的滑动容差(默认为0.5%)。</em></p><h1 id="0c06" class="kq kr ht bd ks kt ku kv kw kx ky kz la iz lb ja lc jc ld jd le jf lf jg lg lh dt translated">准确输入<a class="ae ln" href="https://docs.uniswap.org/protocol/V2/concepts/advanced-topics/pricing#exact-input" rel="noopener ugc nofollow" target="_blank">和</a></h1><p id="2253" class="pw-post-body-paragraph ju jv ht jw b jx li iu jz ka lj ix kc kd lk kf kg kh ll kj kk kl lm kn ko kp hm dt translated">如果您想要发送精确数量的输入令牌，以换取尽可能多的输出令牌，您将需要使用<a class="ae ln" href="https://docs.uniswap.org/protocol/V2/reference/smart-contracts/router-02#getamountout" rel="noopener ugc nofollow" target="_blank"> getAmountsOut </a>。等效的SDK函数是用于滑移计算的<a class="ae ln" href="https://docs.uniswap.org/sdk/2.0.0/reference/pair#getoutputamount" rel="noopener ugc nofollow" target="_blank"> getOutputAmount </a>或<a class="ae ln" href="https://docs.uniswap.org/sdk/2.0.0/reference/trade#minimumamountout-since-204" rel="noopener ugc nofollow" target="_blank"> minimumAmountOut </a>。</p><h1 id="7485" class="kq kr ht bd ks kt ku kv kw kx ky kz la iz lb ja lc jc ld jd le jf lf jg lg lh dt translated">精确输出<a class="ae ln" href="https://docs.uniswap.org/protocol/V2/concepts/advanced-topics/pricing#exact-output" rel="noopener ugc nofollow" target="_blank"> </a></h1><p id="760d" class="pw-post-body-paragraph ju jv ht jw b jx li iu jz ka lj ix kc kd lk kf kg kh ll kj kk kl lm kn ko kp hm dt translated">如果您想用尽可能少的输入令牌接收精确数量的输出令牌，您将需要使用<a class="ae ln" href="https://docs.uniswap.org/protocol/V2/reference/smart-contracts/router-02#getamountsin" rel="noopener ugc nofollow" target="_blank"> getAmountsIn </a>。等效的SDK函数是用于滑移计算的<a class="ae ln" href="https://docs.uniswap.org/sdk/2.0.0/reference/pair#getinputamount" rel="noopener ugc nofollow" target="_blank"> getInputAmount </a>，或<a class="ae ln" href="https://docs.uniswap.org/sdk/2.0.0/reference/trade#maximumamountin-since-204" rel="noopener ugc nofollow" target="_blank">maximum amount</a>。</p><h1 id="c8a6" class="kq kr ht bd ks kt ku kv kw kx ky kz la iz lb ja lc jc ld jd le jf lf jg lg lh dt translated">价格先知</h1><p id="f700" class="pw-post-body-paragraph ju jv ht jw b jx li iu jz ka lj ix kc kd lk kf kg kh ll kj kk kl lm kn ko kp hm dt translated"><strong class="jw hu"> Uniswap V2 </strong>实施了新功能，实现了高度分散和抗操纵的<strong class="jw hu">链上价格反馈</strong>。这是通过在操纵价格昂贵时衡量价格，并巧妙地积累历史数据来实现的。这使得外部智能合约可以在任何时间间隔内创建节能的时间加权平均Uniswap价格。</p><p id="5506" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated"><strong class="jw hu">链上价格反馈</strong>是许多分散式金融应用的重要组成部分，包括类似于衍生品、贷款、保证金交易、预测市场等。尽管大多数时间密切跟踪真实世界的价格，但Uniswap V1不能安全地用作价格预测工具，因为价格可能在短时间内大幅波动。</p><p id="e89b" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">Uniswap V2对构建于其上的price feed进行了大量改进。首先，在任何交易发生之前，每一对都测量(但不存储)每一个块开始时的市场价格。操纵这个价格的成本很高，因为它是由前一个区块中的最后一笔交易设定的。</p><p id="9928" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">为了将测量的价格设置为与全球市场价格不同步的价格，攻击者必须在前一个交易块结束时进行一次糟糕的交易，通常无法保证他们能够在下一个交易块套利回来。攻击者会把钱输给套利者，除非他们能“自私地”连续开采两个区块。这种类型的攻击提出了许多挑战，迄今为止还没有观察到。</p><p id="b841" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">仅此还不够。如果基于该机制产生的价格结算了大量价值，那么攻击的利润可能会超过损失。</p><p id="cb48" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">取而代之的是，Uniswap V2公司将这一交易结束价格加入到核心合约中的一个单一的<strong class="jw hu">累计价格变量</strong>中，该变量根据该价格存在的时间进行加权。此变量表示整个合同历史中每一秒的Uniswap价格总和。</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff nc"><img src="../Images/69ba28a2ca4a94a041cce9de1d833c62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*luZyMS-ggdSNsPZn.png"/></div></div><figcaption class="lq lr fg fe ff ls lt bd b be z ek">Uniswap v2 Onchain Price Feeds</figcaption></figure><p id="3352" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">外部合同可以使用该变量来跟踪任何时间间隔内的准确时间加权平均价格(TWAPs)。</p><p id="db6d" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">这是通过在间隔开始和结束时从ERC20令牌对中读取累积价格来实现的。这个累计价格的差额可以除以时间间隔的长度，就可以得到这个时间段的TWAP。</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff nc"><img src="../Images/0444f9ed3dc001dff0d7eae2f24de34c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pLBMyUYwxjacrCWj.png"/></div></div><figcaption class="lq lr fg fe ff ls lt bd b be z ek">TWAPs using Uniswap V2</figcaption></figure><p id="95a0" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated"><strong class="jw hu"> TWAPs </strong>可以直接使用，也可以根据需要作为移动平均线(EMAs和SMAs)的基础。</p><p id="5fce" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">一些注意事项:</p><ul class=""><li id="0f25" class="mk ml ht jw b jx jy ka kb kd mm kh mn kl mo kp mp mq mr ms dt translated">对于10分钟TWAP，每10分钟取样一次。对于为期一周的TWAP，每周取样一次。</li><li id="bb57" class="mk ml ht jw b jx mt ka mu kd mv kh mw kl mx kp mp mq mr ms dt translated">对于简单的TWAP，操作成本增加(大约。线性)与Uniswap上的流动性，以及(大约。线性)与你平均的时间长度。</li><li id="c53b" class="mk ml ht jw b jx mt ka mu kd mv kh mw kl mx kp mp mq mr ms dt translated">估计一次攻击的成本相对简单。在1小时的TWAP上移动价格5%大约等于套利损失的金额和1小时内移动价格5%的费用。</li></ul><p id="bd0c" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">当使用Uniswap V2作为oracle时，有一些细微差别需要注意，特别是在涉及到操作阻力时。</p><h1 id="bf9e" class="kq kr ht bd ks kt ku kv kw kx ky kz la iz lb ja lc jc ld jd le jf lf jg lg lh dt translated">Uniswap V2定价</h1><p id="c4ac" class="pw-post-body-paragraph ju jv ht jw b jx li iu jz ka lj ix kc kd lk kf kg kh ll kj kk kl lm kn ko kp hm dt translated">我们来谈谈定价。本指南将关注两个最重要的Uniswap价格:中间价和执行价。</p><h1 id="ace9" class="kq kr ht bd ks kt ku kv kw kx ky kz la iz lb ja lc jc ld jd le jf lf jg lg lh dt translated">中等价格</h1><p id="68e6" class="pw-post-body-paragraph ju jv ht jw b jx li iu jz ka lj ix kc kd lk kf kg kh ll kj kk kl lm kn ko kp hm dt translated">在Uniswap的上下文中，中间价格是反映一个或多个对 中的<strong class="jw hu"> <em class="lo">储备比率的价格。我们有三种方式来考虑这个价格。</em></strong></p><ul class=""><li id="8dcd" class="mk ml ht jw b jx jy ka kb kd mm kh mn kl mo kp mp mq mr ms dt translated">它定义了一个令牌相对于另一个令牌的相对值。</li><li id="dc1d" class="mk ml ht jw b jx mt ka mu kd mv kh mw kl mx kp mp mq mr ms dt translated">它代表了理论上你可以用一种极少量的代币换另一种代币的价格。</li><li id="9b35" class="mk ml ht jw b jx mt ka mu kd mv kh mw kl mx kp mp mq mr ms dt translated">它可以解释为资产的当前<em class="lo">市场出清价格或公允价值价格</em>。</li></ul><p id="9a8c" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">让我们考虑DAI-WETH的中间价格(即每1 WETH的DAI数量)。</p><h2 id="ed5e" class="lu kr ht bd ks lv lw lx kw ly lz ma la kd mb mc lc kh md me le kl mf mg lg mh dt translated">直接<a class="ae ln" href="https://docs.uniswap.org/sdk/2.0.0/guides/pricing#direct" rel="noopener ugc nofollow" target="_blank"> </a></h2><p id="5196" class="pw-post-body-paragraph ju jv ht jw b jx li iu jz ka lj ix kc kd lk kf kg kh ll kj kk kl lm kn ko kp hm dt translated"><strong class="jw hu">获得戴韦中间价的最简单方法</strong>是直接观察这对<strong class="jw hu"/>:</p><pre class="jj jk jl jm fq nd nb ne nf aw ng dt"><span id="f24e" class="lu kr ht nb b fv nh ni l nj nk"><em class="lo">import</em> { ChainId, Token, WETH, Fetcher, Route } <em class="lo">from</em> '@uniswap/sdk'</span><span id="5126" class="lu kr ht nb b fv nl ni l nj nk"><em class="lo">const</em> DAI = <em class="lo">new</em> Token(ChainId.MAINNET, '0x6B175474E89094C44Da98b954EedeAC495271d0F', 18)</span><span id="87e7" class="lu kr ht nb b fv nl ni l nj nk"><em class="lo">// note that you may want/need to handle this async code differently,</em><br/><em class="lo">// for example if top-level await is not an option</em><br/><em class="lo">const</em> pair = <em class="lo">await</em> Fetcher.fetchPairData(DAI, WETH[DAI.chainId])</span><span id="d42c" class="lu kr ht nb b fv nl ni l nj nk"><em class="lo">const</em> route = <em class="lo">new</em> Route([pair], WETH[DAI.chainId])</span><span id="074f" class="lu kr ht nb b fv nl ni l nj nk">console.log(route.midPrice.toSignificant(6)) <em class="lo">// 201.306</em><br/>console.log(route.midPrice.invert().toSignificant(6)) <em class="lo">// 0.00496756</em></span></pre><p id="30e8" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">您可能想知道为什么我们必须构建一个<em class="lo">路径</em>来获得中间价格，而不是简单地从对中获得它(毕竟，它包括所有必要的数据)。原因很简单:一条路线迫使我们坚持交易的方向。路线由一对或多对以及一个输入令牌(它完全定义了一条交易路径)组成。在本例中，我们传递WETH作为输入令牌，这意味着我们对WETH - &gt; DAI交易感兴趣。</p><p id="a451" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">现在我们明白了，中间价将根据DAI/WETH来定义。不过不要担心，如果我们需要WETH/DAI价格，我们可以很容易地将其反转。</p><p id="60bb" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">最后，您可能已经注意到，我们将价格格式化为6位有效数字。这是因为在内部，价格存储为精确的分数，可以根据需要转换为其他表示形式。</p><h2 id="a324" class="lu kr ht bd ks lv lw lx kw ly lz ma la kd mb mc lc kh md me le kl mf mg lg mh dt translated">间接<a class="ae ln" href="https://docs.uniswap.org/sdk/2.0.0/guides/pricing#indirect" rel="noopener ugc nofollow" target="_blank"> </a></h2><p id="a0c6" class="pw-post-body-paragraph ju jv ht jw b jx li iu jz ka lj ix kc kd lk kf kg kh ll kj kk kl lm kn ko kp hm dt translated">为了举例，让我们设想在戴和WETH <em class="lo">之间不存在直接配对</em>。为了得到阿呆-韦瑟的中等价格，我们需要选择一个有效的路线。想象一下，戴和我们都与第三个令牌配对。在这种情况下，我们可以通过USDC对计算间接中间价:</p><pre class="jj jk jl jm fq nd nb ne nf aw ng dt"><span id="8257" class="lu kr ht nb b fv nh ni l nj nk"><em class="lo">import</em> { ChainId, Token, WETH, Fetcher, Route } <em class="lo">from</em> '@uniswap/sdk'</span><span id="e56c" class="lu kr ht nb b fv nl ni l nj nk"><em class="lo">const</em> USDC = <em class="lo">new</em> Token(ChainId.MAINNET, '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48', 6)<br/><em class="lo">const</em> DAI = <em class="lo">new</em> Token(ChainId.MAINNET, '0x6B175474E89094C44Da98b954EedeAC495271d0F', 18)</span><span id="a279" class="lu kr ht nb b fv nl ni l nj nk"><em class="lo">// note that you may want/need to handle this async code differently,</em><br/><em class="lo">// for example if top-level await is not an option</em><br/><em class="lo">const</em> USDCWETHPair = <em class="lo">await</em> Fetcher.fetchPairData(USDC, WETH[ChainId.MAINNET])<br/><em class="lo">const</em> DAIUSDCPair = <em class="lo">await</em> Fetcher.fetchPairData(DAI, USDC)</span><span id="505c" class="lu kr ht nb b fv nl ni l nj nk"><em class="lo">const</em> route = <em class="lo">new</em> Route([USDCWETHPair, DAIUSDCPair], WETH[ChainId.MAINNET])</span><span id="023f" class="lu kr ht nb b fv nl ni l nj nk">console.log(route.midPrice.toSignificant(6)) <em class="lo">// 202.081</em><br/>console.log(route.midPrice.invert().toSignificant(6)) <em class="lo">// 0.00494851</em></span></pre><h1 id="9f7d" class="kq kr ht bd ks kt ku kv kw kx ky kz la iz lb ja lc jc ld jd le jf lf jg lg lh dt translated">执行价格</h1><p id="928a" class="pw-post-body-paragraph ju jv ht jw b jx li iu jz ka lj ix kc kd lk kf kg kh ll kj kk kl lm kn ko kp hm dt translated">中间价是一条路线的<strong class="jw hu"> <em class="lo">当前状态</em>状态</strong>的绝佳代表，但是交易呢？事实证明，定义另一个价格，即交易的<strong class="jw hu"> <em class="lo">执行</em> </strong>价格，作为发送/接收资产的<strong class="jw hu">比率是有意义的。</strong></p><p id="65c7" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">假设，我们想用1 WETH换戴:</p><pre class="jj jk jl jm fq nd nb ne nf aw ng dt"><span id="f186" class="lu kr ht nb b fv nh ni l nj nk"><em class="lo">import</em> { ChainId, Token, WETH, Fetcher, Trade, Route, TokenAmount, TradeType } <em class="lo">from</em> '@uniswap/sdk'</span><span id="dbe7" class="lu kr ht nb b fv nl ni l nj nk"><em class="lo">const</em> DAI = <em class="lo">new</em> Token(ChainId.MAINNET, '0x6B175474E89094C44Da98b954EedeAC495271d0F', 18)</span><span id="bee1" class="lu kr ht nb b fv nl ni l nj nk"><em class="lo">// note that you may want/need to handle this async code differently,</em><br/><em class="lo">// for example if top-level await is not an option</em><br/><em class="lo">const</em> pair = <em class="lo">await</em> Fetcher.fetchPairData(DAI, WETH[DAI.chainId])</span><span id="bdb1" class="lu kr ht nb b fv nl ni l nj nk"><em class="lo">const</em> route = <em class="lo">new</em> Route([pair], WETH[DAI.chainId])</span><span id="91db" class="lu kr ht nb b fv nl ni l nj nk"><em class="lo">const</em> trade = <em class="lo">new</em> Trade(route, <em class="lo">new</em> TokenAmount(WETH[DAI.chainId], '1000000000000000000'), TradeType.EXACT_INPUT)</span><span id="38d6" class="lu kr ht nb b fv nl ni l nj nk">console.log(trade.executionPrice.toSignificant(6))<br/>console.log(trade.nextMidPrice.toSignificant(6))</span></pre><p id="3dbe" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">请注意，我们正在为尽可能多的DAI构建一个1 WETH的交易，<em class="lo">给定直接配对的当前储备</em>。执行价格代表该交易的平均DAI/WETH价格。当然，任何一对的储备可以改变每个区块，这将影响执行价格。</p><p id="0954" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">还要注意，如果交易在储备改变之前成功完成，我们可以访问下一个<em class="lo">中间价。</em></p><h1 id="fed3" class="kq kr ht bd ks kt ku kv kw kx ky kz la iz lb ja lc jc ld jd le jf lf jg lg lh dt translated">包裹</h1><p id="c502" class="pw-post-body-paragraph ju jv ht jw b jx li iu jz ka lj ix kc kd lk kf kg kh ll kj kk kl lm kn ko kp hm dt translated">本文阐述了对<strong class="jw hu"> Uniswap v2价格源</strong>的深刻理解。另外，请阅读我之前关于Uniswap v3概述的文章🔽</p><div class="nm nn fm fo no np"><a rel="noopener follow" target="_blank" href="/coinmonks/uniswap-v3-explained-57e0cdf86719"><div class="nq ab ej"><div class="nr ab ns cl cj nt"><h2 class="bd hu fv z el nu eo ep nv er et hs dt translated">Uniswap V3解释</h2><div class="nw l"><h3 class="bd b fv z el nu eo ep nv er et ek translated">关于Uniswap V3，您需要了解的所有信息</h3></div><div class="nx l"><p class="bd b gc z el nu eo ep nv er et ek translated">medium.com</p></div></div><div class="ny l"><div class="nz l oa ob oc ny od js np"/></div></div></a></div></div><div class="ab cl oe of hb og" role="separator"><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj"/></div><div class="hm hn ho hp hq"><h1 id="2200" class="kq kr ht bd ks kt ol kv kw kx om kz la iz on ja lc jc oo jd le jf op jg lg lh dt translated">与我保持联系！👋</h1><p id="ce02" class="pw-post-body-paragraph ju jv ht jw b jx li iu jz ka lj ix kc kd lk kf kg kh ll kj kk kl lm kn ko kp hm dt translated">默罕默德·沙赫扎德<br/>——<em class="lo"/><a class="oq or gr" href="https://medium.com/u/8721a6090e85?source=post_page-----dc0dc133347a--------------------------------" rel="noopener" target="_blank"><em class="lo">瑞思科技</em> </a>的技术副总裁</p><p id="4df5" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated"><strong class="jw hu">领英</strong>https://www.linkedin.com/in/ishanshahzad/<a class="ae ln" href="https://www.linkedin.com/in/ishanshahzad/" rel="noopener ugc nofollow" target="_blank">▶️</a></p><blockquote class="os"><p id="955d" class="ot ou ht bd ov ow ox oy oz pa pb kp ek translated">交易新手？尝试<a class="ae ln" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">加密交易机器人</a>或<a class="ae ln" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">复制交易</a></p></blockquote></div></div>    
</body>
</html>