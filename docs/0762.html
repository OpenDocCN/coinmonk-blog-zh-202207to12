<html>
<head>
<title>Threaded Pricing in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python中的线程定价</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/threaded-pricing-in-python-515697b6c5ae?source=collection_archive---------22-----------------------#2022-07-15">https://medium.com/coinmonks/threaded-pricing-in-python-515697b6c5ae?source=collection_archive---------22-----------------------#2022-07-15</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/d3bdfbcfae3fe546e9ef1b5fbdbc37a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jhI7PAygBOVGV--3j0basg.jpeg"/></div></div></figure><p id="2385" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">定价是Defi初学者会遇到的最棘手的功能之一。这是因为有很多地方可以得到价格，但是每个Dex会以不同的价格交换。价格数据的速度也非常重要，因为在一段时间内拥有尽可能多的价格将会产生更加详细的重采样结果。在这个例子中，我将把重点放在BSC上，因为RPC非常稳定，并且易于使用。</p><p id="27d7" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">理论:</strong></p><p id="a1b7" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">要了解Dex的价格，你首先要看看他们的<em class="jz">路由器</em>智能合约。在Pancakeswap(几乎所有路由器都是相同的btw)的情况下，我们将查看Read契约中的<strong class="jd hu"> getAmountsOut </strong>函数。</p><p id="afd9" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><a class="ae ka" href="https://bscscan.com/address/0x10ED43C718714eb63d5aA57B78B54704E256024E#readContract" rel="noopener ugc nofollow" target="_blank">合同地址0x 10 ed 43 c 718714 EB 63 D5 aa 57 b 78 b 54704 e 256024 e | BscScan</a></p><p id="fd82" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这将使我们能够根据特定的途径来确定置换的价格。地址路径的格式如下[“输入”、“输出”]。然后我们输入想要输出的输入量。这对于获得稳定硬币的当前价格很重要。即(amount in = 1)([" Price _ you _ Are _ Looking-4 "，" USDC契约"]) <br/>(记住很多路线不是1:1，直达。当交换时，检查你正在使用的Dex的最佳路线。)</p><p id="fcea" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">代码:</strong></p><p id="e959" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">为了在python中实现这一点，我们需要用web3包调用智能契约。我们还需要Dex的ABI调用(所有可用的功能)和智能合同地址。设置应该如下所示。</p><pre class="kb kc kd ke fq kf kg kh ki aw kj dt"><span id="7192" class="kk kl ht kg b fv km kn l ko kp">from Web3 import web3</span><span id="0a86" class="kk kl ht kg b fv kq kn l ko kp">#ABI<br/>panabi = 'To long to post, just pull this from BSC SCAN'</span><span id="f26c" class="kk kl ht kg b fv kq kn l ko kp">#Provider RPC<br/>provider_bsc = 'https://bsc-dataseed.binance.org/'</span><span id="2e60" class="kk kl ht kg b fv kq kn l ko kp">#Router Contract<br/>router_pcsv2 = '0x10ED43C718714eb63d5aA57B78B54704E256024E'</span><span id="27ea" class="kk kl ht kg b fv kq kn l ko kp">#By default trades from BUSD - CHEAPER<br/>base_coin= '0xe9e7cea3dedca5984780bafc599bd69add087d56'<br/>base_coin = Web3.toChecksumAddress(base_coin)<br/>InputToken_address = "INPUT_TOKEN_SMART_CONTRACT_HERE"<br/>InputToken_address = Web3.toChecksumAddress(InputToken_address)</span><span id="8e89" class="kk kl ht kg b fv kq kn l ko kp">#setup Web3 connector<br/>web3 = Web3(Web3.HTTPProvider(provider_bsc))</span><span id="3195" class="kk kl ht kg b fv kq kn l ko kp">#Setup the PancakeSwap contract<br/>contract = web3.eth.contract(address=router_pcsv2, abi=panabi)</span><span id="1932" class="kk kl ht kg b fv kq kn l ko kp">#pricing Function<br/>def get_price():<br/>   #Current Price<br/>   current_price = (contract.functions.getAmountsOut(1,[InputToken_address,base_coin]).call())[1]</span><span id="4cb8" class="kk kl ht kg b fv kq kn l ko kp">   #float out price from Gwei, will be human reable, easier to set trade price<br/>   current_price = float(web3.fromWei(current_price,'gwei'))<br/>   print(current_price)</span></pre><p id="105b" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">上面的代码会让你得到你的乐器的当前价格，但那只是在这个确切的时刻。在一个单独的线程中持续拉动价格才是正确的做法。</p><p id="b64c" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">为此，导入线程模块，然后使用以下语法调用get_price()函数。</p><pre class="kb kc kd ke fq kf kg kh ki aw kj dt"><span id="af63" class="kk kl ht kg b fv km kn l ko kp">import threading</span><span id="4421" class="kk kl ht kg b fv kq kn l ko kp">if __name__ == "__main__":<br/>   print(threading.active_count())<br/>   print(threading.enumerate())</span><span id="334d" class="kk kl ht kg b fv kq kn l ko kp">   #Start Price Data Thread<br/>   getPrice_thread = threading.Thread(target=get_price,)<br/>   getPrice_thread.daemon = True<br/>   getPrice_thread.start()</span></pre><p id="9c25" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">这个实现非常简单，只是为了展示如何在另一个线程中获取价格，以便在重采样或其他操作中保持价格不变。</p><p id="d4c3" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">(提示:如果您计划对时间帧进行重新采样，请在您的主线程中设置一个休眠，直到您构建了足够的蜡烛线来处理采样数据上的操作。使用单独的线程进行重采样。)</p><p id="acd1" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated"><strong class="jd hu">改进思路:</strong></p><ul class=""><li id="b064" class="kr ks ht jd b je jf ji jj jm kt jq ku ju kv jy kw kx ky kz dt translated">添加日志记录</li><li id="ddbe" class="kr ks ht jd b je la ji lb jm lc jq ld ju le jy kw kx ky kz dt translated">将价格保存到数据帧，并为OHLC值重新取样</li><li id="3cd2" class="kr ks ht jd b je la ji lb jm lc jq ld ju le jy kw kx ky kz dt translated">根据特定价格或指标触发买入/卖出</li></ul><p id="7528" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hm dt translated">祝你在兔子洞里玩得愉快！</p><blockquote class="lf"><p id="9b4e" class="lg lh ht bd li lj lk ll lm ln lo jy ek translated">交易新手？尝试<a class="ae ka" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">加密交易机器人</a>或<a class="ae ka" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">复制交易</a></p></blockquote></div></div>    
</body>
</html>