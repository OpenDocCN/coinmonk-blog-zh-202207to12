<html>
<head>
<title>Saddle Finance, April 2022, Hack Analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">马鞍财经，2022年4月，黑客分析</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/saddle-finance-was-unable-to-protect-users-from-the-arbitrageurs-8087e8ea11a6?source=collection_archive---------23-----------------------#2022-12-05">https://medium.com/coinmonks/saddle-finance-was-unable-to-protect-users-from-the-arbitrageurs-8087e8ea11a6?source=collection_archive---------23-----------------------#2022-12-05</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="72ad" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">实时代码经常包含缺陷，这些缺陷可以被利用来在不强行操作任何东西的情况下获取金钱</h2></div><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div class="fe ff ji"><img src="../Images/7e25d5d0c9695a202d8216778f171092.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/1*i4fKWMBNCz55lzTH8993dQ.png"/></div></figure><p id="b58f" class="pw-post-body-paragraph jq jr ht js b jt ju iu jv jw jx ix jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">黑客最终会发现一个弱点，因为软件经常漏洞百出。尤其是如果你自己开发了这个平台，你不会很快发现错误。谢天谢地，不是每个黑客都是邪恶的。例如，与“黑帽黑客”相比，“白帽黑客”被企业雇佣来故意破坏平台因此，企业可以更好地保护他们的产品。</p><p id="d16b" class="pw-post-body-paragraph jq jr ht js b jt ju iu jv jw jx ix jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">2022年4月30日，一系列利用激活的智能合约的交易使以太坊上的自动化做市商(AMM)马鞍金融(Saddle Finance)受害。</p><p id="a812" class="pw-post-body-paragraph jq jr ht js b jt ju iu jv jw jx ix jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">通过元池中一系列flash loan辅助的sUSD/saddleUSD-V2互换，黑客能够操纵LP令牌的价格，然后可以将其交换为进一步的sUSD。</p><p id="f0f1" class="pw-post-body-paragraph jq jr ht js b jt ju iu jv jw jx ix jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">在三次攻击交易中，大约1100万美元的加密货币被没收。白帽攻击，这三个中的一个，节省了这个数量的大约25%不被黑帽夺取。该漏洞基于之前报告的一个尚未完全解决的问题。</p><h2 id="05c8" class="km kn ht bd ko kp kq kr ks kt ku kv kw jz kx ky kz kd la lb lc kh ld le lf lg dt translated">背景</h2><p id="5042" class="pw-post-body-paragraph jq jr ht js b jt lh iu jv jw li ix jy jz lj kb kc kd lk kf kg kh ll kj kk kl hm dt translated">专注于固定价值加密资产，如包装BTC和stablecoins，Saddle是以太坊区块链的一家分散式自动化做市商。</p><p id="e351" class="pw-post-body-paragraph jq jr ht js b jt ju iu jv jw jx ix jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">绝大多数流动性池的设计初衷都不是为了创造挂钩资产，比如打包BTC。他们使用常数乘积模型来处理更不稳定的令牌对。使用为波动性更大的资产设计的资金池会导致wBTC交易员和流动性提供者面临更多的滑点和不必要的、非永久性的损失。为了解决这个问题，Saddle Finance为打包的BTC交易员和流动性提供者创建了一个引人注目的AMM指数。</p><p id="a440" class="pw-post-body-paragraph jq jr ht js b jt ju iu jv jw jx ix jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">重要的是，Saddle的代码使用了Curve的许多关键思想和原则，尽管其中许多已经被修改以适应Saddle的需求。</p><p id="b2db" class="pw-post-body-paragraph jq jr ht js b jt ju iu jv jw jx ix jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">标准和元交换池是Curve作为AMM的两个独立功能。标准池的功能类似于典型的AMM池，只接受也可以通过该池作为流动性进行交易的代币。《curve》中的三曲池是最受欢迎的池之一，戴、、可以在这里对调。</p><h2 id="ce13" class="km kn ht bd ko kp kq kr ks kt ku kv kw jz kx ky kz kd la lb lc kh ld le lf lg dt translated">根本原因</h2><p id="35aa" class="pw-post-body-paragraph jq jr ht js b jt lh iu jv jw li ix jy jz lj kb kc kd lk kf kg kh ll kj kk kl hm dt translated">我们将讨论此交易中针对sUSD —萨德尔戴/USDC/USDT元池的攻击的根本原因。</p><p id="36d6" class="pw-post-body-paragraph jq jr ht js b jt ju iu jv jw jx ix jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">资金来自协议的sUSDv2元库，该元库将saddleUSD-V2 LP令牌(来自戴、USDC和USDT库)与Synthetix的sUSD配对。</p><p id="572c" class="pw-post-body-paragraph jq jr ht js b jt ju iu jv jw jx ix jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">如前所述，Saddle Finance将Curve的元素集成到其协议中。Saddle Finance团队没有派生最初的Vyper代码，而是在Solidity中重新实现了Curve的元池。在此过程中引入了错误！</p><p id="5192" class="pw-post-body-paragraph jq jr ht js b jt ju iu jv jw jx ix jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">MetaSwapUtils库的旧版本有一个缺陷，使其无法在元池交换期间使用VirturalPrice来确定LP标记的值，从而使黑客攻击变得可行。</p><p id="0736" class="pw-post-body-paragraph jq jr ht js b jt ju iu jv jw jx ix jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">资产池内资产定价的不一致是不准确的主要原因。特别是，元池中的LP令牌在与池的基础价值相比时被错误定价。因此，一美元的令牌可以检索到或多或少的LP令牌。</p><p id="7082" class="pw-post-body-paragraph jq jr ht js b jt ju iu jv jw jx ix jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">缺乏基于LP代币的虚拟基础价格来确定所提供代币的价值的数学是导致这种错误定价的原因。随着费用的收取，LP令牌的价值会随着时间的推移而增加。</p><p id="f07f" class="pw-post-body-paragraph jq jr ht js b jt ju iu jv jw jx ix jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">然而，交换函数不适当地考虑了虚拟价格。有趣的是，合约的数学对于涉及基础代币的存款、取款和互换是准确的；仅当令牌交换为LP令牌时，问题才会出现。</p><p id="cb02" class="pw-post-body-paragraph jq jr ht js b jt ju iu jv jw jx ix jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">价格问题是在名为MetaSwapUtils的库中发现的，该库用于计算互换、存款和取款。第<a class="ae lm" href="https://github.com/saddle-finance/saddle-contract/blob/141a00e7ba0c5e8d51d8018d3c4a170e63c6c7c4/contracts/meta/MetaSwapUtils.sol#L424" rel="noopener ugc nofollow" target="_blank"> 424行</a>的计算中没有计算LP令牌的基本虚拟价格，这与第<a class="ae lm" href="https://github.com/saddle-finance/saddle-contract/blob/141a00e7ba0c5e8d51d8018d3c4a170e63c6c7c4/contracts/meta/MetaSwapUtils.sol#L277" rel="noopener ugc nofollow" target="_blank"> 277行</a>的计算相矛盾，在第<a class="ae lm" href="https://github.com/saddle-finance/saddle-contract/blob/141a00e7ba0c5e8d51d8018d3c4a170e63c6c7c4/contracts/meta/MetaSwapUtils.sol#L277" rel="noopener ugc nofollow" target="_blank">277行适当地执行了该计算检查。</a></p><p id="12f9" class="pw-post-body-paragraph jq jr ht js b jt ju iu jv jw jx ix jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">易受攻击的MetaSwapUtils的一部分:</p><p id="a464" class="pw-post-body-paragraph jq jr ht js b jt ju iu jv jw jx ix jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated"><code class="eh ln lo lp lq b">dy = xp[tokenIndexTo].sub(y).sub(1);<br/>dyFee = dy.mul(self.swapFee).div(FEE_DENOMINATOR);<br/>dy = dy.sub(dyFee).div(self.tokenPrecisionMultipliers[tokenIndexTo]);</code></p><p id="b2d8" class="pw-post-body-paragraph jq jr ht js b jt ju iu jv jw jx ix jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">在早期的鞍叉漏洞中，如Nerve和Synapse，攻击者利用这种定价异常来窃取资金。然而，Saddle从未直接遭受这一缺陷，因为它反应迅速，并在切换到可能已修复的MetaSwapUtils之前停止了元池交换。</p><p id="9ce7" class="pw-post-body-paragraph jq jr ht js b jt ju iu jv jw jx ix jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">缺失的LP虚拟价格调整现在出现在固定库中。这些改动来自打补丁文件的第<a class="ae lm" href="https://github.com/saddle-finance/saddle-contract/blob/7b7060e45be2ec3c9bcdf16240acf13394204571/contracts/meta/MetaSwapUtils.sol#L447-L451" rel="noopener ugc nofollow" target="_blank">447–451</a>行。我们可以在下面的代码摘录中看到弥补漏洞的扩展。</p><p id="6f2e" class="pw-post-body-paragraph jq jr ht js b jt ju iu jv jw jx ix jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated"><code class="eh ln lo lp lq b">dy = xp[tokenIndexTo].sub(y).sub(1); if (tokenIndexTo == baseLPTokenIndex) { // When swapping to a base Swap token, scale down dy by its virtual price dy = dy.mul(BASE_VIRTUAL_PRICE_PRECISION).div(baseVirtualPrice);} dyFee = dy.mul(self.swapFee).div(FEE_DENOMINATOR);dy = dy.sub(dyFee); dy = dy.div(self.tokenPrecisionMultipliers[tokenIndexTo]);</code></p><p id="7086" class="pw-post-body-paragraph jq jr ht js b jt ju iu jv jw jx ix jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">尽管进行了这种迁移，但活池似乎仍在使用以前代码中有缺陷的交换计算。如被滥用的苏塞德-萨德尔戴/USDC/USDT梅塔池。</p><p id="fc12" class="pw-post-body-paragraph jq jr ht js b jt ju iu jv jw jx ix jy jz ka kb kc kd ke kf kg kh ki kj kk kl hm dt translated">此攻击中使用的攻击媒介可能存在于我们正在处理的代码中，因此作为smart contract安全研究人员，我们需要了解过去或已知的针对代码库或类似代码的攻击。</p><blockquote class="lr"><p id="f7d0" class="ls lt ht bd lu lv lw lx ly lz ma kl ek translated">交易新手？试试<a class="ae lm" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">加密交易机器人</a>或者<a class="ae lm" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">复制交易</a></p></blockquote></div></div>    
</body>
</html>