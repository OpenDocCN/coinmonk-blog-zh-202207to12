<html>
<head>
<title>Ethernaut Level 9 King [Foundry-Hardhat]</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">以太9级王者[铸造-安全帽]</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/ethernaut-level-9-king-foundry-hardhat-528cea17a8b1?source=collection_archive---------23-----------------------#2022-12-28">https://medium.com/coinmonks/ethernaut-level-9-king-foundry-hardhat-528cea17a8b1?source=collection_archive---------23-----------------------#2022-12-28</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/bd7dc8dbf1d22ff5ab8633386af63a30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DVTe3GDeSjNUMpZzOKvaLw.png"/></div></div></figure><blockquote class="jb"><p id="8008" class="jc jd ht bd je jf jg jh ji jj jk jl ek translated"><a class="ae jm" href="https://github.com/Chirag21/Ethernaut-solutions" rel="noopener ugc nofollow" target="_blank"> Ethernaut-Solutions </a>库包含使用Foundry和Hardhat的解决方案。</p></blockquote><h1 id="0e09" class="jn jo ht bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk dt translated">目标</h1><ul class=""><li id="5e0c" class="kl km ht kn b ko kp kq kr ks kt ku kv kw kx jl ky kz la lb dt translated">谁给合同送去的乙醚量大于当前的奖金，谁就成为新国王。声称拥有该契约的所有权。当你把实例提交回关卡时，关卡会收回王权。如果你能避免这样的自我宣告，你就会超越这个水平。</li></ul></div><div class="ab cl lg lh hb li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hm hn ho hp hq"><h1 id="97ef" class="jn jo ht bd jp jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk dt translated">分析</h1><p id="a7e8" class="pw-post-body-paragraph ls lt ht kn b ko kp lu lv kq kr lw lx ks ly lz ma ku mb mc md kw me mf mg jl hm dt translated">在<a class="ae jm" rel="noopener" href="/coinsbench/ethernaut-level-1-fallback-analysis-and-solution-bd7d4eea343f">一级</a>中，我们讨论了<code class="eh lc ld le lf b">fallback()</code>和<code class="eh lc ld le lf b">receive()</code>功能。每次我们发送以太到另一个契约，事务的成功依赖于那个契约。如果合同没有<code class="eh lc ld le lf b">receive()</code>功能或<code class="eh lc ld le lf b">payable fallback()</code>功能，则交易被恢复。</p><blockquote class="jb"><p id="e1d7" class="jc jd ht bd je jf mh mi mj mk ml jl ek translated">不知道什么时候买卖cryp，试试<a class="ae jm" href="http://coincodecap.com/go/bityard" rel="noopener ugc nofollow" target="_blank">复制交易</a>。</p></blockquote><p id="2313" class="pw-post-body-paragraph ls lt ht kn b ko mm lu lv kq mn lw lx ks mo lz ma ku mp mc md kw mq mf mg jl hm dt translated">看看王者契约的接收功能，</p><pre class="mr ms mt mu fq mv lf mw bn mx my bi"><span id="3e7b" class="mz jo ht lf b be na nb l nc nd">receive() external payable {<br/>  require(msg.value &gt;= prize || msg.sender == owner);<br/>  payable(king).transfer(msg.value);<br/>  king = msg.sender;<br/>  prize = msg.value;<br/>}</span></pre><p id="db8b" class="pw-post-body-paragraph ls lt ht kn b ko ne lu lv kq nf lw lx ks ng lz ma ku nh mc md kw ni mf mg jl hm dt translated">业主可以发送任何数量的乙醚合同，并声称王权。不错的庞氏骗局。😎</p><p id="27f0" class="pw-post-body-paragraph ls lt ht kn b ko ne lu lv kq nf lw lx ks ng lz ma ku nh mc md kw ni mf mg jl hm dt translated">我们可以通过发送大于<code class="eh lc ld le lf b">prize</code>的金额来主张王权。奖品设置为<code class="eh lc ld le lf b">0.001 ether</code>或<code class="eh lc ld le lf b">1000000 gwei</code>。</p><p id="f844" class="pw-post-body-paragraph ls lt ht kn b ko ne lu lv kq nf lw lx ks ng lz ma ku nh mc md kw ni mf mg jl hm dt translated">该功能将发送的数量传送给前一个国王，并将<code class="eh lc ld le lf b">msg.sender</code>替换为新国王，并将<code class="eh lc ld le lf b">prize</code>设置为<code class="eh lc ld le lf b">msg.value</code>。当我们提交实例时，关卡会通过触发王者契约的<code class="eh lc ld le lf b">receive()</code>功能来尝试夺回王权。我们必须确保这笔交易会失败。我们将创建一个充当中介的契约，并将以太从<code class="eh lc ld le lf b">msg.sender</code>转发到国王契约。我们不会实现任何<code class="eh lc ld le lf b">fallback()</code>或<code class="eh lc ld le lf b">receive()</code>方法，因此我们的契约将无法接收任何以太。交易将恢复。</p><ol class=""><li id="562c" class="kl km ht kn b ko ne kq nf ks nj ku nk kw nl jl nm kz la lb dt translated">发送<code class="eh lc ld le lf b">0.001 ether</code>即<code class="eh lc ld le lf b">1000000 gwei</code>到我们的合同，我们的合同会将以太转发到国王合同。这会触发王者契约中的<code class="eh lc ld le lf b">receive()</code>功能。由此，中介合同将被设定为新的王。</li><li id="2e10" class="kl km ht kn b ko nn kq no ks np ku nq kw nr jl nm kz la lb dt translated">当你提交实例时，关卡会通过发送一些以太来试图收回王权。</li><li id="e22a" class="kl km ht kn b ko nn kq no ks np ku nq kw nr jl nm kz la lb dt translated">该功能将尝试发送金额给上一个国王，这是我们的恶意合同，但交易将失败，因为在我们的合同中没有办法接收以太转移，该级别将无法成为新的国王。</li></ol></div><div class="ab cl lg lh hb li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hm hn ho hp hq"><h1 id="439a" class="jn jo ht bd jp jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk dt translated">剥削</h1><p id="0be7" class="pw-post-body-paragraph ls lt ht kn b ko kp lu lv kq kr lw lx ks ly lz ma ku mb mc md kw me mf mg jl hm dt translated">让我们创建一个合同，将声称王权。</p><p id="b053" class="pw-post-body-paragraph ls lt ht kn b ko ne lu lv kq nf lw lx ks ng lz ma ku nh mc md kw ni mf mg jl hm dt translated">转到<a class="ae jm" href="https://remix.ethereum.org/#optimize=false&amp;runs=200&amp;evmVersion=null&amp;version=soljson-v0.8.17+commit.8df45f5f.js" rel="noopener ugc nofollow" target="_blank"> <strong class="kn hu">混音IDE </strong> </a> <strong class="kn hu">。</strong>创建并部署以下合同。</p><figure class="mr ms mt mu fq iu"><div class="bz el l di"><div class="ns nt l"/></div></figure><ul class=""><li id="54f7" class="kl km ht kn b ko ne kq nf ks nj ku nk kw nl jl ky kz la lb dt translated">通过在开发控制台的level页面上键入<code class="eh lc ld le lf b">instance</code>来获取实例地址。</li><li id="5f4b" class="kl km ht kn b ko nn kq no ks np ku nq kw nr jl ky kz la lb dt translated">调用<code class="eh lc ld le lf b">hack()</code>函数，将实例地址作为参数传递。在值字段发送<code class="eh lc ld le lf b">0.001 ether</code>，即<code class="eh lc ld le lf b">1000000 gwei</code>。</li></ul><figure class="mr ms mt mu fq iu fe ff paragraph-image"><div class="fe ff nu"><img src="../Images/db1e90b8777f564d88a42e3458eb7c2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:614/format:webp/1*Nf1K0FUuVRQ0I8_qgNsiNg.png"/></div></figure><p id="7e86" class="pw-post-body-paragraph ls lt ht kn b ko ne lu lv kq nf lw lx ks ng lz ma ku nh mc md kw ni mf mg jl hm dt translated">这样可以防止关卡收回王权。</p><p id="33bf" class="pw-post-body-paragraph ls lt ht kn b ko ne lu lv kq nf lw lx ks ng lz ma ku nh mc md kw ni mf mg jl hm dt translated">提交实例。</p><p id="e9e3" class="pw-post-body-paragraph ls lt ht kn b ko ne lu lv kq nf lw lx ks ng lz ma ku nh mc md kw ni mf mg jl hm dt translated">关卡通过！！！😄</p></div><div class="ab cl lg lh hb li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hm hn ho hp hq"><h1 id="eb00" class="jn jo ht bd jp jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk dt translated">关键要点</h1><ul class=""><li id="df93" class="kl km ht kn b ko kp kq kr ks kt ku kv kw kx jl ky kz la lb dt translated">始终确保处理失败的事务。</li><li id="9b10" class="kl km ht kn b ko nn kq no ks np ku nq kw nr jl ky kz la lb dt translated">如果你使用像<code class="eh lc ld le lf b">call()</code>、<code class="eh lc ld le lf b">delegatecall()</code>、<code class="eh lc ld le lf b">staticcall()</code>这样的函数，一定要检查返回值。如果事务失败，这些函数不会抛出异常，而是返回<code class="eh lc ld le lf b">false</code>。</li></ul></div><div class="ab cl lg lh hb li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hm hn ho hp hq"><blockquote class="jb"><p id="5c9c" class="jc jd ht bd je jf mh mi mj mk ml jl ek translated"><a class="ae jm" href="https://github.com/Chirag21/Ethernaut-solutions" rel="noopener ugc nofollow" target="_blank"> Ethernaut-Solutions </a>库包含使用Foundry和Hardhat的解决方案。</p><p id="61f7" class="jc jd ht bd je jf mh mi mj mk ml jl ek translated">使用铸造的解决方案:-</p><p id="5304" class="jc jd ht bd je jf mh mi mj mk ml jl ek translated"><a class="ae jm" href="https://github.com/Chirag21/Ethernaut-Solutions-using-Foundry-Hardhat/blob/main/test/foundry/9_King.t.sol" rel="noopener ugc nofollow" target="_blank">测试</a>，<a class="ae jm" href="https://github.com/Chirag21/Ethernaut-Solutions-using-Foundry-Hardhat/blob/main/script/9_KingScript.sol" rel="noopener ugc nofollow" target="_blank">漏洞利用脚本</a></p><p id="c94c" class="jc jd ht bd je jf mh mi mj mk ml jl ek translated">使用安全帽的解决方案:-</p><p id="a078" class="jc jd ht bd je jf mh mi mj mk ml jl ek translated"><a class="ae jm" href="https://github.com/Chirag21/Ethernaut-Solutions-using-Foundry-Hardhat/blob/main/test/hardhat/9_king.test.ts" rel="noopener ugc nofollow" target="_blank">测试</a>，<a class="ae jm" href="https://github.com/Chirag21/Ethernaut-Solutions-using-Foundry-Hardhat/blob/main/scripts/9_king_exploit.ts" rel="noopener ugc nofollow" target="_blank">漏洞利用脚本</a></p></blockquote><figure class="nw nx ny nz oa iu fe ff paragraph-image"><a href="https://www.buymeacoffee.com/0xcsp"><div class="fe ff nv"><img src="../Images/679392ad412abc67dd16f3b9fefa799d.png" data-original-src="https://miro.medium.com/v2/resize:fit:420/format:webp/1*769MixcK_s6-z4fwRrIpMQ.png"/></div></a></figure><h1 id="e048" class="jn jo ht bd jp jq jr js jt ju jv jw jx jy ob ka kb kc oc ke kf kg od ki kj kk dt translated">更多级别</h1><div class="oe of fm fo og oh"><a rel="noopener follow" target="_blank" href="/coinmonks/ethernaut-level-10-reentrancy-foundry-hardhat-ce9291eadf04"><div class="oi ab ej"><div class="oj ab ok cl cj ol"><h2 class="bd hu fv z el om eo ep on er et hs dt translated">以太10级——可重入[铸造厂-安全帽]</h2><div class="oo l"><h3 class="bd b fv z el om eo ep on er et ek translated">Ethernaut-Solutions存储库包含使用Foundry和Hardhat的解决方案。</h3></div><div class="op l"><p class="bd b gc z el om eo ep on er et ek translated">medium.com</p></div></div><div class="oq l"><div class="or l os ot ou oq ov iz oh"/></div></div></a></div><div class="oe of fm fo og oh"><a rel="noopener follow" target="_blank" href="/coinmonks/ethernaut-level-8-vault-foundry-hardhat-ed135ba10978"><div class="oi ab ej"><div class="oj ab ok cl cj ol"><h2 class="bd hu fv z el om eo ep on er et hs dt translated">以太8级金库[铸造厂-安全帽]</h2><div class="oo l"><h3 class="bd b fv z el om eo ep on er et ek translated">Ethernaut-Solutions存储库包含使用Foundry和Hardhat的解决方案。</h3></div><div class="op l"><p class="bd b gc z el om eo ep on er et ek translated">medium.com</p></div></div><div class="oq l"><div class="ow l os ot ou oq ov iz oh"/></div></div></a></div><blockquote class="jb"><p id="d711" class="jc jd ht bd je jf jg jh ji jj jk jl ek translated">加入Coinmonks <a class="ae jm" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae jm" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h1 id="cdac" class="jn jo ht bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk dt translated">另外，阅读</h1><ul class=""><li id="e17b" class="kl km ht kn b ko kp kq kr ks kt ku kv kw kx jl ky kz la lb dt translated"><a class="ae jm" href="https://coincodecap.com/huobi-crypto-trading-signals" rel="noopener ugc nofollow" target="_blank">用于Huobi的加密交易信号</a> | <a class="ae jm" rel="noopener" href="/coinmonks/hitbtc-review-c5143c5d53c2"> HitBTC审核</a></li><li id="7e11" class="kl km ht kn b ko nn kq no ks np ku nq kw nr jl ky kz la lb dt translated"><a class="ae jm" href="https://coincodecap.com/traderwagon-review" rel="noopener ugc nofollow" target="_blank"> TraderWagon回顾</a> | <a class="ae jm" href="https://coincodecap.com/kraken-vs-gemini-vs-bityard" rel="noopener ugc nofollow" target="_blank">北海巨妖vs双子星vs BitYard </a></li><li id="9b35" class="kl km ht kn b ko nn kq no ks np ku nq kw nr jl ky kz la lb dt translated"><a class="ae jm" href="https://coincodecap.com/ftx-futures-trading" rel="noopener ugc nofollow" target="_blank">如何在FTX交易所交易期货</a></li><li id="d1d1" class="kl km ht kn b ko nn kq no ks np ku nq kw nr jl ky kz la lb dt translated"><a class="ae jm" href="https://coincodecap.com/okex-kucoin" rel="noopener ugc nofollow" target="_blank"> OKEx vs KuCoin </a> | <a class="ae jm" href="https://coincodecap.com/celsius-alternatives" rel="noopener ugc nofollow" target="_blank">摄氏替代品</a> | <a class="ae jm" href="https://coincodecap.com/buy-vechain" rel="noopener ugc nofollow" target="_blank">如何购买VeChain </a></li></ul></div></div>    
</body>
</html>